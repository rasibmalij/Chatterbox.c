<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Gaming Tournament</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- Dark Theme Variables --- */
        :root {
            --primary-bg: #0F172A; /* Slate 900 */
            --secondary-bg: #1E293B; /* Slate 800 */
            --card-bg: #1E293B; /* Slate 800 */
            --sidebar-bg: #111827; /* Gray 900 */
            --text-primary: #E2E8F0; /* Slate 200 */
            --text-secondary: #94A3B8; /* Slate 400 */
            --text-muted-custom: #64748B; /* Slate 500 - Improved visibility for muted text */
            --accent-color: #FACC15; /* Yellow 500 */
            --accent-gradient: linear-gradient(to right, #FACC15, #FBBF24);
            --primary-button-bg: #3B82F6; /* Blue 500 */
            --border-color: #334155; /* Slate 700 */
            --success-color: #10B981; /* Emerald 500 */
            --danger-color: #EF4444; /* Red 500 */
            --warning-color: #F59E0B; /* Amber 500 */
            --info-color: #60A5FA; /* Blue 400 */
            --link-color: #9CA3AF; /* Gray 400 */
            --link-hover-color: #E5E7EB; /* Gray 200 */
            --placeholder-bg: rgba(100, 116, 139, 0.15); /* Slate 500 with opacity */
        }
        body { background-color: var(--primary-bg); color: var(--text-primary); font-family: 'Poppins', sans-serif; padding-top: 60px; }
        .app-header { position: fixed; top: 0; left: 0; width: 100%; height: 60px; background-color: var(--secondary-bg); display: flex; align-items: center; justify-content: space-between; padding: 0 15px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); z-index: 1030; border-bottom: 1px solid var(--border-color);}
        .header-left { display: flex; align-items: center; gap: 10px; min-width: 0; }
        .menu-toggle-btn { background: none; border: none; color: var(--text-primary); font-size: 1.5rem; padding: 0 5px; margin-left: -5px;}
        .header-logo { width: 35px; height: 35px; border-radius: 50%; background-color: #fff; object-fit: cover; border: 1px solid var(--accent-color);}
        .header-title { font-size: 1rem; font-weight: 600; line-height: 1.2; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .header-right { display: flex; align-items: center; gap: 15px; flex-shrink: 0; }
        .admin-email-header { font-size: 0.8rem; color: var(--text-secondary); display: none; }
        @media (min-width: 576px) { .admin-email-header { display: inline; } }
        
        /* --- New Sidebar Styles --- */
        .new-sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 260px;
            height: 100vh;
            background-color: var(--sidebar-bg);
            color: var(--link-color);
            border-right: 1px solid var(--border-color);
            z-index: 1045;
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
            display: flex;
            flex-direction: column;
        }

        .new-sidebar.is-open {
            transform: translateX(0);
        }

        .new-sidebar .offcanvas-header {
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 1.2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .new-sidebar .offcanvas-title h5 {
            color: var(--text-primary);
            margin-bottom: 0;
            font-size: 1.1rem;
        }

        .new-sidebar .btn-close-white {
            filter: invert(1) grayscale(100%) brightness(200%);
        }

        .new-sidebar .offcanvas-body {
            padding: 1rem;
            flex-grow: 1;
            overflow-y: auto; /* VERTICAL SCROLLING */
        }

        .new-sidebar .nav-link {
            color: var(--link-color);
            padding: 0.9rem 1.2rem;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            margin-bottom: 8px; /* Space between buttons */
            border-radius: 6px;
            transition: all 0.2s ease-in-out;
            border: 1px solid var(--border-color); /* VISIBLE BORDER */
        }

        .new-sidebar .nav-link:hover {
            color: var(--link-hover-color);
            background-color: rgba(255, 255, 255, 0.05);
            border-color: var(--accent-color);
        }

        /* ACTIVE LINK ANIMATION */
        .new-sidebar .nav-link.active {
            color: var(--link-hover-color);
            background-color: rgba(250, 204, 21, 0.1);
            border-color: var(--accent-color);
            font-weight: 600;
            transform: translateX(5px) scale(1.02);
            box-shadow: 0 0 10px rgba(250, 204, 21, 0.2);
        }

        .new-sidebar .nav-link i,
        .new-sidebar .nav-link .sidebar-icon {
            margin-right: 12px;
            width: 20px;
            text-align: center;
            font-size: 1.1rem;
        }


        .main-content { padding: 20px; }
        .section { display: none; animation: fadeIn 0.5s; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to: { opacity: 1; transform: translateY(0); } }
        .section-title { font-size: 1.25rem; font-weight: 600; margin-bottom: 20px; }

        /* ========= NEW LOGIN & SIGNUP STYLES START ========= */
.auth-wrapper {
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: calc(100vh - 60px);
    padding: 2rem 1rem;
}
.auth-container {
    max-width: 420px;
    width: 100%;
    background-color: var(--secondary-bg);
    padding: 2.5rem;
    border-radius: 12px;
    border: 1px solid var(--border-color);
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    animation: fadeIn 0.6s ease-out;
}
.auth-header {
    text-align: center;
    margin-bottom: 2.5rem;
}
.auth-title {
    font-size: 1.75rem;
    font-weight: 600;
    color: var(--text-primary);
}
.auth-subtitle {
    font-size: 0.95rem;
    color: var(--text-secondary);
}
.auth-form .form-label {
    font-weight: 500;
    color: var(--text-secondary);
    margin-bottom: 0.5rem;
}
.auth-form .input-group {
    border-radius: 8px;
    border: 1px solid var(--border-color);
    background-color: var(--primary-bg);
    display: flex;
    align-items: center;
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
}
.auth-form .input-group > .form-control,
.auth-form .input-group > .input-group-text {
    border: none;
    background-color: transparent;
}
.auth-form .input-group > .form-control {
    color: var(--text-primary);
    padding: 0.8rem 1rem 0.8rem 0.25rem;
    height: auto;
    box-shadow: none;
    flex: 1;
}
.auth-form .input-group:focus-within {
    border-color: var(--accent-color);
    box-shadow: 0 0 0 0.2rem rgba(250, 204, 21, 0.25);
}
.auth-form .input-group > .form-control::placeholder {
    color: var(--text-secondary);
    opacity: 0.7;
}
.auth-form .input-group-text {
    padding: 0 0.6rem;
}
.auth-form .input-group-text:last-child {
    cursor: pointer;
}
.auth-form .input-group-text i {
    color: var(--text-secondary);
    transition: color 0.2s ease;
}
.auth-form .input-group-text:hover i {
    color: var(--text-primary);
}
.auth-submit-btn {
    padding: 0.8rem;
    font-size: 1rem;
    font-weight: 600;
    border-radius: 8px;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}
.auth-submit-btn.is-loading {
    color: transparent !important;
}
.auth-submit-btn .spinner-border {
    position: absolute;
    top: 50%;
    left: 50%;
    margin-top: -0.75rem;
    margin-left: -0.75rem;
    width: 1.5rem;
    height: 1.5rem;
    color: white;
    display: none;
}
.auth-submit-btn.is-loading .spinner-border {
    display: block;
}
/* ========= NEW LOGIN & SIGNUP STYLES END ========= */

        #adminLoader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 9999; display: none; }
        .spinner-border { color: var(--accent-color); }
        .card { background-color: var(--card-bg); border: 1px solid var(--border-color); color: var(--text-primary); margin-bottom: 1.5rem; }
        .card-title { color: var(--text-primary); }
        .table-responsive { overflow-x: auto; }
        .table { background-color: var(--card-bg); color: var(--text-primary); border-color: var(--border-color); margin-bottom: 0;}
        .table > :not(caption) > * > * { background-color: transparent !important; border-bottom-color: var(--border-color); }
        .table th { color: var(--text-secondary); font-weight: 500; white-space: nowrap; padding: 0.8rem 1rem;}
        .table td { vertical-align: middle; white-space: nowrap; padding: 0.7rem 1rem;}
        .table td .text-muted { color: var(--text-muted-custom) !important; }
        .table td small.text-muted { font-size: 0.85em; }
        .table-hover > tbody > tr:hover > * { background-color: rgba(255, 255, 255, 0.03) !important; color: var(--text-primary); }
        .action-buttons button, .action-buttons a, .action-buttons select { margin-right: 5px; margin-bottom: 5px; }
        .modal-content { background-color: var(--secondary-bg); color: var(--text-primary); border: 1px solid var(--border-color); }
        .modal-header { border-bottom-color: var(--border-color); }
        .modal-footer { border-top-color: var(--border-color); }
        .modal-body label { margin-bottom: 0.5rem; font-weight: 500; color: var(--text-secondary); }
        .form-control, .form-select { background-color: var(--primary-bg); color: var(--text-primary); border: 1px solid var(--border-color); }
        .form-control:focus, .form-select:focus { background-color: var(--primary-bg); color: var(--text-primary); border-color: var(--accent-color); box-shadow: 0 0 0 0.2rem rgba(250, 204, 21, 0.25); }
        .form-control::placeholder { color: var(--text-secondary); opacity: 0.7; }
        .form-control:disabled, .form-select:disabled { background-color: #2d3748; opacity: 0.7; }
        .form-control[type="file"] { background-color: var(--primary-bg); color: var(--text-secondary); border: 1px solid var(--border-color); }
        .imgbb-upload-status { display: none; margin-top: 5px; font-size: 0.85rem; color: var(--text-secondary);}
        .table img.preview-img { max-width: 60px; height: 40px; object-fit: cover; border-radius: 4px; cursor: pointer; border: 1px solid var(--border-color); }
        .text-bg-primary { background-color: #3B82F6 !important; }
        .text-bg-info { background-color: #0ea5e9 !important; }
        .text-bg-warning { background-color: #f59e0b !important; }
        .text-bg-success { background-color: #10b981 !important; }
        .text-bg-danger { background-color: #ef4444 !important; }
        .text-bg-secondary { background-color: #6b7280 !important; }
        .text-bg-dark { background-color: #374151 !important; }
        .nav-tabs .nav-link { color: var(--text-secondary); border-color: var(--border-color); border-bottom-color: transparent; margin-bottom: -1px;}
        .nav-tabs .nav-link.active { color: var(--accent-color); background-color: var(--card-bg); border-color: var(--border-color); border-bottom-color: var(--card-bg); font-weight: 600; }
        .nav-tabs { border-bottom-color: var(--border-color); }
        textarea.form-control { min-height: 120px; }
        .copy-btn { cursor: pointer; opacity: 0.6; transition: opacity: 0.2s; }
        .copy-btn:hover { opacity: 1; }
        .status-badge { font-size: 0.8em; padding: 0.3em 0.6em; border-radius: 0.25rem; }
        .loading-placeholder td > div { background-color: var(--placeholder-bg); border-radius: 4px; min-height: 1.2em; animation: placeholder-glow 2s ease-in-out infinite; }
        @keyframes placeholder-glow { 0% { background-color: var(--placeholder-bg); } 50% { background-color: rgba(100, 116, 139, 0.2); } 100% { background-color: var(--placeholder-bg); } }

        /* Dashboard Styles */
        .dashboard-card { background-color: var(--card-bg); background-image: radial-gradient(circle at 50% 0%, rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0) 50%); border: 1px solid var(--border-color); border-left-width: 5px; border-radius: 8px; padding: 1.25rem; position: relative; overflow: hidden; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15); transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease; }
        .dashboard-card:hover { transform: translateY(-5px); }
        .dashboard-card.card-users:hover { box-shadow: 0 8px 25px rgba(96, 165, 250, 0.2), 0 0 15px rgba(96, 165, 250, 0.15); }
        .dashboard-card.card-tournaments:hover { box-shadow: 0 8px 25px rgba(16, 185, 129, 0.2), 0 0 15px rgba(16, 185, 129, 0.15); }
        .dashboard-card.card-pending-wd:hover { box-shadow: 0 8px 25px rgba(245, 158, 11, 0.2), 0 0 15px rgba(245, 158, 11, 0.15); }
        .dashboard-card.card-completed-wd:hover { box-shadow: 0 8px 25px rgba(59, 130, 246, 0.2), 0 0 15px rgba(59, 130, 246, 0.15); }
        .dashboard-card.card-rejected-wd:hover { box-shadow: 0 8px 25px rgba(239, 68, 68, 0.2), 0 0 15px rgba(239, 68, 68, 0.15); }
        .dashboard-card.card-secondary:hover { box-shadow: 0 8px 25px rgba(100, 116, 139, 0.2), 0 0 15px rgba(100, 116, 139, 0.15); }
        .dashboard-card .card-content { position: relative; z-index: 2; }
        .dashboard-card .card-title { font-size: 0.95rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.5rem; }
        .dashboard-card .card-stat-number { font-size: 2.25rem; font-weight: 700; color: var(--text-primary); line-height: 1.1; }
        .dashboard-card .card-icon { position: absolute; right: -20px; bottom: -20px; font-size: 6rem; color: var(--text-primary); opacity: 0.07; transform: rotate(-15deg); transition: transform 0.4s ease, opacity 0.4s ease; }
        .dashboard-card:hover .card-icon { transform: rotate(0deg) scale(1.1); opacity: 0.1; }
        .dashboard-card.card-users { border-left-color: var(--info-color); }
        .dashboard-card.card-tournaments { border-left-color: var(--success-color); }
        .dashboard-card.card-pending-wd { border-left-color: var(--warning-color); }
        .dashboard-card.card-completed-wd { border-left-color: var(--primary-button-bg); }
        .dashboard-card.card-rejected-wd { border-left-color: var(--danger-color); }
        .dashboard-card.card-secondary { border-left-color: var(--text-muted-custom); }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        #dashboard-section .row > [class*="col-"] { animation: fadeInUp 0.5s ease-out forwards; animation-delay: calc(var(--order, 0) * 100ms); opacity: 0; }

        /* Users Section Styles */
        #users-section-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 1.5rem; }
        .user-card { background-color: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; transition: transform 0.3s ease, box-shadow 0.3s ease; animation: fadeIn 0.5s; position: relative; cursor: pointer; }
        .user-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.25); }
        @keyframes rgb-border-anim { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .user-card.selected::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #ee82ee); background-size: 400% 100%; animation: rgb-border-anim 4s linear infinite; border-top-left-radius: 8px; border-top-right-radius: 8px; }
        .user-card-header { padding: 1rem 1.25rem; border-bottom: 1px solid var(--border-color); }
        .user-card-header .user-name { font-size: 1.1rem; font-weight: 600; color: var(--text-primary); margin: 0; }
        .user-card-header .user-email { font-size: 0.85rem; color: var(--text-secondary); word-break: break-all; }
        .user-card-body { padding: 1.25rem; flex-grow: 1; display: flex; flex-direction: column; gap: 0.75rem; }
        .user-card-info-row { display: flex; justify-content: space-between; align-items: center; }
        .user-card-info-row .label { font-size: 0.9rem; color: var(--text-secondary); }
        .user-card-info-row .value { font-weight: 500; color: var(--text-primary); }
        .user-card-info-row .value.balance { font-size: 1.2rem; font-weight: 700; color: var(--accent-color); }
        .user-card-footer { padding: 0.75rem 1.25rem; background-color: rgba(0,0,0,0.2); border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 0.5rem; }
        .user-card-footer .btn { transition: transform 0.1s ease; }
        .user-card-footer .btn:active { transform: scale(0.95); }
        .user-search-bar { position: relative; }
        .user-search-bar .form-control { padding-left: 2.5rem; }
        .user-search-bar .bi-search { position: absolute; left: 0.9rem; top: 50%; transform: translateY(-50%); color: var(--text-secondary); }

        /* ======== NEW TOURNAMENTS SECTION STYLES START ======== */
        #tournaments-card-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
        }
        .tournament-card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            animation: fadeIn 0.5s ease-out;
        }
        .tournament-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.3);
        }
        .tournament-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 4px;
            background: linear-gradient(90deg, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #ee82ee);
            background-size: 400% 100%;
            animation: rgb-border-anim 5s linear infinite;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
        }
        .tournament-card-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--border-color);
        }
        .tournament-card-header h5 {
            font-size: 1.15rem;
            font-weight: 600;
            margin: 0;
            color: var(--text-primary);
        }
        .tournament-card-header p {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin: 0;
        }
        .tournament-card-body {
            padding: 1.25rem;
            flex-grow: 1;
        }
        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        .info-item {
            display: flex;
            flex-direction: column;
        }
        .info-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
            text-transform: uppercase;
        }
        .info-value {
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-primary);
        }
        .info-value.prize, .info-value.fee {
            font-weight: 600;
            color: var(--accent-color);
        }
        .tournament-card-footer {
            padding: 0.75rem 1.25rem;
            background-color: rgba(0,0,0,0.2);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            flex-wrap: nowrap;
        }
        .tournament-card-footer .btn {
            font-size: 0.8rem;
        }
        .loading-placeholder-card {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 1rem;
            height: 250px;
            animation: placeholder-glow 2s ease-in-out infinite;
        }
        /* ======== NEW TOURNAMENTS SECTION STYLES END ======== */


        /* Promotions Section Styles */
        #promotions-grid-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; }
        .promotion-card { background-color: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; transition: transform 0.3s ease, box-shadow 0.3s ease; position: relative; cursor: pointer; }
        .promotion-card.selected { transform: translateY(-8px); box-shadow: 0 12px 24px rgba(0,0,0,0.3); }
        .promotion-card.selected::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #ee82ee); background-size: 400% 100%; animation: rgb-border-anim 4s linear infinite; border-top-left-radius: 8px; border-top-right-radius: 8px; }
        .promotion-card-img-container { width: 100%; padding-top: 56.25%; position: relative; background-color: var(--primary-bg); }
        .promotion-card-img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        .promotion-card-body { padding: 1rem 1.25rem; flex-grow: 1; }
        .promotion-card-body .link-label { font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.25rem; }
        .promotion-card-body .link-url { font-size: 0.9rem; word-break: break-all; }
        .promotion-card-body .link-url a { color: var(--info-color); text-decoration: none; }
        .promotion-card-body .link-url a:hover { text-decoration: underline; }
        .promotion-card-footer { padding: 0.75rem 1.25rem; background-color: rgba(0,0,0,0.2); border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 0.5rem; }
        .promotion-card-body .link-label.text-muted { color: var(--text-primary) !important; }

        /* --- New Withdrawal Section Styles --- */
        #withdrawals-section .withdrawal-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }
        #withdrawals-section .filter-btn {
            flex-grow: 1;
            border: 1px solid var(--border-color);
            background-color: var(--secondary-bg);
            color: var(--text-secondary);
            transition: all 0.2s ease-in-out;
        }
        #withdrawals-section .filter-btn:hover {
            background-color: #2a3a52;
            color: var(--text-primary);
        }
        #withdrawals-section .filter-btn.active {
            background: var(--accent-gradient, var(--accent-color));
            color: #111827;
            border-color: var(--accent-color);
            font-weight: 600;
            box-shadow: 0 0 15px rgba(250, 204, 21, 0.3);
        }

        #withdrawal-card-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
            gap: 1.5rem;
        }

        .withdrawal-card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 1.25rem;
            position: relative;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .withdrawal-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }
        .withdrawal-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 3px;
            background: linear-gradient(90deg, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #ee82ee);
            background-size: 400% 100%;
            opacity: 0;
            transition: opacity 0.4s ease;
        }
        .withdrawal-card.selected::before {
            opacity: 1;
            animation: rgb-border-anim 4s linear infinite;
        }

        .withdrawal-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 1rem;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }
        .withdrawal-card-user .name {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        .withdrawal-card-user .email {
            font-size: 0.85rem;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px; /* Adjust as needed */
        }
        .withdrawal-card-amount {
            font-size: 1.6rem; /* Reduced font size */
            font-weight: 700;
            color: var(--success-color); /* Changed to green */
            line-height: 1;
            white-space: nowrap;
        }

        .withdrawal-card-body .info-row {
            display: flex;
            justify-content: flex-start; /* Aligned left */
            align-items: center;
            font-size: 0.9rem;
            margin-bottom: 0.6rem;
            gap: 0.75rem; /* Added gap */
        }
        .withdrawal-card-body .info-row .label {
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .withdrawal-card-body .info-row .value {
            font-weight: 500;
            text-align: left; /* Aligned left */
            word-break: break-all;
        }
        .withdrawal-card-body .info-row .value.method {
            font-family: monospace;
            background-color: rgba(0,0,0,0.2);
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
        }

        .withdrawal-card-footer {
            margin-top: 1.25rem;
            padding-top: 1.25rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
        }
        .withdrawal-card-footer .btn {
            flex-grow: 1;
            transition: transform 0.1s ease, filter 0.1s ease;
        }
        .withdrawal-card-footer .btn:active {
            transform: scale(0.96);
            filter: brightness(0.9);
        }

        /*=============================================*/
        /*========= NEW PROMO CODE STYLES START =========*/
        /*=============================================*/
        .promo-code-card {
            background-color: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem 1.25rem;
            margin-bottom: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            animation: fadeInSlideDown 0.5s ease-out;
            transition: box-shadow 0.3s ease;
        }
        .promo-code-card:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        @keyframes fadeInSlideDown {
            from { opacity: 0; transform: translateY(-15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .promo-code-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-wrap: wrap;
            gap: 0.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border-color);
        }
        .promo-code-card-code {
            font-family: 'Courier New', Courier, monospace;
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--accent-color);
            margin: 0;
            word-break: break-all;
        }
        .promo-code-card-amount {
            font-size: 0.95rem;
            color: var(--text-secondary);
            margin: 0;
            line-height: 1.2;
        }
        .promo-code-card-amount strong {
            color: var(--text-primary);
        }
        .usage-progress-container {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .usage-progress-text {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        .promo-code-card-actions {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border-color);
        }
        .publish-btn {
            position: relative;
            transition: all 0.3s ease;
        }
        .publish-btn .btn-text {
            transition: opacity 0.2s ease;
        }
        .publish-btn.is-loading .btn-text {
            opacity: 0;
        }
        .publish-btn .spinner-border {
            position: absolute;
            top: 50%;
            left: 50%;
            margin-top: -0.75rem;
            margin-left: -0.75rem;
            width: 1.5rem;
            height: 1.5rem;
            color: white;
            display: none;
        }
        .publish-btn.is-loading .spinner-border {
            display: block;
        }
        /*===========================================*/
        /*========= NEW PROMO CODE STYLES END =========*/
        /*===========================================*/
        
        /*===========================================*/
        /*========= NEW STAFF SECTION STYLES START =========*/
        /*===========================================*/
        #staff-card-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 1.5rem;
        }
        .staff-card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
            animation: fadeIn 0.5s ease-out;
        }
        .staff-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 4px;
            background: linear-gradient(90deg, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #ee82ee);
            background-size: 400% 100%;
            animation: rgb-border-anim 5s linear infinite;
        }
        .staff-card-body {
            padding: 1.25rem;
            flex-grow: 1;
        }
        .staff-card-body .staff-email {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            word-break: break-all;
        }
        .staff-card-body .staff-created {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 1.25rem;
        }
        .staff-card-footer {
            padding: 0.75rem 1.25rem;
            background-color: rgba(0,0,0,0.2);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 1rem;
        }
        /*===========================================*/
        /*========= NEW STAFF SECTION STYLES END =========*/
        /*===========================================*/

        /* Other Sections Styles */
        #tmsPlayerListContainer .form-control { width: 80px; padding: 0.25rem 0.5rem; font-size: 0.9rem; text-align: center; }
        #tmsPlayerListContainer .calculated-prize { font-weight: 600; color: var(--accent-color); min-width: 80px; text-align: center; }
        #themeSettingsForm .color-input-group { display: flex; align-items: center; gap: 10px; padding: 8px; border-radius: 6px; background-color: var(--primary-bg); margin-bottom: 10px; }
        #themeSettingsForm .color-input-group label { flex-grow: 1; margin-bottom: 0; font-size: 0.9rem; color: var(--text-secondary); }
        #themeSettingsForm input[type="color"] { -webkit-appearance: none; -moz-appearance: none; appearance: none; width: 40px; height: 40px; background-color: transparent; border: 1px solid var(--border-color); border-radius: 50%; cursor: pointer; }
        #themeSettingsForm input[type="color"]::-webkit-color-swatch { border-radius: 50%; border: none; }
        #themeSettingsForm input[type="color"]::-moz-color-swatch { border-radius: 50%; border: none; }
        .theme-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; }
        .theme-actions { display: flex; gap: 10px; flex-wrap: wrap; border-top: 1px solid var(--border-color); padding-top: 1.5rem; margin-top: 1.5rem; }
        #pendingDepositsCardContainer { display: grid; grid-template-columns: repeat(auto-fit, minmax(340px, 1fr)); gap: 1.5rem; }
        .deposit-card { background-color: var(--secondary-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 1rem; transition: all 0.3s ease-in-out; cursor: pointer; position: relative; overflow: hidden; }
        .deposit-card.selected::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #ee82ee); background-size: 400% 100%; animation: rgb-border-anim 4s linear infinite; border-top-left-radius: 8px; border-top-right-radius: 8px; }
        .deposit-card.selected { box-shadow: 0 4px 20px rgba(96, 165, 250, 0.25); }
        .deposit-card-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 0.75rem; margin-bottom: 0.75rem; gap: 1rem; }
        .deposit-card-user .name { font-weight: 600; color: var(--text-primary); display: block; }
        .deposit-card-user .email { font-size: 0.8rem; color: var(--text-secondary); word-break: break-all; }
        .deposit-card-amount { font-size: clamp(1.5rem, 5vw, 2rem); font-weight: 700; color: var(--success-color); line-height: 1; text-align: right; flex-shrink: 1; }
        .deposit-card-body .info-row { display: flex; justify-content: space-between; font-size: 0.9rem; margin-bottom: 0.5rem; }
        .deposit-card-body .info-row .label { color: var(--text-secondary); }
        .deposit-card-body .info-row .value { color: var(--text-primary); font-weight: 500; word-break: break-all; text-align: right; }
        .deposit-card-footer { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color); display: flex; gap: 0.5rem; }
        .deposit-card-footer .btn { flex-grow: 1; transition: transform 0.1s ease, filter 0.1s ease; }
        .deposit-card-footer .btn:active { transform: scale(0.96); filter: brightness(0.9); }
        #liveSupportUserListContainer { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 1rem; }
        .support-user-card { background-color: var(--secondary-bg); padding: 1rem; border-radius: 8px; border-left: 4px solid var(--border-color); cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease, border-left-color 0.2s ease; display: flex; flex-direction: column; }
        .support-user-card:hover { transform: translateY(-4px); box-shadow: 0 6px 12px rgba(0,0,0,0.2); border-left-color: var(--info-color); }
        .support-user-card.selected { border-left-color: var(--accent-color); background-color: #2a3a52; }
        .support-user-card .user-info .name { font-weight: 600; color: var(--text-primary); margin-bottom: 0; }
        .support-user-card .user-info .email { font-size: 0.8rem; color: var(--text-secondary); }
        .support-user-card .last-message { margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid var(--border-color); font-size: 0.9rem; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex-grow: 1; }
        .support-user-card .last-message .badge { margin-right: 5px; }
        .support-card-footer { margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; }
        #liveSupportChatContainer { display: flex; flex-direction: column; height: calc(100vh - 100px); max-height: 700px; background-color: var(--secondary-bg); border-radius: 8px; border: 1px solid var(--border-color); overflow: hidden; }
        .chat-header { display: flex; align-items: center; padding: 0.75rem 1rem; border-bottom: 1px solid var(--border-color); background-color: var(--card-bg); }
        .chat-back-button { background: none; border: none; color: var(--text-primary); font-size: 1.5rem; margin-right: 1rem; padding: 0 0.5rem; }
        .chat-user-name { font-size: 1.1rem; font-weight: 600; color: var(--text-primary); }
        .chat-messages { flex-grow: 1; overflow-y: auto; padding: 1rem; display: flex; flex-direction: column; gap: 0.75rem; }
        .chat-message { max-width: 75%; padding: 0.6rem 1rem; border-radius: 12px; word-wrap: break-word; }
        .chat-message.user-message { background-color: var(--primary-bg); align-self: flex-start; border-top-left-radius: 2px; }
        .chat-message.admin-message { background-color: var(--primary-button-bg); color: #fff; align-self: flex-end; border-top-right-radius: 2px; }
        .chat-message .timestamp { display: block; font-size: 0.7rem; color: var(--text-secondary); margin-top: 4px; text-align: right; opacity: 0.8; }
        .chat-message.admin-message .timestamp { color: rgba(255,255,255,0.7); }
        .chat-input-form { display: flex; padding: 1rem; border-top: 1px solid var(--border-color); gap: 0.75rem; }
        /* FEATURE 1: Styles for review results modal */
        #reviewResultsTableBody .screenshot-container {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        #reviewResultsTableBody .screenshot-thumb {
            width: 80px;
            height: 45px;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            cursor: pointer;
        }
    </style>
</head>
<body>

    <div id="adminLoader">
        <div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div>
    </div>

        <!-- Login / Setup Area -->
    <div id="auth-container">
        <!-- ============================================= -->
        <!-- =========== NEW SETUP SECTION START =========== -->
        <!-- ============================================= -->
        <div id="admin-setup-section" style="display: none;">
            <div class="auth-wrapper">
                <div class="auth-container">
                    <div class="auth-header">
                        <h1 class="auth-title">Admin Account Setup</h1>
                        <p class="auth-subtitle">Create the first administrator account to get started.</p>
                    </div>
                    <form id="adminSetupForm" class="auth-form">
                        <div class="mb-3">
                            <label for="setupEmail" class="form-label">Admin Email</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-envelope-fill"></i></span>
                                <input type="email" class="form-control" id="setupEmail" required placeholder="admin@example.com">
                            </div>
                        </div>
                        <div class="mb-4">
                            <label for="setupPassword" class="form-label">Admin Password</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-key-fill"></i></span>
                                <input type="password" class="form-control" id="setupPassword" required minlength="6" placeholder="Min. 6 characters">
                                <span class="input-group-text" id="toggleSetupPassword"><i class="bi bi-eye-slash"></i></span>
                            </div>
                        </div>
                        <div id="adminSetupStatus" class="mt-3"></div>
                        <div class="d-grid mt-4">
                            <button type="submit" class="btn btn-success auth-submit-btn">
                                <span class="btn-text">Create Admin Account</span>
                                <div class="spinner-border spinner-border-sm" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <!-- ============================================= -->
        <!-- ============ NEW SETUP SECTION END ============ -->
        <!-- ============================================= -->

        <!-- ============================================= -->
        <!-- =========== NEW LOGIN SECTION START =========== -->
        <!-- ============================================= -->
        <div id="admin-login-section" style="display: none;">
            <div class="auth-wrapper">
                <div class="auth-container">
                    <div class="auth-header">
                        <h1 class="auth-title">Admin Login</h1>
                        <p class="auth-subtitle">Welcome back! Please sign in to continue.</p>
                    </div>
                    <form id="adminLoginForm" class="auth-form">
                        <div class="mb-3">
                            <label for="adminEmail" class="form-label">Email</label>
                             <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-envelope-fill"></i></span>
                                <input type="email" class="form-control" id="adminEmail" required placeholder="your-email@example.com">
                            </div>
                        </div>
                        <div class="mb-4">
                            <label for="adminPassword" class="form-label">Password</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-key-fill"></i></span>
                                <input type="password" class="form-control" id="adminPassword" required placeholder="••••••••">
                                <span class="input-group-text" id="toggleLoginPassword"><i class="bi bi-eye-slash"></i></span>
                            </div>
                        </div>
                        <div id="adminLoginStatus" class="mt-3"></div>
                        <div class="d-grid mt-4">
                            <button type="submit" class="btn btn-primary auth-submit-btn">
                                <span class="btn-text">Login</span>
                                <div class="spinner-border spinner-border-sm" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <!-- ============================================= -->
        <!-- ============ NEW LOGIN SECTION END ============ -->
        <!-- ============================================= -->
    </div>

    <!-- Main Admin Panel Area -->
    <div id="admin-main-area" style="display: none;">
        <header class="app-header">
            <div class="header-left">
                <button class="menu-toggle-btn" type="button">
                    <i class="bi bi-list"></i>
                </button>
                <img src="https://via.placeholder.com/35/1E293B/94A3B8?text=L" alt="Logo" class="header-logo" id="adminHeaderLogo" style="display:none;">
                <h1 class="header-title ms-1" id="adminPageTitle">Dashboard</h1>
            </div>
            <div class="header-right">
                <span class="admin-email-header" id="adminUserEmailShort"></span>
                <button class="btn btn-sm btn-outline-danger" id="adminLogoutBtnHeader" title="Logout">
                    <i class="bi bi-box-arrow-right"></i>
                    <span class="d-none d-sm-inline ms-1">Logout</span>
                </button>
            </div>
        </header>

        <div class="new-sidebar" id="adminSidebar">
            <div class="offcanvas-header">
                <h5 class="offcanvas-title" id="adminSidebarLabel">Admin Menu</h5>
                <button type="button" class="btn-close btn-close-white" id="sidebarCloseBtn" aria-label="Close"></button>
            </div>
            <div class="offcanvas-body">
                <ul class="nav flex-column">
                     <li class="nav-item"> <a class="nav-link active" href="#" data-section="dashboard-section"><i class="bi bi-speedometer2"></i> Dashboard</a> </li>
                    <li class="nav-item"> <a class="nav-link" href="#" data-section="games-section"><i class="bi bi-controller"></i> Games</a> </li>
                    <li class="nav-item"> <a class="nav-link" href="#" data-section="promotions-section"><i class="bi bi-images"></i> Promotions</a> </li>
                    <li class="nav-item"> <a class="nav-link" href="#" data-section="tournaments-section"><i class="bi bi-trophy"></i> Tournaments</a> </li>
                    <li class="nav-item"> <a class="nav-link" href="#" data-section="tournament-management-section"><i class="bi bi-award-fill"></i> Tournament Mgt</a> </li>
                    <li class="nav-item"> <a class="nav-link" href="#" data-section="leaderboard-mgt-section"><i class="bi bi-bar-chart-line-fill"></i> Leaderboard Mgt</a> </li>
                    <li class="nav-item"> <a class="nav-link" href="#" data-section="users-section"><i class="bi bi-people"></i> Users</a> </li>
                    <li class="nav-item"> <a class="nav-link" href="#" data-section="user-analytics-section"><i class="bi bi-pie-chart-fill"></i> User Analytics</a> </li>
                    <li class="nav-item"> <a class="nav-link" href="#" data-section="notifications-section"><i class="bi bi-bell"></i> Notifications</a> </li>
                    <li class="nav-item"> <a class="nav-link" href="#" data-section="transactions-section"><i class="bi bi-receipt"></i> Transactions</a> </li>
                    <li class="nav-item"> <a class="nav-link" href="#" data-section="withdrawals-section"><i class="bi bi-cash-coin"></i> Withdrawals <span class="badge bg-danger ms-1" id="pendingWithdrawalCountBadge" style="display: none;">0</span></a> </li>
                    <li class="nav-item"> <a class="nav-link" href="#" data-section="deposit-section">
                            <img src="https://i.ibb.co/cWcfwt2/20250626-183518.png" alt="Deposit Icon" class="sidebar-icon" style="height: 20px; width: 20px; object-fit: contain;"> Deposit <span class="badge bg-warning ms-1" id="pendingDepositCountBadge" style="display: none;">0</span>
                        </a>
                    </li>
                    <li class="nav-item"> <a class="nav-link" href="#" data-section="referrals-section"><i class="bi bi-person-plus"></i> Referrals <span class="badge bg-info ms-1" id="pendingReferralCountBadge" style="display: none;">0</span></a> </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-section="live-support-section">
                            <i class="bi bi-chat-dots"></i> Live Support
                            <span class="badge bg-primary ms-1" id="liveSupportMessageCountBadge" style="display: none;">0</span>
                        </a>
                    </li>
                    <!-- ==================================================== -->
                    <!-- ============ NEW PROMO CODE SIDEBAR LINK =========== -->
                    <!-- ==================================================== -->
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-section="promo-code-section">
                            <i class="bi bi-gift-fill"></i> User Code
                        </a>
                    </li>
                    <!-- ==================================================== -->
                    <!-- =================== END OF NEW LINK ================ -->
                    <!-- ==================================================== -->
                    
                    <!-- =============================================== -->
                    <!-- =========== NEW STAFF SIDEBAR LINK ============ -->
                    <!-- =============================================== -->
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-section="staff-section">
                            <i class="bi bi-person-badge"></i> Add Staff
                        </a>
                    </li>
                    <!-- =============================================== -->
                    <!-- ============== END OF NEW LINK ================ -->
                    <!-- =============================================== -->

                    <li class="nav-item"> <a class="nav-link" href="#" data-section="theme-section"><i class="bi bi-palette-fill"></i> Theme Changer</a> </li>
                    <li class="nav-item"> <a class="nav-link" href="#" data-section="settings-section"><i class="bi bi-gear"></i> Settings</a> </li>
                </ul>
            </div>
        </div>

        <main class="main-content" id="adminMainContent">
            <section id="dashboard-section" class="section active">
                <h2>Dashboard Overview</h2>
                <div class="row">
                    <div class="col-xl-3 col-md-6 mb-4" style="--order: 1;">
                        <div class="dashboard-card card-users h-100">
                            <div class="card-content">
                                <h5 class="card-title text-uppercase">Total Users</h5>
                                <p class="card-stat-number mb-0" id="statTotalUsers">--</p>
                            </div>
                            <i class="bi bi-people-fill card-icon"></i>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6 mb-4" style="--order: 2;">
                        <div class="dashboard-card card-tournaments h-100">
                            <div class="card-content">
                                <h5 class="card-title text-uppercase">Active/Upcoming</h5>
                                <p class="card-stat-number mb-0" id="statActiveTournaments">--</p>
                            </div>
                            <i class="bi bi-trophy-fill card-icon"></i>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6 mb-4" style="--order: 3;">
                        <div class="dashboard-card card-pending-wd h-100">
                             <div class="card-content">
                                <h5 class="card-title text-uppercase">Pending Withdrawals</h5>
                                <p class="card-stat-number mb-0" id="statPendingWithdrawals">--</p>
                            </div>
                            <i class="bi bi-hourglass-split card-icon"></i>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6 mb-4" style="--order: 4;">
                        <div class="dashboard-card card-completed-wd h-100">
                           <div class="card-content">
                                <h5 class="card-title text-uppercase">Completed Withdrawals</h5>
                                <p class="card-stat-number mb-0" id="statCompletedWithdrawals">--</p>
                            </div>
                            <i class="bi bi-check-circle-fill card-icon"></i>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6 mb-4" style="--order: 5;">
                        <div class="dashboard-card card-rejected-wd h-100">
                           <div class="card-content">
                                <h5 class="card-title text-uppercase">Rejected Withdrawals</h5>
                                <p class="card-stat-number mb-0" id="statRejectedWithdrawals">--</p>
                            </div>
                            <i class="bi bi-x-octagon-fill card-icon"></i>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6 mb-4" style="--order: 6;">
                        <div class="dashboard-card card-secondary h-100">
                           <div class="card-content">
                                <h5 class="card-title text-uppercase">Total Games</h5>
                                <p class="card-stat-number mb-0" id="statTotalGames">--</p>
                            </div>
                            <i class="bi bi-controller card-icon"></i>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6 mb-4" style="--order: 7;">
                        <div class="dashboard-card card-secondary h-100">
                           <div class="card-content">
                                <h5 class="card-title text-uppercase">Total Promotions</h5>
                                <p class="card-stat-number mb-0" id="statTotalPromotions">--</p>
                            </div>
                            <i class="bi bi-images card-icon"></i>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6 mb-4" style="--order: 8;">
                        <div class="dashboard-card card-secondary h-100">
                            <div class="card-content">
                                <h5 class="card-title text-uppercase">Finished Tournaments</h5>
                                <p class="card-stat-number mb-0" id="statFinishedTournaments">--</p>
                            </div>
                            <i class="bi bi-flag-fill card-icon"></i>
                        </div>
                    </div>
                </div>
                <div id="dashboardStatus"></div>
                <div class="row">
                    <div class="col-12">
                         <div class="card">
                             <div class="card-body">
                                 <h5 class="card-title">New User Signups (Last 7 Days)</h5>
                                 <canvas id="newUserChart"></canvas>
                             </div>
                         </div>
                    </div>
                </div>
            </section>

            <section id="games-section" class="section">
                <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                    <h2>Manage Games</h2>
                    <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#gameModal" id="addNewGameBtn"><i class="bi bi-plus-circle"></i> Add Game</button>
                </div>
                 <div id="gamesStatus" class="mb-3"></div>
                <div class="table-responsive card">
                    <table class="table table-dark table-hover mb-0">
                        <thead> <tr><th>Image</th><th>Name</th><th>Game ID</th><th>Actions</th></tr> </thead>
                        <tbody id="gamesTableBody">
                            <tr class="loading-placeholder"><td colspan="4"><div class="placeholder w-100 py-3"></div></td></tr>
                            <tr class="loading-placeholder"><td colspan="4"><div class="placeholder w-100 py-3"></div></td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="promotions-section" class="section">
                <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                     <h2>Manage Promotions</h2>
                     <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#promotionModal" id="addNewPromotionBtn"><i class="bi bi-plus-circle"></i> Add Promotion</button>
                </div>
                <div id="promotionsStatus" class="mb-3"></div>
                <div id="promotions-grid-container"></div>
             </section>

            <!-- ==================================================== -->
            <!-- =========== MODIFIED TOURNAMENTS SECTION =========== -->
            <!-- ==================================================== -->
            <section id="tournaments-section" class="section">
                 <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                     <h2>Manage Tournaments</h2>
                     <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#addTournamentModal" id="addNewTournamentBtn"><i class="bi bi-plus-circle"></i> Add Tournament</button>
                 </div>
                 <div id="tournamentsStatus" class="mb-3"></div>
                 <div id="tournaments-card-container">
                    <!-- Tournament cards will be injected here by JavaScript -->
                 </div>
            </section>
            <!-- ==================================================== -->
            <!-- ================= END OF MODIFICATION ================ -->
            <!-- ==================================================== -->

            <section id="tournament-management-section" class="section">
                <h2>Tournament Prize Management</h2>
                <div class="card">
                    <div class="card-body">
                        <!-- FEATURE 1: MODIFIED ROW -->
                        <div class="row align-items-end mb-3">
                            <div class="col-md-6">
                                <label for="tmsTournamentSelect" class="form-label">Select Tournament</label>
                                <select class="form-select" id="tmsTournamentSelect">
                                    <option value="">-- Loading Tournaments --</option>
                                </select>
                            </div>
                            <div class="col-md-6 text-md-end mt-2 mt-md-0">
                                <button class="btn btn-warning" id="reviewResultsBtn" style="display: none;">
                                    <i class="bi bi-eye-fill"></i> Review Submitted Results
                                </button>
                            </div>
                        </div>
                        <!-- END OF MODIFICATION -->
                        <div id="tmsStatus" class="mb-3"></div>

                        <div id="tmsPlayerListContainer" style="display: none;">
                            <div class="table-responsive">
                                <table class="table table-dark table-hover mb-0">
                                    <thead>
                                        <tr>
                                            <th>Player</th>
                                            <th>Game UID</th>
                                            <th>Per Kill Prize</th>
                                            <th>Kills</th>
                                            <th>Extra Amount</th>
                                            <th>Rank</th>
                                            <th>Calculated Prize</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tmsPlayerListTableBody"></tbody>
                                </table>
                            </div>
                            <div class="mt-4 text-end">
                                <button class="btn btn-success btn-lg" id="creditWinningsBtn">
                                    <i class="bi bi-check-circle-fill"></i> Credit All Winnings
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="leaderboard-mgt-section" class="section">
                <h2>Leaderboard Management</h2>
                <div class="card">
                    <div class="card-body">
                        <p class="text-secondary">
                           Set ranks manually or use the "Auto-Rank" feature to sort the top 50 users by their Winning Balance. Auto-ranking will fill the table below; you must click "Save Manual Changes" to apply them.
                        </p>
                        <div id="leaderboardMgtStatus" class="mb-3"></div>
                        <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                             <input type="search" class="form-control form-control-sm" style="max-width: 300px;" id="leaderboardUserSearchInput" placeholder="Search for user...">
                            <div class="btn-group" role="group">
                                <button class="btn btn-info" id="autoRankLeaderboardBtn">
                                    <i class="bi bi-magic"></i> Auto-Rank by Winnings
                                </button>
                                <button class="btn btn-primary" id="saveLeaderboardBtn">
                                    <i class="bi bi-save"></i> Save Manual Changes
                                </button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-dark table-hover">
                                <thead>
                                    <tr>
                                        <th>User</th>
                                        <th>Rank</th>
                                        <th>Display Earnings (₹)</th>
                                    </tr>
                                </thead>
                                <tbody id="leaderboardMgtTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <section id="users-section" class="section">
                <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
                    <h2>Manage Users</h2>
                </div>
                <div class="user-controls mb-4">
                    <div class="user-search-bar mb-3">
                        <i class="bi bi-search"></i>
                        <input type="search" class="form-control" id="userSearchInput" placeholder="Search by name or email...">
                    </div>
                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addUserModal">
                        <i class="bi bi-person-plus-fill me-1"></i> Add User
                    </button>
                </div>
                 <div id="usersStatus" class="mb-3"></div>
                 <div id="users-section-container"></div>
            </section>

             <section id="user-analytics-section" class="section">
                 <h2>User Analytics</h2>
                 <div class="row">
                     <div class="col-lg-4 mb-4">
                         <div class="card h-100">
                             <div class="card-body">
                                 <h5 class="card-title">Top 10 Spenders</h5>
                                 <div class="table-responsive" id="topSpendersContainer">
                                      <p class="text-secondary">Loading data...</p>
                                 </div>
                             </div>
                         </div>
                     </div>
                     <div class="col-lg-4 mb-4">
                          <div class="card h-100">
                             <div class="card-body">
                                 <h5 class="card-title">Top 10 Active Players</h5>
                                 <div class="table-responsive" id="mostActiveContainer">
                                      <p class="text-secondary">Loading data...</p>
                                 </div>
                             </div>
                         </div>
                     </div>
                     <div class="col-lg-4 mb-4">
                         <div class="card h-100">
                             <div class="card-body">
                                 <h5 class="card-title">Inactive Users (> 15 days)</h5>
                                 <div class="table-responsive" id="inactiveUsersContainer">
                                      <p class="text-secondary">Loading data...</p>
                                 </div>
                             </div>
                         </div>
                     </div>
                 </div>
            </section>

            <section id="notifications-section" class="section">
                <h2>Send Notifications</h2>
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">Send Global Notification (to all users)</h5>
                        <form id="globalNotificationForm">
                            <div class="mb-3">
                                <label for="globalNotifTitle" class="form-label">Title</label>
                                <input type="text" class="form-control" id="globalNotifTitle" required>
                            </div>
                            <div class="mb-3">
                                <label for="globalNotifMessage" class="form-label">Message</label>
                                <textarea class="form-control" id="globalNotifMessage" rows="3" required></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="globalNotifImageUrl" class="form-label">Image URL (Optional)</label>
                                <input type="url" class="form-control" id="globalNotifImageUrl" placeholder="https://example.com/image.png">
                            </div>
                            <button type="submit" class="btn btn-primary">Send to All Users</button>
                            <div id="globalNotificationStatus" class="mt-3"></div>
                        </form>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Global Notification History</h5>
                        <div id="globalNotificationsHistory" class="table-responsive">
                            <p class="text-muted">Loading history...</p>
                        </div>
                    </div>
                </div>
            </section>

            <section id="transactions-section" class="section card"> <div class="card-body"> <h2 class="card-title">User Transactions</h2> <p class="text-muted">Section under development.</p></div> </section>

            <!-- ==================================================== -->
            <!-- =========== NEW WITHDRAWALS SECTION ================ -->
            <!-- ==================================================== -->
            <section id="withdrawals-section" class="section">
                <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                    <h2>Manage Withdrawals</h2>
                </div>
                <div id="withdrawalsStatus" class="mb-3"></div>

                <!-- New Filter Buttons -->
                <div class="withdrawal-filters" id="withdrawalFilters">
                    <button class="btn filter-btn active" data-status="pending">
                        <i class="bi bi-hourglass-split me-2"></i>Pending
                    </button>
                    <button class="btn filter-btn" data-status="completed">
                        <i class="bi bi-check-circle-fill me-2"></i>Completed
                    </button>
                    <button class="btn filter-btn" data-status="rejected">
                        <i class="bi bi-x-octagon-fill me-2"></i>Rejected
                    </button>
                </div>

                <!-- New Card Container -->
                <div id="withdrawal-card-container">
                    <!-- Withdrawal cards will be injected here by JavaScript -->
                    <p class="text-muted w-100">Loading withdrawals...</p>
                </div>
            </section>
            <!-- ==================================================== -->
            <!-- ================= END OF SECTION =================== -->
            <!-- ==================================================== -->

            <section id="deposit-section" class="section">
                <h2>Manage Deposits</h2>
                <div id="depositsStatus" class="mb-3"></div>
                <div id="pendingDepositsCardContainer"></div>
            </section>

            <section id="referrals-section" class="section">
                <h2>Manage Referrals</h2>
                <div id="referralsStatus" class="mb-3"></div>
                <div class="card">
                    <div class="card-header bg-secondary border-bottom border-dark">
                        <ul class="nav nav-tabs card-header-tabs" id="referralTabs" role="tablist">
                            <li class="nav-item" role="presentation"><button class="nav-link active" id="pending-referrals-tab" data-bs-toggle="tab" data-bs-target="#pendingReferralsTab" type="button" role="tab">Pending</button></li>
                            <li class="nav-item" role="presentation"><button class="nav-link" id="completed-referrals-tab" data-bs-toggle="tab" data-bs-target="#completedReferralsTab" type="button" role="tab">Completed</button></li>
                        </ul>
                    </div>
                    <div class="card-body tab-content p-0">
                        <div class="tab-pane fade show active" id="pendingReferralsTab" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-dark table-hover mb-0">
                                    <thead><tr><th>Date</th><th>Referrer</th><th>Referred User</th><th>Action</th></tr></thead>
                                    <tbody id="pendingReferralsTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="completedReferralsTab" role="tabpanel">
                             <div class="table-responsive">
                                <table class="table table-dark table-hover mb-0">
                                    <thead><tr><th>Credited At</th><th>Referrer</th><th>Referred User</th><th>Bonus</th></tr></thead>
                                    <tbody id="completedReferralsTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="live-support-section" class="section">
                <div id="liveSupportStatus" class="mb-3"></div>
                <div id="liveSupportUserListContainer"></div>
                <div id="liveSupportChatContainer" style="display: none;">
                    <div class="chat-header">
                        <button class="chat-back-button" id="liveSupportChatBackButton" title="Back to list">
                            <i class="bi bi-arrow-left"></i>
                        </button>
                        <h5 class="chat-user-name mb-0" id="liveSupportChatUserName"></h5>
                    </div>
                    <div class="chat-messages" id="liveSupportChatMessages"></div>
                    <form class="chat-input-form" id="liveSupportChatForm">
                        <input type="text" class="form-control" id="liveSupportChatInput" placeholder="Type a message..." autocomplete="off">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-send-fill"></i>
                        </button>
                    </form>
                </div>
            </section>
            
            <!-- ==================================================== -->
            <!-- ============ NEW PROMO CODE SECTION START ============ -->
            <!-- ==================================================== -->
            <section id="promo-code-section" class="section">
                <div id="promoCodeStatus" class="mb-3"></div>
                <div class="row">
                    <!-- Left Column: Create Code -->
                    <div class="col-lg-5 mb-4 mb-lg-0">
                        <div class="card h-100">
                            <div class="card-body">
                                <h5 class="card-title mb-4">Create New Promo Code</h5>
                                <form id="promoCodeForm">
                                    <div class="mb-3">
                                        <label for="promoCodeAmount" class="form-label">Amount (₹)</label>
                                        <input type="number" class="form-control" id="promoCodeAmount" placeholder="Enter Amount (e.g., 50)" required min="1">
                                    </div>
                                    <div class="mb-3">
                                        <label for="promoCodeBalanceType" class="form-label">Credit to Balance</label>
                                        <select class="form-select" id="promoCodeBalanceType" required>
                                            <option value="" selected disabled>-- Choose balance type --</option>
                                            <option value="depositBalance">Deposit Balance</option>
                                            <option value="winningCash">Winning Balance</option>
                                            <option value="bonusCash">Bonus Balance</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="promoCodeUsageLimit" class="form-label">Total Usage Limit</label>
                                        <input type="number" class="form-control" id="promoCodeUsageLimit" placeholder="Enter Usage Limit (e.g., 100)" required min="1">
                                    </div>
                                    <div class="mb-3">
                                        <label for="promoCodeInput" class="form-label">Promo Code</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="promoCodeInput" placeholder="Enter custom code or generate" required>
                                            <button class="btn btn-outline-secondary" type="button" id="generateRandomCodeBtn" title="Generate Random Code"><i class="bi bi-shuffle"></i></button>
                                        </div>
                                    </div>
                                    <div class="d-grid mt-4">
                                        <button type="submit" class="btn btn-primary publish-btn" id="publishPromoCodeBtn">
                                            <span class="btn-text">Publish Promo Code</span>
                                            <div class="spinner-border spinner-border-sm" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    <!-- Right Column: View Codes -->
                    <div class="col-lg-7">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title mb-3">Promo Code Management</h5>
                                
                                <div class="active-codes-container">
                                    <h6 class="text-success mb-2"><i class="bi bi-check-circle-fill"></i> Active Codes</h6>
                                    <div id="active-promo-codes-list">
                                        <p class="text-secondary small">Loading active codes...</p>
                                    </div>
                                </div>
                                
                                <hr class="my-4" style="border-color: var(--border-color);">
                                
                                <div class="inactive-codes-container">
                                    <h6 class="text-muted-custom mb-2"><i class="bi bi-archive-fill"></i> Inactive Codes</h6>
                                    <div id="inactive-promo-codes-list">
                                        <p class="text-secondary small">Loading inactive codes...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            <!-- ==================================================== -->
            <!-- ============= NEW PROMO CODE SECTION END ============= -->
            <!-- ==================================================== -->
            
            <!-- =============================================== -->
            <!-- =========== NEW STAFF SECTION START ============= -->
            <!-- =============================================== -->
            <section id="staff-section" class="section">
                <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                    <h2>Manage Staff</h2>
                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addStaffModal">
                        <i class="bi bi-person-plus-fill me-1"></i> Add New Staff
                    </button>
                </div>
                <div id="staffStatus" class="mb-3"></div>
                <div id="staff-card-container">
                    <!-- Staff cards will be injected here -->
                </div>
            </section>
            <!-- =============================================== -->
            <!-- ============ NEW STAFF SECTION END ============== -->
            <!-- =============================================== -->


            <section id="theme-section" class="section">
                <h2>Theme Customization</h2>
                <div class="card">
                    <div class="card-body">
                        <form id="themeSettingsForm">
                            <div id="themeStatus" class="mb-3"></div>

                            <h5 class="card-title">Preset Themes</h5>
                            <div class="mb-4 d-flex flex-wrap gap-2">
                                <button type="button" class="btn btn-secondary" id="presetBtnDefault">Default Dark</button>
                                <button type="button" class="btn btn-light" id="presetBtnLight">Professional Light</button>
                                <button type="button" class="btn btn-danger" id="presetBtnGamingRed">Gaming Red</button>
                            </div>

                            <h5 class="card-title">Custom Theme Colors</h5>
                            <p class="text-secondary small">Changes here will be reflected live on this admin panel. Click "Save Theme" to apply them for all users.</p>

                            <div class="theme-grid">
                                <div>
                                    <h6>Backgrounds & Cards</h6>
                                    <div class="color-input-group">
                                        <label for="themePrimaryBg">Primary Background</label>
                                        <input type="color" id="themePrimaryBg" data-theme-var="primary-bg">
                                    </div>
                                    <div class="color-input-group">
                                        <label for="themeSecondaryBg">Secondary Background</label>
                                        <input type="color" id="themeSecondaryBg" data-theme-var="secondary-bg">
                                    </div>
                                     <div class="color-input-group">
                                        <label for="themeCardBg">Card Background</label>
                                        <input type="color" id="themeCardBg" data-theme-var="card-bg">
                                    </div>
                                    <div class="color-input-group">
                                        <label for="themeBorderColor">Border Color</label>
                                        <input type="color" id="themeBorderColor" data-theme-var="border-color">
                                    </div>
                                </div>
                                <div>
                                    <h6>Text</h6>
                                    <div class="color-input-group">
                                        <label for="themeTextPrimary">Primary Text</label>
                                        <input type="color" id="themeTextPrimary" data-theme-var="text-primary">
                                    </div>
                                    <div class="color-input-group">
                                        <label for="themeTextSecondary">Secondary Text</label>
                                        <input type="color" id="themeTextSecondary" data-theme-var="text-secondary">
                                    </div>
                                </div>
                                <div>
                                     <h6>Accents & Buttons</h6>
                                     <div class="color-input-group">
                                        <label for="themeAccentColor">Accent Color</label>
                                        <input type="color" id="themeAccentColor" data-theme-var="accent-color">
                                    </div>
                                    <div class="color-input-group">
                                        <label for="themePrimaryButtonBg">Primary Button BG</label>
                                        <input type="color" id="themePrimaryButtonBg" data-theme-var="primary-button-bg">
                                    </div>
                                </div>
                                <div>
                                     <h6>Status Colors</h6>
                                     <div class="color-input-group">
                                        <label for="themeSuccessColor">Success</label>
                                        <input type="color" id="themeSuccessColor" data-theme-var="success-color">
                                    </div>
                                    <div class="color-input-group">
                                        <label for="themeDangerColor">Danger</label>
                                        <input type="color" id="themeDangerColor" data-theme-var="danger-color">
                                    </div>
                                     <div class="color-input-group">
                                        <label for="themeWarningColor">Warning</label>
                                        <input type="color" id="themeWarningColor" data-theme-var="warning-color">
                                    </div>
                                </div>
                            </div>

                            <div class="theme-actions">
                                <button type="button" class="btn btn-primary btn-lg" id="saveThemeBtn"><i class="bi bi-save"></i> Save Theme for All Users</button>
                                <button type="button" class="btn btn-outline-danger" id="resetThemeBtn"><i class="bi bi-arrow-counterclockwise"></i> Reset to Default</button>
                            </div>

                        </form>
                    </div>
                </div>
            </section>

            <section id="settings-section" class="section card">
                <div class="card-body">
                    <h2 class="card-title">App Settings</h2>
                    <form id="appSettingsForm">
                        <div class="row">
                            <div class="col-md-6 mb-3"> <label for="settingAppName" class="form-label">App Name</label> <input type="text" class="form-control" id="settingAppName"> </div>
                            <div class="col-md-6 mb-3"> <label for="settingLogoUrl" class="form-label">Logo URL</label> <input type="url" class="form-control" id="settingLogoUrl"> </div>
                            <div class="col-md-4 mb-3"> <label for="settingSignupBonus" class="form-label">Sign Up Bonus (₹)</label> <input type="number" class="form-control" id="settingSignupBonus" min="0" step="any"> </div>
                            <div class="col-md-4 mb-3"> <label for="settingReferralBonus" class="form-label">Referral Bonus (₹)</label> <input type="number" class="form-control" id="settingReferralBonus" min="0" step="any"> </div>
                            <div class="col-md-4 mb-3"> <label for="settingMinWithdraw" class="form-label">Min Withdraw (₹)</label> <input type="number" class="form-control" id="settingMinWithdraw" min="0" step="any"> </div>
                            <div class="col-md-6 mb-3"> <label for="settingSupportContact" class="form-label">Contact Us Number (for WhatsApp)</label> <input type="text" class="form-control" id="settingSupportContact" placeholder="e.g., 919876543210 (without +)"> </div>
                            <div class="col-md-6 mb-3"> <label for="settingUpiDetails" class="form-label">UPI ID for Payments</label> <input type="text" class="form-control" id="settingUpiDetails"> </div>
                            <div class="col-md-6 mb-3"> <label for="settingQrCodeUrl" class="form-label">QR Code Image URL</label> <input type="url" class="form-control" id="settingQrCodeUrl" placeholder="https://example.com/qr.png"> </div>

                            <div class="col-md-6 mb-3">
                                <label for="settingLoginLogoUrl" class="form-label">Login Logo URL</label>
                                <input type="url" class="form-control" id="settingLoginLogoUrl" placeholder="https://example.com/login-logo.png">
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="settingLiveSupportName" class="form-label">Live Support Name</label>
                                <input type="text" class="form-control" id="settingLiveSupportName" placeholder="e.g., Support Team">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="settingLiveSupportLogoUrl" class="form-label">Live Support Logo URL</label>
                                <input type="url" class="form-control" id="settingLiveSupportLogoUrl" placeholder="https://example.com/logo.png">
                            </div>

                            <!-- FEATURE 1: HTML CHANGE START -->
                            <div class="col-md-6 mb-3">
                                <label for="settingLiveSupportTitle" class="form-label">Live Support Title</label>
                                <input type="text" class="form-control" id="settingLiveSupportTitle" placeholder="e.g., We are here to help">
                            </div>
                            <!-- FEATURE 1: HTML CHANGE END -->

                            <div class="col-12 mb-3"> <label for="settingPolicyPrivacy" class="form-label">Privacy Policy</label> <textarea class="form-control" id="settingPolicyPrivacy" rows="5"></textarea> </div>
                            <div class="col-12 mb-3"> <label for="settingPolicyTerms" class="form-label">Terms & Conditions</label> <textarea class="form-control" id="settingPolicyTerms" rows="5"></textarea> </div>
                            <div class="col-12 mb-3"> <label for="settingPolicyRefund" class="form-label">Refund Policy</label> <textarea class="form-control" id="settingPolicyRefund" rows="5"></textarea> </div>
                            <div class="col-12 mb-3"> <label for="settingPolicyFairPlay" class="form-label">Fair Play Policy</label> <textarea class="form-control" id="settingPolicyFairPlay" rows="5"></textarea> </div>
                        </div>
                        <button type="submit" class="btn btn-primary"><i class="bi bi-save"></i> Save Settings</button>
                        <div id="settingsStatus" class="mt-3"></div>
                    </form>
                </div>
            </section>
        </main>
    </div>

    <!-- Modals -->
    <div class="modal fade" id="gameModal" tabindex="-1"> <div class="modal-dialog"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title" id="gameModalTitle">Add New Game</h5> <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button> </div> <div class="modal-body"> <form id="gameForm"> <input type="hidden" id="gameEditId"> <div class="mb-3"> <label for="gameName" class="form-label">Game Name</label> <input type="text" class="form-control" id="gameName" required> </div> <div class="mb-3"> <label for="gameImageUrl" class="form-label">Image URL</label> <input type="url" class="form-control" id="gameImageUrl" required> <small class="text-muted">Direct image URL (e.g., from ImgBB).</small> </div> <div class="mb-3"> <label for="gameImageFile" class="form-label">Upload New Image (Optional - Overwrites URL)</label> <input class="form-control" type="file" id="gameImageFile" accept="image/*"> <div class="imgbb-upload-status mt-2"></div> </div> <div id="gameStatus" class="mt-2"></div></form> </div> <div class="modal-footer"> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button> <button type="button" class="btn btn-primary" id="saveGameBtn">Save Game</button> </div> </div> </div> </div>
    <div class="modal fade" id="promotionModal" tabindex="-1"> <div class="modal-dialog"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title" id="promotionModalTitle">Add New Promotion</h5> <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button> </div> <div class="modal-body"> <form id="promotionForm"> <input type="hidden" id="promotionEditId"> <div class="mb-3"> <label for="promoImageUrl" class="form-label">Image URL</label> <input type="url" class="form-control" id="promoImageUrl" required> <small class="text-muted">Direct image URL (e.g., from ImgBB).</small> </div> <div class="mb-3"> <label for="promoImageFile" class="form-label">Upload New Image (Optional - Overwrites URL)</label> <input class="form-control" type="file" id="promoImageFile" accept="image/*"> <div class="imgbb-upload-status mt-2"></div> </div> <div class="mb-3"> <label for="promoLink" class="form-label">Link (Optional)</label> <input type="url" class="form-control" id="promoLink"> </div> <div id="promotionStatus" class="mt-2"></div></form> </div> <div class="modal-footer"> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button> <button type="button" class="btn btn-primary" id="savePromotionBtn">Save Promotion</button> </div> </div> </div> </div>
    <div class="modal fade" id="addTournamentModal" tabindex="-1"> <div class="modal-dialog modal-lg"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title" id="tournamentModalTitle">Add New Tournament</h5> <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button> </div> <div class="modal-body"> <form id="tournamentForm"> <input type="hidden" id="tournamentEditId"> <div class="row"> <div class="col-md-6 mb-3"> <label for="tournamentGame" class="form-label">Game</label> <select class="form-select" id="tournamentGame" required></select> </div> <div class="col-md-6 mb-3"> <label for="tournamentName" class="form-label">Tournament Name</label> <input type="text" class="form-control" id="tournamentName" required> </div> <div class="col-md-6 mb-3"> <label for="tournamentStartTime" class="form-label">Start Date & Time</label> <input type="datetime-local" class="form-control" id="tournamentStartTime" required> </div> <div class="col-md-6 mb-3"> <label for="tournamentStatus" class="form-label">Status</label> <select class="form-select" id="tournamentStatus" required> <option value="upcoming">Upcoming</option> <option value="ongoing">Ongoing</option> <option value="completed">Completed</option> <option value="result">Result</option> <option value="cancelled">Cancelled</option> </select> </div> <div class="col-md-4 mb-3"> <label for="tournamentEntryFee" class="form-label">Entry Fee (₹)</label> <input type="number" class="form-control" id="tournamentEntryFee" min="0" value="0" required step="any"> </div> <div class="col-md-4 mb-3"> <label for="tournamentPrizePool" class="form-label">Total Prize Pool (₹)</label> <input type="number" class="form-control" id="tournamentPrizePool" min="0" value="0" step="any"> </div> <div class="col-md-4 mb-3"> <label for="tournamentPerKill" class="form-label">Per Kill Prize (₹)</label> <input type="number" class="form-control" id="tournamentPerKill" min="0" value="0" step="any"> </div> <div class="col-md-4 mb-3"> <label for="tournamentMaxPlayers" class="form-label">Max Players (0 for Unlimited)</label> <input type="number" class="form-control" id="tournamentMaxPlayers" min="0" value="0" required> </div><div class="col-md-4 mb-3"> <label for="tournamentMode" class="form-label">Mode</label> <select class="form-select" id="tournamentMode"><option value="Solo">Solo</option><option value="Duo">Duo</option><option value="Squad">Squad</option></select> </div> <div class="col-md-4 mb-3"> <label for="tournamentTags" class="form-label">Tags (comma-separated)</label> <input type="text" class="form-control" id="tournamentTags" placeholder="e.g., Erangel, TPP"> </div>
                            <div class="col-12 mb-3"> <label for="tournamentBannerUrl" class="form-label">Banner URL (16:9)</label> <input type="url" class="form-control" id="tournamentBannerUrl" placeholder="https://example.com/banner.jpg"> </div>
                            <div class="col-12 mb-3"> <label for="tournamentDescription" class="form-label">Description / Rules</label> <textarea class="form-control" id="tournamentDescription" rows="4"></textarea> </div> <div class="col-md-6 mb-3"> <label for="tournamentRoomId" class="form-label">Room ID</label> <input type="text" class="form-control" id="tournamentRoomId"> </div> <div class="col-md-6 mb-3"> <label for="tournamentRoomPassword" class="form-label">Room Password</label> <input type="text" class="form-control" id="tournamentRoomPassword"> </div> <div class="form-check mb-3 ms-2"> <input class="form-check-input" type="checkbox" id="tournamentShowIdPass"> <label class="form-check-label" for="tournamentShowIdPass"> Show ID/Pass?</label> </div> </div> <div id="addTournamentStatus" class="mt-2"></div></form> </div> <div class="modal-footer"> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button> <button type="button" class="btn btn-primary" id="saveTournamentBtn">Save Tournament</button> </div> </div> </div> </div>
    <div class="modal fade" id="userModal" tabindex="-1"> <div class="modal-dialog modal-lg modal-dialog-scrollable"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title" id="userModalTitle">User Details</h5> <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button> </div> <div class="modal-body"> <div class="row"> <div class="col-md-6"> <h5>User Info</h5> <p><strong>UID:</strong> <small id="userDetailUid" class="text-muted user-uid-copy"></small> <i class="bi bi-clipboard copy-btn ms-1" data-target="#userDetailUid" title="Copy UID"></i></p> <p><strong>Email:</strong> <span id="userDetailEmail"></span></p> <p><strong>Name:</strong> <span id="userDetailName"></span></p> <p><strong>Created At:</strong> <span id="userDetailCreatedAt">N/A</span></p> <hr> <h5>Wallet</h5> <p>Deposit Balance: <span id="userDetailDepositBalance">₹0.00</span></p> <p>Winning Cash: <span id="userDetailWinning">₹0.00</span></p> <p>Bonus Cash: <span id="userDetailBonus">₹0.00</span></p> <hr> <h5>Referral Info</h5> <p><strong>Referral Code:</strong> <span id="userDetailReferralCode" class="text-info">N/A</span> <i class="bi bi-clipboard copy-btn ms-1" data-target="#userDetailReferralCode" title="Copy Code"></i></p> <p><strong>Referred By:</strong> <span id="userDetailReferredBy">N/A</span></p> <p><strong>Users Referred:</strong> <span id="userDetailReferredCount">N/A</span></p> </div> <div class="col-md-6"> <h5>Update Balance (Caution!)</h5> <form id="updateBalanceForm"> <input type="hidden" id="editUserUid"> <div class="row"> <div class="col-md-6 mb-3"> <label for="balanceUpdateAmount" class="form-label">Amount (+/-)</label> <input type="number" step="any" class="form-control" id="balanceUpdateAmount" placeholder="e.g., 50 or -20" required> </div> <div class="col-md-6 mb-3"> <label for="balanceUpdateType" class="form-label">Balance Type</label> <select id="balanceUpdateType" class="form-select" required> <option value="">--Select--</option> <option value="depositBalance">Deposit Balance</option> <option value="winningCash">Winning Cash</option> <option value="bonusCash">Bonus Cash</option> </select> </div> </div> <div class="mb-3"> <label for="balanceUpdateReason" class="form-label">Reason</label> <input type="text" class="form-control" id="balanceUpdateReason" placeholder="Manual Deposit, Correction etc." required> </div> <button type="submit" class="btn btn-warning">Update Balance</button> <div id="balanceUpdateStatus" class="mt-2"></div> </form> <hr> <h5>Status & Actions</h5> <p>Current Status: <span id="userDetailStatus" class="fw-bold"></span></p> <button class="btn btn-sm mb-2" id="userBlockBtn"></button> <button class="btn btn-sm btn-danger mb-2" id="userDeleteBtn"><i class="bi bi-trash"></i> Delete User (DB Only)</button> <hr>
                         <h5>Send Notification (Individual)</h5>
                         <form id="individualNotificationForm">
                             <div class="mb-2">
                                 <label for="individualNotifTitle" class="form-label">Title</label>
                                 <input type="text" class="form-control form-control-sm" id="individualNotifTitle" required>
                             </div>
                             <div class="mb-2">
                                 <label for="individualNotifMessage" class="form-label">Message</label>
                                 <textarea class="form-control form-control-sm" id="individualNotifMessage" rows="2" required></textarea>
                             </div>
                             <div class="mb-2">
                                 <label for="individualNotifImageUrl" class="form-label">Image URL (Optional)</label>
                                 <input type="url" class="form-control form-control-sm" id="individualNotifImageUrl">
                             </div>
                             <button type="submit" class="btn btn-info btn-sm">Send to this User</button>
                             <div id="individualNotificationStatus" class="mt-2"></div>
                         </form>
                      </div> </div> </div> <div class="modal-footer"> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button> </div> </div> </div> </div>
    <div class="modal fade" id="withdrawalActionModal" tabindex="-1"> <div class="modal-dialog"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title">Withdrawal Action</h5> <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button> </div> <div class="modal-body"> <p><strong>Request ID:</strong> <small id="withdrawalDetailId" class="text-muted withdrawal-id-copy"></small> <i class="bi bi-clipboard copy-btn ms-1" data-target="#withdrawalDetailId" title="Copy Request ID"></i></p> <p><strong>User:</strong> <span id="withdrawalDetailUser"></span> (<small id="withdrawalDetailUserUid" class="text-muted withdrawal-user-uid-copy"></small> <i class="bi bi-clipboard copy-btn ms-1" data-target="#withdrawalDetailUserUid" title="Copy User UID"></i>)</p> <p><strong>Amount:</strong> ₹<span id="withdrawalDetailAmount"></span></p> <p><strong>Method:</strong> <span id="withdrawalDetailMethod"></span></p> <hr> <div id="withdrawalRejectReasonDiv" style="display: none;" class="mb-3"> <label for="withdrawalRejectReason" class="form-label">Reason for Rejection</label> <textarea class="form-control" id="withdrawalRejectReason" rows="3" required></textarea> </div> <div id="withdrawalApproveNoteDiv" style="display: none;" class="mb-3"> <label for="withdrawalApproveNote" class="form-label">Admin Note / Txn ID (Optional)</label> <input type="text" class="form-control" id="withdrawalApproveNote" placeholder="e.g., Transaction ID"> </div> <div id="withdrawalActionStatus" class="mt-2"></div> </div> <div class="modal-footer"> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button> <button type="button" class="btn btn-danger" id="rejectWithdrawalBtn">Reject</button> <button type="button" class="btn btn-success" id="approveWithdrawalBtn">Approve</button> </div> </div> </div> </div>
    <div class="modal fade" id="addUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New User</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addUserForm">
                        <div class="mb-3">
                            <label for="newUserName" class="form-label">Display Name</label>
                            <input type="text" class="form-control" id="newUserName" required>
                        </div>
                        <div class="mb-3">
                            <label for="newUserEmail" class="form-label">Email Address</label>
                            <input type="email" class="form-control" id="newUserEmail" required>
                        </div>
                        <div class="mb-3">
                            <label for="newUserPassword" class="form-label">Password (min 6 chars)</label>
                            <input type="password" class="form-control" id="newUserPassword" required minlength="6">
                        </div>
                        <div class="mb-3">
                            <label for="newUserInitialBalance" class="form-label">Initial Balance (₹)</label>
                            <input type="number" step="any" class="form-control" id="newUserInitialBalance" value="0" min="0">
                            <small class="text-muted">This will be added to Deposit Balance.</small>
                        </div>
                        <div id="addUserStatus" class="mt-2"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="saveNewUserBtn">Create User</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ==================================================== -->
    <!-- ================ NEW STAFF MODAL =================== -->
    <!-- ==================================================== -->
    <div class="modal fade" id="addStaffModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Staff</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addStaffForm">
                        <div class="mb-3">
                            <label for="newStaffEmail" class="form-label">Staff Email Address</label>
                            <input type="email" class="form-control" id="newStaffEmail" required placeholder="staff@example.com">
                        </div>
                        <div class="mb-3">
                            <label for="newStaffPassword" class="form-label">Staff Password</label>
                            <input type="password" class="form-control" id="newStaffPassword" required minlength="6">
                        </div>
                        <div id="addStaffStatus" class="mt-2"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="saveNewStaffBtn">Create Staff</button>
                </div>
            </div>
        </div>
    </div>
    <!-- ==================================================== -->
    <!-- ============= END OF NEW STAFF MODAL =============== -->
    <!-- ==================================================== -->
    
    <div class="modal fade" id="registeredPlayersModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="registeredPlayersModalTitle">Registered Players</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Tournament: <strong id="registeredPlayersTournamentName"></strong></p>
                    <div id="registeredPlayersStatus" class="mb-2"></div>
                    <div class="table-responsive">
                        <table class="table table-dark table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>Registered By</th>
                                    <th>Player 1 (Captain)</th>
                                    <th>Player 2</th>
                                    <th>Player 3</th>
                                    <th>Player 4</th>
                                    <th>Joined At</th>
                                </tr>
                            </thead>
                            <tbody id="registeredPlayersTableBody"></tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="downloadPlayersPdfBtn"><i class="bi bi-file-earmark-pdf-fill"></i> Download PDF</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="viewScreenshotModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Deposit Screenshot</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <img src="" id="screenshotImage" class="img-fluid" alt="Screenshot">
                </div>
            </div>
        </div>
    </div>
    <!-- Confirmation Modal (Generic) -->
    <div class="modal fade" id="confirmationModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmationModalTitle">Confirm Action</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="confirmationModalBodyText"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmActionBtn">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <!-- FEATURE 1: NEW REVIEW RESULTS MODAL -->
    <div class="modal fade" id="reviewResultsModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="reviewResultsModalTitle">Review Submitted Results</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Tournament: <strong id="reviewResultsTournamentName"></strong></p>
                    <div id="reviewResultsStatus" class="mb-2"></div>
                    <div class="table-responsive">
                        <table class="table table-dark table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>Player</th>
                                    <th>Kills</th>
                                    <th>Rank</th>
                                    <th>Calculated Prize</th>
                                    <th>Screenshots</th>
                                </tr>
                            </thead>
                            <tbody id="reviewResultsTableBody"></tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-success btn-lg" id="confirmCreditWinningsBtn"><i class="bi bi-check-circle-fill"></i> Approve & Credit All Winnings</button>
                </div>
            </div>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, get, set, update, push, query, orderByChild, equalTo, onValue, off, remove, serverTimestamp, runTransaction, onDisconnect } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, createUserWithEmailAndPassword, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

        const firebaseConfig = {
  apiKey: "AIzaSyBNgG0zRt3dM-bHqFcN5744vPRpHjYX_pA",
  authDomain: "ff-tournament-4a79f.firebaseapp.com",
  databaseURL: "https://ff-tournament-4a79f-default-rtdb.firebaseio.com",
  projectId: "ff-tournament-4a79f",
  storageBucket: "ff-tournament-4a79f.firebasestorage.app",
  messagingSenderId: "102517236280",
  appId: "1:102517236280:web:46c32d7546fcfa9a6dbccd",
  measurementId: "G-G8J8HQYRP9"
};

        let app, db, auth;

        (async () => {
            try {
                app = initializeApp(firebaseConfig, "adminApp");
                db = getDatabase(app);
                auth = getAuth(app);
                await setPersistence(auth, browserLocalPersistence);
            } catch (error) {
                console.error("Admin Panel: Firebase initialization failed:", error);
                document.body.innerHTML = `<div class="alert alert-danger m-5"><strong>Critical Error:</strong> Could not connect to Firebase. Error: ${error.message}</div>`;
            }
        })();


        const getElement = (id) => document.getElementById(id);
        const querySel = (selector) => document.querySelector(selector);
        const querySelAll = (selector) => document.querySelectorAll(selector);
        const elements = {
             adminLoader: getElement('adminLoader'),
             authContainer: getElement('auth-container'),
             loginSection: getElement('admin-login-section'),
             setupSection: getElement('admin-setup-section'),
             mainArea: getElement('admin-main-area'),
             adminLoginForm: getElement('adminLoginForm'),
             adminEmailInput: getElement('adminEmail'),
             adminPasswordInput: getElement('adminPassword'),
             adminLoginStatus: getElement('adminLoginStatus'),
             adminSetupForm: getElement('adminSetupForm'),
             setupEmailInput: getElement('setupEmail'),
             setupPasswordInput: getElement('setupPassword'),
             setupStatus: getElement('adminSetupStatus'),
             adminUserEmailDisplay: getElement('adminUserEmailShort'),
             adminLogoutBtn: getElement('adminLogoutBtnHeader'),
             sidebar: getElement('adminSidebar'),
             sidebarLinks: querySelAll('#adminSidebar .nav-link'),
             sections: querySelAll('#adminMainContent .section'),
             adminPageTitle: getElement('adminPageTitle'),
             adminHeaderLogo: getElement('adminHeaderLogo'),
             dashboardSection: getElement('dashboard-section'),
             statTotalUsers: getElement('statTotalUsers'),
             statActiveTournaments: getElement('statActiveTournaments'),
             statPendingWithdrawals: getElement('statPendingWithdrawals'),
             statCompletedWithdrawals: getElement('statCompletedWithdrawals'),
             statRejectedWithdrawals: getElement('statRejectedWithdrawals'),
             statTotalGames: getElement('statTotalGames'),
             statTotalPromotions: getElement('statTotalPromotions'),
             statFinishedTournaments: getElement('statFinishedTournaments'),
             dashboardStatus: getElement('dashboardStatus'),
             pendingWithdrawalCountBadge: getElement('pendingWithdrawalCountBadge'),
             newUserChartCanvas: getElement('newUserChart'),
             gamesTableBody: getElement('gamesTableBody'),
             gameModalEl: getElement('gameModal'),
             gameModalTitle: getElement('gameModalTitle'),
             gameForm: getElement('gameForm'),
             gameEditId: getElement('gameEditId'),
             gameNameInput: getElement('gameName'),
             gameImageFileInput: getElement('gameImageFile'),
             gameImageUrlInput: getElement('gameImageUrl'),
             saveGameBtn: getElement('saveGameBtn'),
             gameStatus: getElement('gameStatus'),
             gamesStatus: getElement('gamesStatus'),
             addNewGameBtn: getElement('addNewGameBtn'),
             promotionsGridContainer: getElement('promotions-grid-container'),
             promotionModalEl: getElement('promotionModal'),
             promotionModalTitle: getElement('promotionModalTitle'),
             promotionForm: getElement('promotionForm'),
             promotionEditId: getElement('promotionEditId'),
             promoImageFileInput: getElement('promoImageFile'),
             promoImageUrlInput: getElement('promoImageUrl'),
             promoLinkInput: getElement('promoLink'),
             savePromotionBtn: getElement('savePromotionBtn'),
             promotionStatus: getElement('promotionStatus'),
             promotionsStatus: getElement('promotionsStatus'),
             addNewPromotionBtn: getElement('addNewPromotionBtn'),
             tournamentsCardContainer: getElement('tournaments-card-container'),
             addTournamentModalEl: getElement('addTournamentModal'),
             tournamentForm: getElement('tournamentForm'),
             tournamentModalTitle: getElement('tournamentModalTitle'),
             tournamentEditId: getElement('tournamentEditId'),
             tournamentGameSelect: getElement('tournamentGame'),
             tournamentNameInput: getElement('tournamentName'),
             tournamentStartTimeInput: getElement('tournamentStartTime'),
             tournamentStatusSelect: getElement('tournamentStatus'),
             tournamentEntryFeeInput: getElement('tournamentEntryFee'),
             tournamentPrizePoolInput: getElement('tournamentPrizePool'),
             tournamentPerKillInput: getElement('tournamentPerKill'),
             tournamentMaxPlayersInput: getElement('tournamentMaxPlayers'),
             tournamentTagsInput: getElement('tournamentTags'),
             tournamentBannerUrlInput: getElement('tournamentBannerUrl'),
             tournamentDescriptionInput: getElement('tournamentDescription'),
             tournamentRoomIdInput: getElement('tournamentRoomId'),
             tournamentRoomPasswordInput: getElement('tournamentRoomPassword'),
             tournamentShowIdPassCheckbox: getElement('tournamentShowIdPass'),
             tournamentModeSelect: getElement('tournamentMode'),
             saveTournamentBtn: getElement('saveTournamentBtn'),
             addNewTournamentBtn: getElement('addNewTournamentBtn'),
             addTournamentStatus: getElement('addTournamentStatus'),
             tournamentsStatus: getElement('tournamentsStatus'),
             usersSection: getElement('users-section'),
             usersSectionContainer: getElement('users-section-container'),
             userSearchInput: getElement('userSearchInput'),
             userModalEl: getElement('userModal'),
             userModalTitle: getElement('userModalTitle'),
             userDetailUid: getElement('userDetailUid'),
             userDetailEmail: getElement('userDetailEmail'),
             userDetailName: getElement('userDetailName'),
             userDetailCreatedAt: getElement('userDetailCreatedAt'),
             userDetailDepositBalance: getElement('userDetailDepositBalance'),
             userDetailWinning: getElement('userDetailWinning'),
             userDetailBonus: getElement('userDetailBonus'),
             userDetailReferralCode: getElement('userDetailReferralCode'),
             userDetailReferredBy: getElement('userDetailReferredBy'),
             userDetailReferredCount: getElement('userDetailReferredCount'),
             userDetailStatus: getElement('userDetailStatus'),
             updateBalanceForm: getElement('updateBalanceForm'),
             editUserUid: getElement('editUserUid'),
             balanceUpdateAmountInput: getElement('balanceUpdateAmount'),
             balanceUpdateTypeSelect: getElement('balanceUpdateType'),
             balanceUpdateReasonInput: getElement('balanceUpdateReason'),
             balanceUpdateStatus: getElement('balanceUpdateStatus'),
             userBlockBtn: getElement('userBlockBtn'),
             userDeleteBtn: getElement('userDeleteBtn'),
             addUserModalEl: getElement('addUserModal'),
             addUserForm: getElement('addUserForm'),
             newUserNameInput: getElement('newUserName'),
             newUserEmailInput: getElement('newUserEmail'),
             newUserPasswordInput: getElement('newUserPassword'),
             newUserInitialBalanceInput: getElement('newUserInitialBalance'),
             saveNewUserBtn: getElement('saveNewUserBtn'),
             addUserStatus: getElement('addUserStatus'),
             usersStatus: getElement('usersStatus'),
             withdrawalCardContainer: getElement('withdrawal-card-container'),
             withdrawalActionModalEl: getElement('withdrawalActionModal'),
             withdrawalDetailId: getElement('withdrawalDetailId'),
             withdrawalDetailUser: getElement('withdrawalDetailUser'),
             withdrawalDetailUserUid: getElement('withdrawalDetailUserUid'),
             withdrawalDetailAmount: getElement('withdrawalDetailAmount'),
             withdrawalDetailMethod: getElement('withdrawalDetailMethod'),
             withdrawalRejectReasonDiv: getElement('withdrawalRejectReasonDiv'),
             withdrawalRejectReasonInput: getElement('withdrawalRejectReason'),
             withdrawalApproveNoteDiv: getElement('withdrawalApproveNoteDiv'),
             withdrawalApproveNoteInput: getElement('withdrawalApproveNote'),
             withdrawalActionStatus: getElement('withdrawalActionStatus'),
             rejectWithdrawalBtn: getElement('rejectWithdrawalBtn'),
             approveWithdrawalBtn: getElement('approveWithdrawalBtn'),
             withdrawalsStatus: getElement('withdrawalsStatus'),
             depositSection: getElement('deposit-section'),
             pendingDepositsCardContainer: getElement('pendingDepositsCardContainer'),
             depositsStatus: getElement('depositsStatus'),
             pendingDepositCountBadge: getElement('pendingDepositCountBadge'),
             viewScreenshotModalEl: getElement('viewScreenshotModal'),
             screenshotImage: getElement('screenshotImage'),
             registeredPlayersModalEl: getElement('registeredPlayersModal'),
             registeredPlayersModalTitle: getElement('registeredPlayersModalTitle'),
             registeredPlayersTournamentName: getElement('registeredPlayersTournamentName'),
             registeredPlayersTableBody: getElement('registeredPlayersTableBody'),
             registeredPlayersStatus: getElement('registeredPlayersStatus'),
             downloadPlayersPdfBtn: getElement('downloadPlayersPdfBtn'),
             settingsSection: getElement('settings-section'),
             appSettingsForm: getElement('appSettingsForm'),
             settingLogoUrlInput: getElement('settingLogoUrl'),
             settingAppNameInput: getElement('settingAppName'),
             settingSignupBonusInput: getElement('settingSignupBonus'),
             settingMinWithdrawInput: getElement('settingMinWithdraw'),
             settingReferralBonusInput: getElement('settingReferralBonus'),
             settingSupportContactInput: getElement('settingSupportContact'),
             settingUpiDetailsInput: getElement('settingUpiDetails'),
             settingQrCodeUrlInput: getElement('settingQrCodeUrl'),
             settingLoginLogoUrlInput: getElement('settingLoginLogoUrl'),
             settingLiveSupportNameInput: getElement('settingLiveSupportName'),
             settingLiveSupportLogoUrlInput: getElement('settingLiveSupportLogoUrl'),
             settingLiveSupportTitleInput: getElement('settingLiveSupportTitle'),
             settingPolicyPrivacyInput: getElement('settingPolicyPrivacy'),
             settingPolicyTermsInput: getElement('settingPolicyTerms'),
             settingPolicyRefundInput: getElement('settingPolicyRefund'),
             settingPolicyFairPlayInput: getElement('settingPolicyFairPlay'),
             settingsStatus: getElement('settingsStatus'),
             transactionsSection: getElement('transactions-section'),
             referralsSection: getElement('referrals-section'),
             referralsStatus: getElement('referralsStatus'),
             pendingReferralsTableBody: getElement('pendingReferralsTableBody'),
             completedReferralsTableBody: getElement('completedReferralsTableBody'),
             pendingReferralCountBadge: getElement('pendingReferralCountBadge'),
             notificationsSection: getElement('notifications-section'),
             globalNotificationForm: getElement('globalNotificationForm'),
             globalNotifTitleInput: getElement('globalNotifTitle'),
             globalNotifMessageInput: getElement('globalNotifMessage'),
             globalNotifImageUrlInput: getElement('globalNotifImageUrl'),
             globalNotificationStatus: getElement('globalNotificationStatus'),
             globalNotificationsHistory: getElement('globalNotificationsHistory'),
             individualNotificationForm: getElement('individualNotificationForm'),
             individualNotifTitleInput: getElement('individualNotifTitle'),
             individualNotifMessageInput: getElement('individualNotifMessage'),
             individualNotifImageUrlInput: getElement('individualNotifImageUrl'),
             individualNotificationStatus: getElement('individualNotificationStatus'),
             tournamentManagementSection: getElement('tournament-management-section'),
             tmsTournamentSelect: getElement('tmsTournamentSelect'),
             tmsStatus: getElement('tmsStatus'),
             tmsPlayerListContainer: getElement('tmsPlayerListContainer'),
             tmsPlayerListTableBody: getElement('tmsPlayerListTableBody'),
             creditWinningsBtn: getElement('creditWinningsBtn'),
             leaderboardMgtSection: getElement('leaderboard-mgt-section'),
             leaderboardMgtStatus: getElement('leaderboardMgtStatus'),
             leaderboardMgtTableBody: getElement('leaderboardMgtTableBody'),
             saveLeaderboardBtn: getElement('saveLeaderboardBtn'),
             autoRankLeaderboardBtn: getElement('autoRankLeaderboardBtn'),
             leaderboardUserSearchInput: getElement('leaderboardUserSearchInput'),
             userAnalyticsSection: getElement('user-analytics-section'),
             topSpendersContainer: getElement('topSpendersContainer'),
             mostActiveContainer: getElement('mostActiveContainer'),
             inactiveUsersContainer: getElement('inactiveUsersContainer'),
             themeSection: getElement('theme-section'),
             themeSettingsForm: getElement('themeSettingsForm'),
             themeStatus: getElement('themeStatus'),
             themeColorInputs: querySelAll('#themeSettingsForm input[type="color"]'),
             saveThemeBtn: getElement('saveThemeBtn'),
             resetThemeBtn: getElement('resetThemeBtn'),
             presetBtnDefault: getElement('presetBtnDefault'),
             presetBtnLight: getElement('presetBtnLight'),
             presetBtnGamingRed: getElement('presetBtnGamingRed'),
             liveSupportSection: getElement('live-support-section'),
             liveSupportStatus: getElement('liveSupportStatus'),
             liveSupportUserListContainer: getElement('liveSupportUserListContainer'),
             liveSupportChatContainer: getElement('liveSupportChatContainer'),
             liveSupportChatBackButton: getElement('liveSupportChatBackButton'),
             liveSupportChatUserName: getElement('liveSupportChatUserName'),
             liveSupportChatMessages: getElement('liveSupportChatMessages'),
             liveSupportChatForm: getElement('liveSupportChatForm'),
             liveSupportChatInput: getElement('liveSupportChatInput'),
             liveSupportMessageCountBadge: getElement('liveSupportMessageCountBadge'),
             // New Promo Code Elements
             promoCodeSection: getElement('promo-code-section'),
             promoCodeForm: getElement('promoCodeForm'),
             promoCodeAmountInput: getElement('promoCodeAmount'),
             promoCodeBalanceTypeSelect: getElement('promoCodeBalanceType'),
             promoCodeUsageLimitInput: getElement('promoCodeUsageLimit'),
             promoCodeInput: getElement('promoCodeInput'),
             generateRandomCodeBtn: getElement('generateRandomCodeBtn'),
             publishPromoCodeBtn: getElement('publishPromoCodeBtn'),
             promoCodeStatus: getElement('promoCodeStatus'),
             activePromoCodesList: getElement('active-promo-codes-list'),
             inactivePromoCodesList: getElement('inactive-promo-codes-list'),
             // New Staff Elements
             staffSection: getElement('staff-section'),
             staffStatus: getElement('staffStatus'),
             staffCardContainer: getElement('staff-card-container'),
             addStaffModalEl: getElement('addStaffModal'),
             addStaffForm: getElement('addStaffForm'),
             newStaffEmailInput: getElement('newStaffEmail'),
             newStaffPasswordInput: getElement('newStaffPassword'),
             saveNewStaffBtn: getElement('saveNewStaffBtn'),
             addStaffStatus: getElement('addStaffStatus'),
             // Confirmation Modal
             confirmationModalEl: getElement('confirmationModal'),
             confirmationModalTitle: getElement('confirmationModalTitle'),
             confirmationModalBodyText: getElement('confirmationModalBodyText'),
             confirmActionBtn: getElement('confirmActionBtn'),
             // FEATURE 1: New Elements for Reviewing Results
             reviewResultsBtn: getElement('reviewResultsBtn'),
             reviewResultsModalEl: getElement('reviewResultsModal'),
             reviewResultsModalTitle: getElement('reviewResultsModalTitle'),
             reviewResultsTournamentName: getElement('reviewResultsTournamentName'),
             reviewResultsStatus: getElement('reviewResultsStatus'),
             reviewResultsTableBody: getElement('reviewResultsTableBody'),
             confirmCreditWinningsBtn: getElement('confirmCreditWinningsBtn'),
        };

        let componentInstances = {};
        const getComponentInstance = (element, componentType = 'Modal') => {
            if (!element) return null;
            const instanceKey = `${componentType}-${element.id}`;
            if (!componentInstances[instanceKey]) {
                try {
                     if (componentType === 'Modal') componentInstances[instanceKey] = new bootstrap.Modal(element);
                     else if (componentType === 'Offcanvas') componentInstances[instanceKey] = new bootstrap.Offcanvas(element);
                     else if (componentType === 'Tab') componentInstances[instanceKey] = new bootstrap.Tab(element);
                     else if (componentType === 'Alert') componentInstances[instanceKey] = new bootstrap.Alert(element);
                     else { console.warn("Unknown Bootstrap component type:", componentType); return null; }
                } catch (e) {
                    console.error(`Error creating Bootstrap ${componentType} instance for #${element.id}:`, e);
                    return null;
                }
            }
            return componentInstances[instanceKey];
        }
        const getModalInstance = (element) => getComponentInstance(element, 'Modal');
        const getOffcanvasInstance = (element) => getComponentInstance(element, 'Offcanvas');

        let currentAdminUser = null;
        let currentWithdrawalAction = { id: null, type: null, userId: null };
        let currentEditingItemId = null;
        let currentEditingTournamentId = null;
        let currentChattingUserId = null;
        let gameDataCache = {};
        let userDataCache = {};
        let fullUserDataCache = {};
        let dbListeners = {};
        let isAdminSetupComplete = false;
        let designatedAdminUid = null;
        let appSettings = {};
        let currentPlayersListForPdf = [];
        let newUserChart = null;
        let currentAdminSectionId = null;
        let confirmActionCallback = null;

        function isDesignatedAdmin(user) { if (!user) return false; if (!designatedAdminUid) { console.warn("Designated Admin UID check failed: UID not loaded yet."); return false; } return user.uid === designatedAdminUid; }

        function toggleAuthButtonLoading(form, isLoading) {
            const button = form.querySelector('.auth-submit-btn');
            if (button) {
                if (isLoading) {
                    button.classList.add('is-loading');
                    button.disabled = true;
                } else {
                    button.classList.remove('is-loading');
                    button.disabled = false;
                }
            }
        }
        
        function toggleButtonLoading(button, isLoading) {
            if (button) {
                if (isLoading) {
                    button.classList.add('is-loading');
                    button.disabled = true;
                } else {
                    button.classList.remove('is-loading');
                    button.disabled = false;
                }
            }
        }

        const showLoader = (show) => { if (elements.adminLoader) elements.adminLoader.style.display = show ? 'flex' : 'none'; };
        function showStatus(element, message, type = 'danger', autohide = 5000) { if (!element) { console.warn("showStatus called with null element for message:", message); return; } const alertId = `status-alert-${element.id || Math.random().toString(36).substring(2)}`; element.style.display = 'block'; element.innerHTML = `<div id="${alertId}" class="alert alert-${type} alert-dismissible fade show" role="alert">${sanitizeHTML(message)}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>`; if (autohide && typeof autohide === 'number' && autohide > 0) { setTimeout(() => { const currentAlert = getElement(alertId); if (currentAlert) { try { const bsAlert = getComponentInstance(currentAlert, 'Alert'); if (bsAlert) bsAlert.close(); else currentAlert.remove(); } catch (e) { console.warn("Error closing alert:", e); currentAlert.remove(); } } }, autohide); } }
        function clearStatus(element) { if (!element) return; element.innerHTML = ''; }
        const formatDate = (timestamp, includeTime = true) => { if (!timestamp) return 'N/A'; if (typeof timestamp === 'object' && timestamp.hasOwnProperty('.sv')) { return 'Pending...'; } const tsNumber = Number(timestamp); if (isNaN(tsNumber) || tsNumber <= 0) return 'Invalid Date'; try { const date = new Date(tsNumber); if (isNaN(date.getTime())) return 'Invalid Date'; const options = includeTime ? { dateStyle: 'short', timeStyle: 'short', hour12: true } : { dateStyle: 'short' }; return date.toLocaleString([], options); } catch (e) { console.warn("Error formatting date:", timestamp, e); return 'Invalid Date'; } };
        const formatCurrency = (amount) => {
            const num = Number(amount || 0);
            return isNaN(num) ? '₹0.00' : `₹${num.toFixed(2)}`;
        }
        function sanitizeHTML(str) { if (str == null) return ''; str = String(str); const temp = document.createElement('div'); temp.textContent = str; return temp.innerHTML; }
        function copyToClipboard(targetSelector) { const copyIcon = event?.target.closest('.copy-btn'); const context = copyIcon?.closest('.modal-body, tr'); const element = context?.querySelector(targetSelector); const textToCopy = element?.textContent?.trim(); if (!textToCopy) { console.warn("Copy target empty or not found:", targetSelector); return; } if (navigator.clipboard && window.isSecureContext) { navigator.clipboard.writeText(textToCopy); } else { const textArea = document.createElement("textarea"); textArea.value = textToCopy; textArea.style.position = "fixed"; textArea.style.left = "-9999px"; textArea.style.top = "0"; document.body.appendChild(textArea); textArea.focus(); textArea.select(); try { document.execCommand('copy'); } catch (err) { console.warn('Fallback copy failed: ', err); } document.body.removeChild(textArea); } }
        const tableLoadingPlaceholderHtml = (cols) => `<tr class="loading-placeholder"><td colspan="${cols}"><div class="placeholder w-100 py-3"></div></td></tr>`.repeat(3);
        const tournamentCardPlaceholderHtml = (count) => `<div class="loading-placeholder-card"></div>`.repeat(count);
        function showConfirmationModal(title, bodyText, callback) {
            elements.confirmationModalTitle.textContent = title;
            elements.confirmationModalBodyText.textContent = bodyText;
            confirmActionCallback = callback;
            getModalInstance(elements.confirmationModalEl)?.show();
        }


        function showAdminSection(sectionId, replaceState = false) {
             if (currentAdminSectionId === 'live-support-section' && sectionId !== 'live-support-section') {
                set(ref(db, 'settings/adminStatus'), 'offline');
             }
             currentAdminSectionId = sectionId;

             if(currentChattingUserId && dbListeners['liveChat']) {
                 off(ref(db, `liveSupportChats/${currentChattingUserId}`), 'value', dbListeners['liveChat']);
                 delete dbListeners['liveChat'];
                 console.log("Detached active live chat listener due to section change.");
             }

             elements.sections.forEach(sec => sec.classList.remove('active'));
             const targetSection = getElement(sectionId);
             if (targetSection) {
                 targetSection.classList.add('active');
                 const linkElement = querySel(`#adminSidebar .nav-link[data-section="${sectionId}"]`);
                 let title = 'Admin Panel';
                 if (linkElement) {
                     const linkText = linkElement.textContent.trim() || sectionId.replace('-section', '').replace('-', ' ');
                     title = linkText.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
                     const badge = linkElement.querySelector('.badge');
                     if (badge) { title = title.replace(badge.textContent, '').trim(); }
                 }

                 if(elements.adminPageTitle) elements.adminPageTitle.textContent = title;
                 elements.sidebarLinks?.forEach(link => { link.classList.toggle('active', link.dataset.section === sectionId); });

                 const state = { sectionId: sectionId };
                 const newHash = `#${sectionId}`;
                 if (replaceState) {
                     history.replaceState(state, title, newHash);
                 } else if (window.location.hash !== newHash) {
                     history.pushState(state, title, newHash);
                 }

                 loadDataForSection(sectionId);

                 if (elements.sidebar?.classList.contains('is-open')) {
                    elements.sidebar.classList.remove('is-open');
                 }
             } else {
                 console.error("Section element not found:", sectionId);
                 showAdminSection('dashboard-section', true);
             }
        }

        function loadDataForSection(sectionId) {
             if (!currentAdminUser || !isDesignatedAdmin(currentAdminUser)) { console.warn("Attempted to load data without proper admin authorization."); showStatus(elements.dashboardStatus, "Admin not authorized.", "danger", false); return; }
             console.log(`Loading data for section: ${sectionId}`);

             clearStatus(elements.dashboardStatus); clearStatus(elements.gamesStatus); clearStatus(elements.promotionsStatus);
             clearStatus(elements.tournamentsStatus); clearStatus(elements.usersStatus); clearStatus(elements.withdrawalsStatus);
             clearStatus(elements.settingsStatus); clearStatus(elements.depositsStatus); clearStatus(elements.referralsStatus);
             clearStatus(elements.leaderboardMgtStatus);
             clearStatus(elements.themeStatus);
             clearStatus(elements.liveSupportStatus);
             clearStatus(elements.promoCodeStatus);
             clearStatus(elements.staffStatus);

             switch(sectionId) {
                 case 'dashboard-section': loadDashboardStats(); break;
                 case 'games-section': loadGames(); break;
                 case 'promotions-section': loadPromotions(); break;
                 case 'tournaments-section': loadTournaments(); break;
                 case 'users-section': loadUsers(); break;
                 case 'withdrawals-section':
                    const activeFilterBtn = getElement('withdrawalFilters')?.querySelector('.filter-btn.active');
                    const statusToLoad = activeFilterBtn?.dataset.status || 'pending';
                    loadWithdrawals(statusToLoad);
                    break;
                 case 'deposit-section':
                    loadDepositRequests();
                    break;
                 case 'referrals-section':
                    loadReferrals('pending');
                    loadReferrals('completed');
                    const activeRTabBtn = querySel('#referralTabs .nav-link.active') || getElement('pending-referrals-tab');
                    if (activeRTabBtn) getComponentInstance(activeRTabBtn, 'Tab')?.show();
                    break;
                 case 'live-support-section':
                    set(ref(db, 'settings/adminStatus'), 'online');
                    loadLiveSupportConversations();
                    break;
                 case 'promo-code-section': loadPromoCodes(); break;
                 case 'staff-section': loadStaff(); break; // New Case
                 case 'settings-section': loadSettings(); break;
                 case 'theme-section': loadThemeSettings(); break;
                 case 'notifications-section': loadGlobalNotificationHistory(); break;
                 case 'tournament-management-section': populateTournamentManagementSelector(); break;
                 case 'leaderboard-mgt-section': loadLeaderboardManagementData(); break;
                 case 'user-analytics-section': loadUserAnalyticsData(); break;
                 case 'transactions-section': if (elements.transactionsSection) elements.transactionsSection.innerHTML = '<div class="card-body"><h2 class="card-title">User Transactions</h2><p class="text-muted">Section under development.</p></div>'; break;
                 default: console.warn("Unknown section requested:", sectionId); showStatus(elements.dashboardStatus, `Unknown section requested: ${sectionId}`, "warning");
             }
         }

        async function loginAdmin(event) { event.preventDefault(); if (!auth) return; const email = elements.adminEmailInput.value; const password = elements.adminPasswordInput.value; clearStatus(elements.adminLoginStatus); toggleAuthButtonLoading(elements.adminLoginForm, true); try { await signInWithEmailAndPassword(auth, email, password); } catch (error) { console.error("Admin Login Error:", error); let message = `Login Failed: ${error.code}`; if (error.code === 'auth/network-request-failed') { message = "Login Failed: Network error."; } else if (['auth/invalid-credential', 'auth/wrong-password', 'auth/user-not-found', 'auth/invalid-email'].includes(error.code)) { message = "Login Failed: Invalid email or password."; } else if (error.code === 'auth/too-many-requests') { message = "Login Failed: Too many attempts."; } showStatus(elements.adminLoginStatus, message, 'danger', false); } finally { toggleAuthButtonLoading(elements.adminLoginForm, false); } }
        async function logoutAdminUser() { if (!auth) return; showLoader(true); try { await set(ref(db, 'settings/adminStatus'), 'offline'); await signOut(auth); } catch (error) { console.error("Admin Logout Error:", error); alert("Logout failed: " + error.message); } }
        async function checkAdminSetup() { if (!db) return false; const adminConfigRef = ref(db, 'adminConfig'); try { console.log("Checking admin setup..."); const snapshot = await get(adminConfigRef); if (snapshot.exists()) { const d = snapshot.val(); isAdminSetupComplete = d.setupComplete === true; designatedAdminUid = d.adminUid || null; } else { isAdminSetupComplete = false; designatedAdminUid = null; } console.log("Admin setup check:", isAdminSetupComplete, "| UID:", designatedAdminUid); return isAdminSetupComplete; } catch (error) { console.error("Error checking admin setup:", error); const el = elements.loginSection?.style.display === 'block' ? elements.adminLoginStatus : elements.setupStatus; if (el) showStatus(el, `Config check error: ${error.message}. Check Rules.`, "danger", false); isAdminSetupComplete = false; designatedAdminUid = null; return false; } }
        async function setupAdmin(event) { event.preventDefault(); if (!auth || !db || isAdminSetupComplete) return; const email = elements.setupEmailInput.value.trim(); const password = elements.setupPasswordInput.value; clearStatus(elements.setupStatus); if (password.length < 6) { showStatus(elements.setupStatus, "Password min 6 chars.", "warning"); return; } toggleAuthButtonLoading(elements.adminSetupForm, true); try { const cred = await createUserWithEmailAndPassword(auth, email, password); const uid = cred.user.uid; console.log("Admin user created in Auth:", uid); await set(ref(db, 'adminConfig'), { setupComplete: true, adminUid: uid }); console.log("Admin setup complete in DB."); isAdminSetupComplete = true; designatedAdminUid = uid; await signOut(auth); alert("Admin account created! Please login now."); await handleInitialLoad(); } catch (error) { console.error("Admin Setup Error:", error); let message = `Setup failed: ${error.message}`; if (error.code === 'auth/email-already-in-use') message = "Email already in use."; else if (error.code === 'auth/weak-password') message = "Password is too weak."; else if (error.code === 'auth/invalid-email') message = "Invalid email format."; else if (error.code === 'permission-denied') message = "Setup failed: Permission denied writing config. Check Firebase Rules for '/adminConfig'."; showStatus(elements.setupStatus, message, "danger", false); isAdminSetupComplete = false; designatedAdminUid = null; } finally { toggleAuthButtonLoading(elements.adminSetupForm, false); } }
        async function handleInitialLoad() { if (!auth || !db) return; showLoader(true); await checkAdminSetup(); elements.setupSection.style.display = 'none'; elements.loginSection.style.display = 'none'; elements.mainArea.style.display = 'none'; elements.authContainer.style.display = 'block'; if (!isAdminSetupComplete) { elements.setupSection.style.display = 'block'; console.log("Showing Setup Form"); } else { elements.loginSection.style.display = 'block'; console.log("Showing Login Form"); } showLoader(false); }
        async function handleAdminAuthStateChange(user) {
            if (!auth || !db) return;
            console.log("Auth State Changed. User:", user ? user.uid : 'null');
            showLoader(true);
            currentAdminUser = user;
            detachAllAdminListeners();
            if (user) {
                if (!designatedAdminUid) await checkAdminSetup();
                if (isDesignatedAdmin(user)) {
                    console.log("Admin Authenticated & Authorized:", user.email);

                    const adminStatusRef = ref(db, 'settings/adminStatus');
                    onDisconnect(adminStatusRef).set('offline');

                    if (elements.adminUserEmailDisplay) elements.adminUserEmailDisplay.textContent = user.email;
                    elements.authContainer.style.display = 'none';
                    elements.mainArea.style.display = 'block';
                    await loadSettings();

                    const initialSectionId = window.location.hash.substring(1);
                    const sectionExists = getElement(initialSectionId);
                    const sectionToShow = sectionExists ? initialSectionId : 'dashboard-section';
                    showAdminSection(sectionToShow, true);

                    setupRealtimeAdminListeners();
                } else {
                    console.warn("Unauthorized user login attempt:", user.email, "| UID:", user.uid, "| Expected:", designatedAdminUid);
                    alert(`Access Denied. ${user.email} is not the designated admin.`);
                    await logoutAdminUser();
                    return;
                }
            } else {
                console.log("Auth State: Logged Out");
                currentAdminUser = null;
                designatedAdminUid = null;
                isAdminSetupComplete = false;
                elements.mainArea.style.display = 'none';
                elements.authContainer.style.display = 'block';
                gameDataCache = {};
                userDataCache = {};
                fullUserDataCache = {};
                appSettings = {};
                if(elements.adminHeaderLogo) {
                    elements.adminHeaderLogo.src='https://via.placeholder.com/35/1E293B/94A3B8?text=L';
                    elements.adminHeaderLogo.style.display='none';
                }
                if(elements.adminPageTitle) elements.adminPageTitle.textContent='Admin Panel';
                document.title='Admin Panel';
                if(elements.adminUserEmailDisplay) elements.adminUserEmailDisplay.textContent='';
                Object.values(elements).filter(el => el.id?.startsWith('stat')).forEach(el => el.textContent = '--');
                if(elements.pendingWithdrawalCountBadge) {
                    elements.pendingWithdrawalCountBadge.textContent='0';
                    elements.pendingWithdrawalCountBadge.style.display='none';
                }
                if(elements.userSearchInput) elements.userSearchInput.value = '';
                await handleInitialLoad();
            }
            setTimeout(() => showLoader(false), 150);
        }

        async function loadDashboardStats() { if (!db || !isDesignatedAdmin(currentAdminUser)) return; console.log("Loading dashboard stats..."); clearStatus(elements.dashboardStatus); Object.values(elements).filter(el => el.id?.startsWith('stat')).forEach(el => el.textContent = '...'); const usersRef = ref(db, 'users'); const gamesRef = ref(db, 'games'); const promotionsRef = ref(db, 'promotions'); const tournamentsRef = ref(db, 'tournaments'); const withdrawalsRef = ref(db, 'withdrawals'); const activeTournamentsQuery = query(tournamentsRef, orderByChild('status')); const pendingWithdrawalsQuery = query(withdrawalsRef, orderByChild('status'), equalTo('pending')); const completedWithdrawalsQuery = query(withdrawalsRef, orderByChild('status'), equalTo('completed')); const rejectedWithdrawalsQuery = query(withdrawalsRef, orderByChild('status'), equalTo('rejected')); const results = await Promise.allSettled([ get(usersRef), get(gamesRef), get(promotionsRef), get(activeTournamentsQuery), get(pendingWithdrawalsQuery), get(completedWithdrawalsQuery), get(rejectedWithdrawalsQuery) ]); let errorsFound = false; const setError = (element) => { element.textContent = 'Error'; errorsFound = true; }; if (results[0].status === 'fulfilled') elements.statTotalUsers.textContent = results[0].value.exists() ? results[0].value.size : 0; else { console.error("Err Users:", results[0].reason); setError(elements.statTotalUsers); showStatus(elements.dashboardStatus, `Err Users: ${results[0].reason?.message}`, "warning"); } if (results[1].status === 'fulfilled') elements.statTotalGames.textContent = results[1].value.exists() ? results[1].value.size : 0; else { console.error("Err Games:", results[1].reason); setError(elements.statTotalGames); } if (results[2].status === 'fulfilled') elements.statTotalPromotions.textContent = results[2].value.exists() ? results[2].value.size : 0; else { console.error("Err Promos:", results[2].reason); setError(elements.statTotalPromotions); } if (results[3].status === 'fulfilled') { let activeCount = 0; let finishedCount = 0; if (results[3].value.exists()) { results[3].value.forEach(child => { const status = child.val()?.status; if (status === 'ongoing' || status === 'upcoming') activeCount++; else if (status === 'completed' || status === 'result' || status === 'cancelled') finishedCount++; }); } elements.statActiveTournaments.textContent = activeCount; elements.statFinishedTournaments.textContent = finishedCount; } else { console.error("Err Tournaments:", results[3].reason); setError(elements.statActiveTournaments); setError(elements.statFinishedTournaments); if (results[3].reason?.message?.includes("index")) showStatus(elements.dashboardStatus, "WARNING: Tournament query fail. Add '.indexOn': 'status' to '/tournaments' rules.", "warning", false); else showStatus(elements.dashboardStatus, `Err Tournaments: ${results[3].reason?.message}`, "warning"); } if (results[4].status === 'fulfilled') { const count = results[4].value.exists() ? results[4].value.size : 0; elements.statPendingWithdrawals.textContent = count; elements.pendingWithdrawalCountBadge.textContent = count; elements.pendingWithdrawalCountBadge.style.display = count > 0 ? 'inline-block' : 'none'; } else { console.error("Err Pending Withdrawals:", results[4].reason); setError(elements.statPendingWithdrawals); elements.pendingWithdrawalCountBadge.textContent = 'Err'; elements.pendingWithdrawalCountBadge.style.display = 'inline-block'; if (results[4].reason?.message?.includes("index")) showStatus(elements.dashboardStatus, "CRITICAL: Pending withdrawal query fail. Add '.indexOn': 'status' to '/withdrawals' rules.", "danger", false); else showStatus(elements.dashboardStatus, `Err Pending Withdrawals: ${results[4].reason?.message}`, "warning"); } if (results[5].status === 'fulfilled') elements.statCompletedWithdrawals.textContent = results[5].value.exists() ? results[5].value.size : 0; else { console.error("Err Completed Withdrawals:", results[5].reason); setError(elements.statCompletedWithdrawals); if (results[5].reason?.message?.includes("index")) showStatus(elements.dashboardStatus, "WARNING: Completed withdrawal query fail. Add '.indexOn': 'status' to '/withdrawals' rules.", "warning", false); } if (results[6].status === 'fulfilled') elements.statRejectedWithdrawals.textContent = results[6].value.exists() ? results[6].value.size : 0; else { console.error("Err Rejected Withdrawals:", results[6].reason); setError(elements.statRejectedWithdrawals); if (results[6].reason?.message?.includes("index")) showStatus(elements.dashboardStatus, "WARNING: Rejected withdrawal query fail. Add '.indexOn': 'status' to '/withdrawals' rules.", "warning", false); } renderNewUserChart(); console.log("Dashboard stats loading complete.", errorsFound ? "Errors occurred." : ""); }
        async function loadGames() { if (!db || !isDesignatedAdmin(currentAdminUser)) return; const gamesRef = ref(db, 'games'); elements.gamesTableBody.innerHTML = tableLoadingPlaceholderHtml(4); gameDataCache = {}; clearStatus(elements.gamesStatus); try { const snapshot = await get(gamesRef); let tableHtml = ''; if (snapshot.exists()) { snapshot.forEach(childSnapshot => { const gameId = childSnapshot.key; const game = childSnapshot.val(); if (game && game.name) { gameDataCache[gameId] = game.name; tableHtml += `<tr><td><img src="${sanitizeHTML(game.imageUrl || 'https://via.placeholder.com/60x40/1E293B/94A3B8?text=N/A')}" alt="${sanitizeHTML(game.name)}" class="preview-img"></td><td>${sanitizeHTML(game.name)}</td><td><small class="text-muted">${sanitizeHTML(gameId)}</small> <i class="bi bi-clipboard copy-btn ms-1" data-target="td:nth-child(3) > small" title="Copy Game ID"></i></td><td class="action-buttons"><button class="btn btn-sm btn-info btn-edit-game" data-id="${sanitizeHTML(gameId)}" title="Edit Game"><i class="bi bi-pencil-square"></i></button><button class="btn btn-sm btn-danger btn-delete-game" data-id="${sanitizeHTML(gameId)}" title="Delete Game"><i class="bi bi-trash"></i></button></td></tr>`; } else { console.warn("Skipping invalid game data:", gameId, game); } }); } elements.gamesTableBody.innerHTML = tableHtml || `<tr><td colspan="4" class="text-center p-3 text-muted">No games found. Add one using the button above.</td></tr>`; if (elements.dashboardSection?.classList.contains('active')) { elements.statTotalGames.textContent = Object.keys(gameDataCache).length; } } catch (error) { console.error("Error loading games:", error); elements.gamesTableBody.innerHTML = `<tr><td colspan="4" class="text-center p-3 text-danger">Error loading games: ${error.message}. Check console & Rules.</td></tr>`; showStatus(elements.gamesStatus, `Error loading games: ${error.message}. Check Rules.`, 'danger', false); if (elements.dashboardSection?.classList.contains('active')) elements.statTotalGames.textContent = 'Error'; } }

        async function loadPromotions() {
            if (!db || !isDesignatedAdmin(currentAdminUser)) return;
            const container = elements.promotionsGridContainer;
            container.innerHTML = `<p class="text-muted">Loading promotions...</p>`;
            clearStatus(elements.promotionsStatus);
            let promoCount = 0;
            try {
                const snapshot = await get(ref(db, 'promotions'));
                let cardsHtml = '';
                if (snapshot.exists()) {
                    promoCount = snapshot.size;
                    snapshot.forEach(childSnapshot => {
                        const promoId = childSnapshot.key;
                        const promo = childSnapshot.val();
                        if (promo && promo.imageUrl) {
                            const displayLink = promo.link ? sanitizeHTML(promo.link) : '';
                            const linkHtml = promo.link
                                ? `<p class="link-label">Action Link:</p><p class="link-url"><a href="${displayLink}" target="_blank" title="${displayLink}">${displayLink}</a></p>`
                                : '<p class="link-label text-muted">No action link provided.</p>';

                            cardsHtml += `
                                <div class="promotion-card" data-id="${promoId}">
                                    <div class="promotion-card-img-container">
                                        <img src="${sanitizeHTML(promo.imageUrl)}" alt="Promotion" class="promotion-card-img">
                                    </div>
                                    <div class="promotion-card-body">
                                        ${linkHtml}
                                    </div>
                                    <div class="promotion-card-footer">
                                        <button class="btn btn-sm btn-outline-info btn-edit-promo" data-id="${sanitizeHTML(promoId)}" title="Edit Promotion">
                                            <i class="bi bi-pencil-fill me-1"></i> Edit
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger btn-delete-promo" data-id="${sanitizeHTML(promoId)}" title="Delete Promotion">
                                            <i class="bi bi-trash-fill me-1"></i> Delete
                                        </button>
                                    </div>
                                </div>`;
                        }
                    });
                }
                container.innerHTML = cardsHtml || `<p class="text-center text-muted p-3 w-100">No promotions found. Add one to get started.</p>`;

                if (elements.dashboardSection?.classList.contains('active')) {
                    elements.statTotalPromotions.textContent = promoCount;
                }
            } catch (error) {
                console.error("Error loading promotions:", error);
                container.innerHTML = `<p class="text-center p-3 text-danger w-100">Error loading promotions: ${error.message}. Check console & Rules.</p>`;
                showStatus(elements.promotionsStatus, `Error loading promotions: ${error.message}. Check Rules.`, 'danger', false);
                if (elements.dashboardSection?.classList.contains('active')) elements.statTotalPromotions.textContent = 'Error';
            }
        }

        async function loadTournaments() {
            if (!db || !isDesignatedAdmin(currentAdminUser)) return;
            const tournamentsRef = ref(db, 'tournaments');
            if (Object.keys(gameDataCache).length === 0) await loadGames();
            const container = elements.tournamentsCardContainer;
            container.innerHTML = tournamentCardPlaceholderHtml(4);
            clearStatus(elements.tournamentsStatus);
            try {
                const snapshot = await get(tournamentsRef);
                let activeCount = 0;
                let finishedCount = 0;
                let cardsHtml = '';
                if (snapshot.exists()) {
                    snapshot.forEach(childSnapshot => {
                        const tournamentId = childSnapshot.key;
                        const t = childSnapshot.val();
                        if (t && t.name && t.gameId && t.status) {
                            const gameName = gameDataCache[t.gameId] || `<small class="text-warning" title="ID: ${t.gameId}">Unknown</small>`;
                            let statusClass = 'secondary';
                            if (t.status === 'ongoing') { statusClass = 'success'; activeCount++; }
                            else if (t.status === 'upcoming') { statusClass = 'info'; activeCount++; }
                            else if (t.status === 'result') { statusClass = 'primary'; finishedCount++; }
                            else if (t.status === 'completed') { statusClass = 'secondary'; finishedCount++; }
                            else if (t.status === 'cancelled') { statusClass = 'danger'; finishedCount++; }

                            const statusBadge = `<span class="status-badge text-bg-${statusClass}">${t.status}</span>`;
                            const registeredCount = t.registeredPlayers ? Object.keys(t.registeredPlayers).length : 0;
                            const maxPlayers = t.maxPlayers > 0 ? ` / ${t.maxPlayers}` : '';
                            const playersDisplay = `${registeredCount}${maxPlayers}`;

                            cardsHtml += `
                                <div class="tournament-card">
                                    <div class="tournament-card-header">
                                        <h5>${sanitizeHTML(t.name)}</h5>
                                        <p>${gameName}</p>
                                    </div>
                                    <div class="tournament-card-body">
                                        <div class="info-grid">
                                            <div class="info-item">
                                                <span class="info-label">Entry Fee</span>
                                                <span class="info-value fee">${formatCurrency(t.entryFee)}</span>
                                            </div>
                                            <div class="info-item">
                                                <span class="info-label">Prize</span>
                                                <span class="info-value prize">${formatCurrency(t.prizePool)}</span>
                                            </div>
                                            <div class="info-item">
                                                <span class="info-label">Start Time</span>
                                                <span class="info-value" style="font-size: 0.9rem;">${formatDate(t.startTime)}</span>
                                            </div>
                                            <div class="info-item">
                                                <span class="info-label">Status</span>
                                                <span class="info-value">${statusBadge}</span>
                                            </div>
                                             <div class="info-item">
                                                <span class="info-label">Players</span>
                                                <span class="info-value">${playersDisplay}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="tournament-card-footer">
                                        <button class="btn btn-sm btn-outline-info btn-edit-tournament" data-id="${sanitizeHTML(tournamentId)}" title="Edit Tournament">
                                            <i class="bi bi-pencil-fill me-1"></i> Edit
                                        </button>
                                        <button class="btn btn-sm btn-outline-secondary btn-view-registered" data-id="${sanitizeHTML(tournamentId)}" data-name="${sanitizeHTML(t.name)}" title="View Registered Players">
                                            <i class="bi bi-people-fill me-1"></i> Reg Players
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger btn-delete-tournament" data-id="${sanitizeHTML(tournamentId)}" title="Delete Tournament">
                                            <i class="bi bi-trash-fill me-1"></i> Delete
                                        </button>
                                    </div>
                                </div>
                            `;
                        } else {
                            console.warn("Skipping invalid tournament data:", tournamentId, t);
                        }
                    });
                }
                container.innerHTML = cardsHtml || `<p class="text-center text-muted p-3 w-100">No tournaments found. Add one using the button above.</p>`;
                if (elements.dashboardSection?.classList.contains('active')) {
                    elements.statActiveTournaments.textContent = activeCount;
                    elements.statFinishedTournaments.textContent = finishedCount;
                }
            } catch (error) {
                console.error("Error loading tournaments:", error);
                container.innerHTML = `<p class="text-center p-3 text-danger w-100">Error loading tournaments: ${error.message}.</p>`;
                showStatus(elements.tournamentsStatus, `Error loading tournaments: ${error.message}. Check Rules.`, 'danger', false);
                if (elements.dashboardSection?.classList.contains('active')) {
                    elements.statActiveTournaments.textContent = 'Error';
                    elements.statFinishedTournaments.textContent = 'Error';
                }
            }
        }

        function renderUsersCards(usersArray) {
            const container = elements.usersSectionContainer;
            let cardsHtml = '';
            if (usersArray?.length > 0) {
                usersArray.sort((a, b) => (a.displayName || '').localeCompare(b.displayName || '', undefined, { sensitivity: 'base' }));
                usersArray.forEach(user => {
                    if (user?.email && user.uid) {
                        const status = user.status || 'active';
                        const statusBadge = `<span class="status-badge text-bg-${status === 'active' ? 'success' : 'danger'}">${status}</span>`;
                        const totalBalance = (Number(user.depositBalance) || 0) + (Number(user.winningCash) || 0) + (Number(user.bonusCash) || 0);

                        cardsHtml += `
                            <div class="user-card" data-uid="${user.uid}" data-name="${(user.displayName || '').toLowerCase()}" data-email="${user.email.toLowerCase()}">
                                <div class="user-card-header">
                                    <h5 class="user-name">${sanitizeHTML(user.displayName || 'N/A')}</h5>
                                    <p class="user-email">${sanitizeHTML(user.email)}</p>
                                </div>
                                <div class="user-card-body">
                                    <div class="user-card-info-row">
                                        <span class="label">Total Balance:</span>
                                        <span class="value balance">${formatCurrency(totalBalance)}</span>
                                    </div>
                                    <div class="user-card-info-row">
                                        <span class="label">Status:</span>
                                        <span class="value">${statusBadge}</span>
                                    </div>
                                </div>
                                <div class="user-card-footer">
                                    <button class="btn btn-sm btn-outline-info btn-view-user" data-id="${sanitizeHTML(user.uid)}" title="View/Edit Details">
                                        <i class="bi bi-eye-fill"></i> View
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger btn-delete-user" data-id="${sanitizeHTML(user.uid)}" title="Delete User (DB Only)">
                                        <i class="bi bi-trash-fill"></i> Delete
                                    </button>
                                </div>
                            </div>
                        `;
                    }
                });
            }
            container.innerHTML = cardsHtml || `<p class="text-center text-muted p-3 w-100">No users found matching criteria.</p>`;
        }

        async function loadUsers() {
            if (!db || !isDesignatedAdmin(currentAdminUser)) return;
            const usersRef = ref(db, 'users');
            elements.usersSectionContainer.innerHTML = `<p class="text-muted">Loading users...</p>`;
            userDataCache = {};
            fullUserDataCache = {};
            clearStatus(elements.usersStatus);
            elements.userSearchInput.value = '';

            const listenerKey = 'users';
            if (dbListeners[listenerKey]) {
                try {
                    off(usersRef, 'value', dbListeners[listenerKey]);
                    delete dbListeners[listenerKey];
                    console.log("Detached previous users listener.");
                } catch(e) { console.warn("Could not detach users listener", e); }
            }

            dbListeners[listenerKey] = onValue(usersRef, (snapshot) => {
                console.log("Users data received via listener.");
                let userCount = 0;
                const usersArray = [];
                fullUserDataCache = {};
                userDataCache = {};

                if (snapshot.exists()) {
                    snapshot.forEach(childSnapshot => {
                        userCount++;
                        const userId = childSnapshot.key;
                        const user = childSnapshot.val();
                        if (user && user.email) {
                            user.uid = userId;
                            fullUserDataCache[userId] = user;
                            userDataCache[userId] = {
                                displayName: user.displayName || 'N/A',
                                email: user.email,
                                status: user.status || 'active',
                                depositBalance: user.depositBalance || 0,
                                winningCash: user.winningCash || 0,
                                bonusCash: user.bonusCash || 0
                            };
                            usersArray.push(user);
                        } else {
                            console.warn("Skipping invalid user data:", userId, user);
                        }
                    });
                }

                renderUsersCards(usersArray);

                if (elements.dashboardSection?.classList.contains('active')) {
                    elements.statTotalUsers.textContent = userCount;
                }
                console.log("Users cards updated. Count:", userCount);
            }, (error) => {
                console.error("Error listening to users:", error);
                elements.usersSectionContainer.innerHTML = `<p class="text-center p-3 text-danger">Error: ${error.message}. Check Rules.</p>`;
                showStatus(elements.usersStatus, `Error listening to users: ${error.message}. Check Rules.`, 'danger', false);
                fullUserDataCache = {};
                userDataCache = {};
                if (elements.dashboardSection?.classList.contains('active')) elements.statTotalUsers.textContent = 'Error';

                try {
                    if (dbListeners[listenerKey]) {
                        off(usersRef, 'value', dbListeners[listenerKey]);
                        delete dbListeners[listenerKey];
                        console.log("Detached failed users listener.");
                    }
                } catch(e) { console.warn("Could not detach failed users listener.", e); }
            });
            console.log("Attached new users listener.");
        }

        async function loadWithdrawals(status = 'pending') {
            if (!db || !isDesignatedAdmin(currentAdminUser)) return;
            const container = elements.withdrawalCardContainer;
            if (!container) {
                console.error(`Withdrawal card container not found!`);
                return;
            }
            const q = query(ref(db, 'withdrawals'), orderByChild('status'), equalTo(status));
            container.innerHTML = `<p class="text-muted w-100">Loading ${status} withdrawals...</p>`;
            clearStatus(elements.withdrawalsStatus);

            try {
                const snapshot = await get(q);
                let cardsHtml = '';
                let count = 0;

                if (snapshot.exists()) {
                    count = snapshot.size;
                    const userIds = new Set();
                    snapshot.forEach(child => {
                        if (child.val()?.userId && !userDataCache[child.val().userId]) {
                            userIds.add(child.val().userId);
                        }
                    });

                    if (userIds.size > 0) {
                        const promises = Array.from(userIds).map(uid =>
                            get(ref(db, `users/${uid}`)).then(us => {
                                if (us.exists()) {
                                    const u = us.val();
                                    userDataCache[uid] = { displayName: u.displayName || 'N/A', email: u.email || uid, status: u.status || 'unknown' };
                                } else {
                                    userDataCache[uid] = { displayName: 'Unknown User', email: uid, status: 'deleted' };
                                }
                            })
                        );
                        await Promise.allSettled(promises);
                    }

                    const withdrawals = [];
                    snapshot.forEach(child => withdrawals.push({ id: child.key, ...child.val() }));
                    withdrawals.sort((a, b) => (b.requestTimestamp || 0) - (a.requestTimestamp || 0));

                    withdrawals.forEach(w => {
                        if (w && w.userId && w.amount != null) {
                            const user = userDataCache[w.userId] || { displayName: 'Loading...', email: w.userId, status: 'unknown' };
                            const methodInfo = sanitizeHTML(w.methodDetails?.accountInfo || 'N/A');

                            let footerHtml = '';
                            if (status === 'pending') {
                                footerHtml = `
                                <div class="withdrawal-card-footer">
                                    <button class="btn btn-sm btn-danger btn-reject-withdrawal" data-id="${sanitizeHTML(w.id)}" data-userid="${sanitizeHTML(w.userId)}" title="Reject">
                                        <i class="bi bi-x-circle"></i> Reject
                                    </button>
                                    <button class="btn btn-sm btn-success btn-approve-withdrawal" data-id="${sanitizeHTML(w.id)}" data-userid="${sanitizeHTML(w.userId)}" title="Approve">
                                        <i class="bi bi-check-circle"></i> Approve
                                    </button>
                                </div>`;
                            } else {
                                 const note = status === 'completed' ? (w.adminNote || 'Approved') : (w.rejectReason || 'Rejected');
                                 footerHtml = `
                                 <div class="info-row mt-3 pt-3 border-top border-secondary">
                                     <span class="label"><i class="bi bi-clock-history"></i> Processed:</span>
                                     <span class="value">${formatDate(w.processedAt)}</span>
                                 </div>
                                 <div class="info-row">
                                     <span class="label"><i class="bi bi-info-circle"></i> Note:</span>
                                     <span class="value">${sanitizeHTML(note)}</span>
                                 </div>
                                 `;
                            }

                            cardsHtml += `
                            <div class="withdrawal-card" id="withdrawal-card-${w.id}" data-id="${w.id}">
                                <div class="withdrawal-card-header">
                                    <div class="withdrawal-card-user">
                                        <p class="name">${sanitizeHTML(user.displayName)}</p>
                                        <p class="email">${sanitizeHTML(user.email)}</p>
                                    </div>
                                    <div class="withdrawal-card-amount">${formatCurrency(w.amount)}</div>
                                </div>
                                <div class="withdrawal-card-body">
                                    <div class="info-row">
                                        <span class="label"><i class="bi bi-calendar-event"></i> Requested:</span>
                                        <span class="value">${formatDate(w.requestTimestamp)}</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="label"><i class="bi bi-credit-card"></i> Method:</span>
                                        <span class="value">${sanitizeHTML(w.methodDetails?.methodName || w.method || 'N/A')}</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="label"><i class="bi bi-hash"></i> Details:</span>
                                        <span class="value method" title="${methodInfo}">${methodInfo}</span>
                                    </div>
                                </div>
                                ${footerHtml}
                            </div>`;
                        }
                    });
                }

                container.innerHTML = cardsHtml || `<p class="text-center text-muted p-3 w-100">No ${status} withdrawals found.</p>`;

            } catch (error) {
                console.error(`Error loading ${status} withdrawals:`, error);
                container.innerHTML = `<p class="text-center p-3 text-danger w-100">Error loading withdrawals: ${error.message}. Check Rules/Index.</p>`;
                showStatus(elements.withdrawalsStatus, `Error loading ${status} withdrawals: ${error.message}. Check Rules/Index.`, 'danger', false);
            }
        }
        
        //==================================================
        //========= NEW STAFF MANAGEMENT FUNCTIONS =========
        //==================================================

        async function loadStaff() {
            if (!db || !isDesignatedAdmin(currentAdminUser)) return;
            const container = elements.staffCardContainer;
            container.innerHTML = `<p class="text-muted">Loading staff members...</p>`;
            clearStatus(elements.staffStatus);
            
            try {
                const staffRef = ref(db, 'staff');
                const snapshot = await get(staffRef);
                let cardsHtml = '';
                
                if (snapshot.exists()) {
                    snapshot.forEach(childSnapshot => {
                        const staffId = childSnapshot.key;
                        const staff = childSnapshot.val();
                        
                        const isChecked = staff.status === 'active';
                        
                        cardsHtml += `
                        <div class="staff-card" data-id="${staffId}">
                            <div class="staff-card-body">
                                <h5 class="staff-email">${sanitizeHTML(staff.email)}</h5>
                                <p class="staff-created">Created: ${formatDate(staff.createdAt)}</p>
                                
                                <div class="form-check form-switch form-check-lg">
                                    <input class="form-check-input staff-status-switch" type="checkbox" role="switch" id="staffSwitch-${staffId}" data-id="${staffId}" ${isChecked ? 'checked' : ''}>
                                    <label class="form-check-label" for="staffSwitch-${staffId}">${isChecked ? 'Active' : 'Deactivated'}</label>
                                </div>
                            </div>
                            <div class="staff-card-footer">
                                <button class="btn btn-sm btn-outline-danger btn-delete-staff" data-id="${staffId}" title="Delete Staff Member">
                                    <i class="bi bi-trash-fill me-1"></i> Delete
                                </button>
                            </div>
                        </div>
                        `;
                    });
                }
                
                container.innerHTML = cardsHtml || `<p class="text-center text-muted p-3 w-100">No staff members found. Add one to get started.</p>`;
                
            } catch (error) {
                console.error("Error loading staff:", error);
                container.innerHTML = `<p class="text-center p-3 text-danger">Error loading staff: ${error.message}.</p>`;
                showStatus(elements.staffStatus, `Error loading staff: ${error.message}. Check Rules.`, 'danger', false);
            }
        }

        async function saveNewStaff(event) {
            event.preventDefault();
            if (!db || !isDesignatedAdmin(currentAdminUser)) return;

            const statusEl = elements.addStaffStatus;
            clearStatus(statusEl);

            const email = elements.newStaffEmailInput.value.trim();
            const password = elements.newStaffPasswordInput.value;

            if (!email || !password) {
                showStatus(statusEl, "Email and Password are required.", "warning");
                return;
            }
             if (password.length < 6) {
                showStatus(statusEl, "Password must be at least 6 characters.", "warning");
                return;
            }
            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                showStatus(statusEl, "Invalid Email format.", "warning");
                return;
            }

            toggleButtonLoading(elements.saveNewStaffBtn, true);

            try {
                // Check if staff email already exists
                const staffQuery = query(ref(db, 'staff'), orderByChild('email'), equalTo(email));
                const snapshot = await get(staffQuery);
                if (snapshot.exists()) {
                    throw new Error(`A staff member with the email "${email}" already exists.`);
                }

                const newStaffData = {
                    email: email,
                    password: password, // Note: Storing password in plaintext is not secure. Hashing is recommended for production.
                    status: 'active',
                    createdAt: serverTimestamp()
                };

                const newStaffRef = push(ref(db, 'staff'));
                await set(newStaffRef, newStaffData);

                showStatus(elements.staffStatus, `Staff member "${email}" created successfully!`, "success");
                elements.addStaffForm.reset();
                getModalInstance(elements.addStaffModalEl)?.hide();
                loadStaff();

            } catch (error) {
                console.error("Error saving staff:", error);
                showStatus(statusEl, `Error: ${error.message}`, 'danger', false);
            } finally {
                toggleButtonLoading(elements.saveNewStaffBtn, false);
            }
        }

        async function toggleStaffStatus(staffId, newStatus) {
            if (!staffId || !newStatus) return;
            
            showLoader(true);
            try {
                await update(ref(db, `staff/${staffId}`), { status: newStatus });
                showStatus(elements.staffStatus, `Staff status updated successfully.`, 'success', 3000);
                loadStaff(); // Reload to reflect changes
            } catch (error) {
                console.error("Error toggling staff status:", error);
                showStatus(elements.staffStatus, `Error updating status: ${error.message}`, 'danger', false);
                loadStaff(); // Reload to reset the toggle to its actual state
            } finally {
                showLoader(false);
            }
        }

        async function deleteStaff(staffId) {
            if (!staffId) return;

            showConfirmationModal(
                'Delete Staff',
                'Are you sure you want to permanently delete this staff member? This cannot be undone.',
                async () => {
                    showLoader(true);
                    try {
                        await remove(ref(db, `staff/${staffId}`));
                        showStatus(elements.staffStatus, 'Staff member deleted.', 'success', 3000);
                        loadStaff();
                    } catch (error) {
                        console.error("Error deleting staff:", error);
                        showStatus(elements.staffStatus, `Error: ${error.message}`, 'danger', false);
                    } finally {
                        showLoader(false);
                    }
                }
            );
        }
        
        //==================================================
        //======= END OF NEW STAFF MANAGEMENT FUNCTIONS ====
        //==================================================

        async function loadSettings() {
             if (!db || !isDesignatedAdmin(currentAdminUser)) return;
             console.log("Loading settings...");
             elements.appSettingsForm?.querySelectorAll('input, textarea, button').forEach(el => el.disabled = true);
             clearStatus(elements.settingsStatus);
             try {
                 const snapshot = await get(ref(db, 'settings'));
                 if (snapshot.exists()) {
                     appSettings = snapshot.val() || {};
                     elements.settingLogoUrlInput.value = appSettings.logoUrl || '';
                     elements.settingAppNameInput.value = appSettings.appName || '';
                     elements.settingSignupBonusInput.value = appSettings.signupBonus ?? 10;
                     elements.settingMinWithdrawInput.value = appSettings.minWithdraw ?? 50;
                     elements.settingReferralBonusInput.value = appSettings.referralBonus ?? 5;
                     elements.settingSupportContactInput.value = appSettings.supportContact || '';
                     elements.settingUpiDetailsInput.value = appSettings.upiDetails || '';
                     elements.settingQrCodeUrlInput.value = appSettings.qrCodeUrl || '';
                     elements.settingLoginLogoUrlInput.value = appSettings.loginLogoUrl || '';

                    const liveSupportAdmin = appSettings.liveSupportAdmin || {};
                    elements.settingLiveSupportNameInput.value = liveSupportAdmin.displayName || '';
                    elements.settingLiveSupportLogoUrlInput.value = liveSupportAdmin.photoURL || '';
                    elements.settingLiveSupportTitleInput.value = appSettings.liveSupportTitle || '';

                     elements.settingPolicyPrivacyInput.value = appSettings.policyPrivacy || '';
                     elements.settingPolicyTermsInput.value = appSettings.policyTerms || '';
                     elements.settingPolicyRefundInput.value = appSettings.policyRefund || '';
                     elements.settingPolicyFairPlayInput.value = appSettings.policyFairPlay || '';
                     if(elements.adminHeaderLogo) { const logoUrl = appSettings.logoUrl; elements.adminHeaderLogo.src = logoUrl || 'https://via.placeholder.com/35/1E293B/94A3B8?text=L'; elements.adminHeaderLogo.style.display = logoUrl ? 'inline-block' : 'none'; elements.adminHeaderLogo.alt = appSettings.appName ? `${appSettings.appName} Logo` : 'Logo'; }
                     document.title = `${appSettings.appName || 'Gaming Tournament'} - Admin Panel`;

                     applyThemeToAdminPanel(appSettings.theme);

                     console.log("Settings loaded and applied.");
                 } else {
                     console.log("No settings found.");
                     showStatus(elements.settingsStatus, "No settings found. Please configure.", "info", false);
                     elements.appSettingsForm.reset(); appSettings = {};
                     if(elements.adminHeaderLogo) elements.adminHeaderLogo.style.display='none'; document.title = 'Admin Panel';
                 }
             } catch (error) {
                 console.error("Error loading settings:", error);
                 showStatus(elements.settingsStatus, `Error loading settings: ${error.message}. Check Rules.`, "danger", false);
                 appSettings = {}; if(elements.adminHeaderLogo) elements.adminHeaderLogo.style.display = 'none'; document.title = 'Admin Panel';
             } finally {
                 elements.appSettingsForm?.querySelectorAll('input, textarea, button').forEach(el => el.disabled = false);
             }
         }

        async function loadDepositRequests() {
            if (!db || !isDesignatedAdmin(currentAdminUser)) return;

            const container = elements.pendingDepositsCardContainer;
            if (!container) {
                console.error(`Deposit card container not found.`);
                return;
            }
            const q = query(ref(db, 'deposits'), orderByChild('status'), equalTo('pending'));
            container.innerHTML = `<p class="text-secondary">Loading pending deposits...</p>`;
            clearStatus(elements.depositsStatus);

            try {
                const snapshot = await get(q);
                let cardsHtml = '';
                if (snapshot.exists()) {
                    const deposits = [];
                    snapshot.forEach(child => deposits.push({ id: child.key, ...child.val() }));
                    deposits.sort((a,b) => (b.timestamp || 0) - (a.timestamp || 0));

                    for (const d of deposits) {
                        let user = userDataCache[d.userId];
                        if(!user) {
                            const userSnap = await get(ref(db, `users/${d.userId}`));
                            if (userSnap.exists()) {
                                const u = userSnap.val();
                                userDataCache[d.userId] = { displayName: u.displayName || u.email, email: u.email };
                                user = userDataCache[d.userId];
                            } else {
                                user = { displayName: 'Unknown User', email: d.userId };
                            }
                        }

                        cardsHtml += `
                        <div class="deposit-card" id="deposit-card-${d.id}" data-id="${d.id}" data-userid="${d.userId}" data-amount="${d.amount}" data-screenshot-url="${sanitizeHTML(d.screenshotUrl || '')}">
                            <div class="deposit-card-header">
                                <div class="deposit-card-user">
                                    <span class="name">${sanitizeHTML(user.displayName)}</span>
                                    <span class="email">${sanitizeHTML(user.email)}</span>
                                </div>
                                <div class="deposit-card-amount">₹${d.amount}</div>
                            </div>
                            <div class="deposit-card-body">
                                <div class="info-row">
                                    <span class="label">Time:</span>
                                    <span class="value">${formatDate(d.timestamp)}</span>
                                </div>
                                <div class="info-row">
                                    <span class="label">UTR:</span>
                                    <span class="value">${sanitizeHTML(d.utr || 'N/A')}</span>
                                </div>
                                <div class="info-row">
                                    <span class="label">Method:</span>
                                    <span class="value">${sanitizeHTML(d.paymentMethod || 'N/A')}</span>
                                </div>
                            </div>
                            <div class="deposit-card-footer">
                                ${d.screenshotUrl ? `<button class="btn btn-sm btn-outline-info btn-view-screenshot"><i class="bi bi-image"></i> View Screenshot</button>` : ''}
                                <button class="btn btn-sm btn-danger btn-reject-deposit"><i class="bi bi-x-circle"></i> Reject</button>
                                <button class="btn btn-sm btn-success btn-approve-deposit"><i class="bi bi-check-circle"></i> Approve</button>
                            </div>
                        </div>
                        `;
                    }
                }
                container.innerHTML = cardsHtml || `<div class="col-12"><p class="text-center text-muted p-3">No pending deposits found.</p></div>`;
            } catch (error) {
                console.error(`Error loading deposits:`, error);
                container.innerHTML = `<div class="col-12"><p class="text-center text-danger p-3">Error: ${error.message}.</p></div>`;
                showStatus(elements.depositsStatus, `Error loading deposits: ${error.message}.`, 'danger', false);
            }
        }

        async function loadReferrals(status = 'pending') {
            if (!db || !isDesignatedAdmin(currentAdminUser)) return;

            const targetTableId = status === 'pending' ? 'pendingReferralsTableBody' : 'completedReferralsTableBody';
            const tableBody = getElement(targetTableId);
            if (!tableBody) return;

            const cols = status === 'pending' ? 4 : 4;
            tableBody.innerHTML = tableLoadingPlaceholderHtml(cols);

            try {
                const q = query(ref(db, 'pendingReferrals'), orderByChild('status'), equalTo(status));
                const snapshot = await get(q);
                let tableHtml = '';

                if (snapshot.exists()) {
                    const referrals = [];
                    snapshot.forEach(child => referrals.push({ id: child.key, ...child.val() }));
                    referrals.sort((a,b) => (b.timestamp || 0) - (a.timestamp || 0));

                    for(const refData of referrals) {
                        const referrerName = refData.referrerEmail || refData.referrerUid;
                        const referredName = refData.referredEmail || refData.referredUid;

                        if (status === 'pending') {
                             tableHtml += `<tr id="ref-row-${refData.id}">
                                <td>${formatDate(refData.timestamp)}</td>
                                <td>${sanitizeHTML(referrerName)}</td>
                                <td>${sanitizeHTML(referredName)}</td>
                                <td class="action-buttons"><button class="btn btn-sm btn-success btn-credit-referral" data-id="${refData.id}" data-referrer-uid="${refData.referrerUid}" title="Credit Bonus"><i class="bi bi-gift-fill"></i> Credit</button></td>
                            </tr>`;
                        } else {
                            tableHtml += `<tr>
                                <td>${formatDate(refData.creditedAt)}</td>
                                <td>${sanitizeHTML(referrerName)}</td>
                                <td>${sanitizeHTML(referredName)}</td>
                                <td class="text-success">${formatCurrency(refData.bonusAmount)}</td>
                            </tr>`;
                        }
                    }
                }

                tableBody.innerHTML = tableHtml || `<tr><td colspan="${cols}" class="text-center p-3 text-muted">No ${status} referrals found.</td></tr>`;

            } catch (error) {
                 console.error(`Error loading ${status} referrals:`, error);
                 tableBody.innerHTML = `<tr><td colspan="${cols}" class="text-center p-3 text-danger">Error: ${error.message}. Check Rules/Index.</td></tr>`;
            }
        }
        
        //============================================
        //========= NEW PROMO CODE FUNCTIONS =========
        //============================================
        
        /**
         * Generates an 8-character alphanumeric random string.
         * @returns {string} The generated random code.
         */
        function generateRandomCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < 8; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        /**
         * Validates form, checks for code uniqueness, and pushes a new promo code to Firebase.
         */
                async function publishPromoCode(event) {
            event.preventDefault();
            if (!db || !isDesignatedAdmin(currentAdminUser)) return;
            
            const statusEl = elements.promoCodeStatus;
            clearStatus(statusEl);

            const amount = parseFloat(elements.promoCodeAmountInput.value);
            const balanceType = elements.promoCodeBalanceTypeSelect.value;
            const usageLimit = parseInt(elements.promoCodeUsageLimitInput.value, 10);
            const code = elements.promoCodeInput.value.trim();

            if (!code || isNaN(amount) || amount <= 0 || !balanceType || isNaN(usageLimit) || usageLimit <= 0) {
                showStatus(statusEl, "All fields are required and must contain valid values.", "warning");
                return;
            }
            
            toggleButtonLoading(elements.publishPromoCodeBtn, true);
            
            try {
                // Check if code already exists
                const codeQuery = query(ref(db, 'promoCodes'), orderByChild('code'), equalTo(code));
                const snapshot = await get(codeQuery);
                if (snapshot.exists()) {
                    throw new Error(`Promo code "${code}" already exists.`);
                }
                
                const promoCodeData = {
                    code: code,
                    amount: amount,
                    balanceType: balanceType,
                    usageLimit: usageLimit, // <-- इसे ठीक कर दिया गया है
                    active: true,
                    createdAt: serverTimestamp(),
                    usedBy: {}
                };
                
                await push(ref(db, 'promoCodes'), promoCodeData);
                showStatus(statusEl, `Promo code "${code}" published successfully!`, "success");
                elements.promoCodeForm.reset();

            } catch (error) {
                console.error("Error publishing promo code:", error);
                showStatus(statusEl, `Error: ${error.message}`, "danger", false);
            } finally {
                toggleButtonLoading(elements.publishPromoCodeBtn, false);
            }
        }
        
        /**
         * Fetches and listens for real-time changes to promo codes.
         */
        function loadPromoCodes() {
            if (!db || !isDesignatedAdmin(currentAdminUser)) return;
            
            const promoCodesRef = ref(db, 'promoCodes');
            
            if (dbListeners.promoCodes) {
                off(promoCodesRef, 'value', dbListeners.promoCodes);
            }

            dbListeners.promoCodes = onValue(promoCodesRef, (snapshot) => {
                const activeCodes = [];
                const inactiveCodes = [];
                if (snapshot.exists()) {
                    snapshot.forEach(childSnapshot => {
                        const codeData = { id: childSnapshot.key, ...childSnapshot.val() };
                        if (codeData.active) {
                            activeCodes.push(codeData);
                        } else {
                            inactiveCodes.push(codeData);
                        }
                    });
                }
                
                // Sort by creation date, newest first
                activeCodes.sort((a, b) => b.createdAt - a.createdAt);
                inactiveCodes.sort((a, b) => b.createdAt - a.createdAt);

                renderPromoCodeList(activeCodes, elements.activePromoCodesList, "No active codes found.");
                renderPromoCodeList(inactiveCodes, elements.inactivePromoCodesList, "No inactive codes found.");
                
            }, (error) => {
                console.error("Error loading promo codes:", error);
                showStatus(elements.promoCodeStatus, `Failed to load promo codes: ${error.message}`, 'danger', false);
            });
        }
        
        /**
         * Renders a list of promo code cards into a given container element.
         */
        function renderPromoCodeList(codes, container, emptyMessage) {
            if (!container) return;

            if (codes.length === 0) {
                container.innerHTML = `<p class="text-center text-muted p-3">${emptyMessage}</p>`;
                return;
            }
            
            let html = '';
            codes.forEach(code => {
                const usedCount = code.usedBy ? Object.keys(code.usedBy).length : 0;
                const usageLimit = code.usageLimit || 0;
                const progressPercent = usageLimit > 0 ? (usedCount / usageLimit) * 100 : 0;
                
                const balanceTypeMap = {
                    depositBalance: 'Deposit Balance',
                    winningCash: 'Winning Balance',
                    bonusCash: 'Bonus Balance'
                };
                
                html += `
                <div class="promo-code-card" data-id="${code.id}">
                    <div class="promo-code-card-header">
                        <div>
                            <h5 class="promo-code-card-code">${sanitizeHTML(code.code)}</h5>
                            <p class="promo-code-card-amount">
                                <strong>${formatCurrency(code.amount)}</strong> in ${balanceTypeMap[code.balanceType] || 'N/A'}
                            </p>
                        </div>
                        <span class="badge ${code.active ? 'text-bg-success' : 'text-bg-secondary'}">${code.active ? 'Active' : 'Inactive'}</span>
                    </div>
                    <div class="usage-progress-container">
                        <div class="usage-progress-text">
                            <span>Used: ${usedCount} / ${usageLimit}</span>
                            <span>${progressPercent.toFixed(0)}%</span>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-warning" role="progressbar" style="width: ${progressPercent}%;" aria-valuenow="${progressPercent}" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                    </div>
                    <div class="promo-code-card-actions">
                        <button class="btn btn-sm ${code.active ? 'btn-outline-warning' : 'btn-outline-success'} btn-toggle-active" data-id="${code.id}" data-current-status="${code.active}">
                            ${code.active ? 'Deactivate' : 'Activate'}
                        </button>
                        <button class="btn btn-sm btn-outline-danger btn-delete-code" data-id="${code.id}" data-code="${sanitizeHTML(code.code)}">
                            <i class="bi bi-trash"></i> Delete
                        </button>
                    </div>
                </div>`;
            });
            container.innerHTML = html;
        }

        //============================================
        //======= END OF NEW PROMO CODE FUNCTIONS ======
        //============================================

        const IMGBB_API_KEY = '19610b2deaf2d130be5137a29dda76ac';
        async function uploadToImgBB(file, statusElement) { if (!file) throw new Error("File not selected."); if (!IMGBB_API_KEY || IMGBB_API_KEY === 'YOUR_IMGBB_API_KEY') { console.error("ImgBB API Key missing or is a placeholder!"); throw new Error("ImgBB API Key not set."); } const formData = new FormData(); formData.append('image', file); if (statusElement) { statusElement.textContent = 'Uploading...'; statusElement.style.color = 'var(--text-secondary)'; statusElement.style.display = 'block'; } try { const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: 'POST', body: formData }); if (!response.ok) { let errorMsg = `ImgBB upload failed: HTTP ${response.status}`; try { const errorData = await response.json(); errorMsg += ` - ${errorData?.error?.message || response.statusText}`; } catch (e) {} throw new Error(errorMsg); } const data = await response.json(); if (data.success) { console.log('ImgBB upload successful. URL:', data.data.url); if (statusElement) statusElement.textContent = 'Upload complete!'; return data.data.url; } else { console.error('ImgBB upload failed:', data); throw new Error(`ImgBB upload failed: ${data.error?.message || 'Unknown error'}`); } } catch (error) { console.error('ImgBB Fetch error:', error); if (statusElement) { statusElement.textContent = `Upload Error: ${error.message}`; statusElement.style.color = 'var(--danger-color)'; } throw error; } }
        async function saveGame() { if (!db || !isDesignatedAdmin(currentAdminUser)) return; const gameId = elements.gameEditId.value; const isEditing = !!gameId; const name = elements.gameNameInput.value.trim(); const imageUrlInput = elements.gameImageUrlInput.value.trim(); const imageFile = elements.gameImageFileInput.files[0]; const statusEl = elements.gameStatus; const imgbbStatusEl = elements.gameForm?.querySelector('.imgbb-upload-status'); clearStatus(statusEl); if (imgbbStatusEl) { imgbbStatusEl.textContent = ''; imgbbStatusEl.style.display = 'none'; } if (!name) { showStatus(statusEl, "Game Name is required.", "warning"); return; } if (!imageUrlInput && !imageFile && !isEditing) { showStatus(statusEl, "Image URL or File Upload required for new game.", "warning"); return; } if (!imageUrlInput && !imageFile && isEditing) { showStatus(statusEl, "Image URL cannot be empty when editing.", "warning"); return; } showLoader(true); elements.saveGameBtn.disabled = true; let finalImageUrl = imageUrlInput; try { if (imageFile) { finalImageUrl = await uploadToImgBB(imageFile, imgbbStatusEl); } if (!finalImageUrl) { throw new Error("Image URL is missing after potential upload."); } const gameData = { name: name, imageUrl: finalImageUrl }; if (isEditing) { gameData.updatedAt = serverTimestamp(); const gameRef = ref(db, `games/${gameId}`); await update(gameRef, gameData); console.log("Game updated successfully:", gameId); showStatus(elements.gamesStatus, "Game updated successfully!", "success", 3000); } else { gameData.createdAt = serverTimestamp(); const newGameRef = push(ref(db, 'games')); await set(newGameRef, gameData); console.log("Game added successfully, key:", newGameRef.key); showStatus(elements.gamesStatus, "Game added successfully!", "success", 3000); } elements.gameForm.reset(); elements.gameEditId.value = ''; if (imgbbStatusEl) { imgbbStatusEl.textContent = ''; imgbbStatusEl.style.display = 'none'; } getModalInstance(elements.gameModalEl)?.hide(); loadGames(); } catch (error) { console.error("Error saving game:", error); showStatus(statusEl, `Error saving game: ${error.message}. Check console & Rules.`, "danger", false); if (imgbbStatusEl && !imgbbStatusEl.textContent.includes('Error')) { imgbbStatusEl.style.display = 'none'; } } finally { showLoader(false); elements.saveGameBtn.disabled = false; } }
        async function savePromotion() { if (!db || !isDesignatedAdmin(currentAdminUser)) return; const promoId = elements.promotionEditId.value; const isEditing = !!promoId; const promoLink = elements.promoLinkInput.value.trim(); const imageUrlInput = elements.promoImageUrlInput.value.trim(); const imageFile = elements.promoImageFileInput.files[0]; const statusEl = elements.promotionStatus; const imgbbStatusEl = elements.promotionForm?.querySelector('.imgbb-upload-status'); clearStatus(statusEl); if (imgbbStatusEl) { imgbbStatusEl.textContent = ''; imgbbStatusEl.style.display = 'none'; } if (!imageUrlInput && !imageFile && !isEditing) { showStatus(statusEl, "Image URL or File Upload required for new promotion.", "warning"); return; } if (!imageUrlInput && !imageFile && isEditing) { showStatus(statusEl, "Image URL cannot be empty when editing.", "warning"); return; } showLoader(true); elements.savePromotionBtn.disabled = true; let finalImageUrl = imageUrlInput; try { if (imageFile) { finalImageUrl = await uploadToImgBB(imageFile, imgbbStatusEl); } if (!finalImageUrl) { throw new Error("Image URL is missing after potential upload."); } const promoData = { imageUrl: finalImageUrl, link: promoLink || null }; if (isEditing) { promoData.updatedAt = serverTimestamp(); const promoRef = ref(db, `promotions/${promoId}`); await update(promoRef, promoData); console.log("Promotion updated successfully:", promoId); showStatus(elements.promotionsStatus, "Promotion updated successfully!", "success", 3000); } else { promoData.createdAt = serverTimestamp(); const newPromoRef = push(ref(db, 'promotions')); await set(newPromoRef, promoData); console.log("Promotion added successfully, key:", newPromoRef.key); showStatus(elements.promotionsStatus, "Promotion added successfully!", "success", 3000); } elements.promotionForm.reset(); elements.promotionEditId.value = ''; if (imgbbStatusEl) { imgbbStatusEl.textContent = ''; imgbbStatusEl.style.display = 'none'; } getModalInstance(elements.promotionModalEl)?.hide(); loadPromotions(); } catch (error) { console.error("Error saving promotion:", error); showStatus(statusEl, `Error saving promotion: ${error.message}. Check console & Rules.`, "danger", false); if (imgbbStatusEl && !imgbbStatusEl.textContent.includes('Error')) { imgbbStatusEl.style.display = 'none'; } } finally { showLoader(false); elements.savePromotionBtn.disabled = false; } }

        async function saveTournament(event) {
            event.preventDefault();
            if (!db || !isDesignatedAdmin(currentAdminUser)) return;
            const statusEl = elements.addTournamentStatus;
            clearStatus(statusEl);
            const gameId = elements.tournamentGameSelect.value;
            const name = elements.tournamentNameInput.value.trim();
            const startTimeStr = elements.tournamentStartTimeInput.value;
            if (!gameId || !name || !startTimeStr) {
                showStatus(statusEl, "Game, Name, and Start Time are required.", "warning");
                return;
            }
            let startTimeTimestamp;
            try {
                startTimeTimestamp = new Date(startTimeStr).getTime();
                if (isNaN(startTimeTimestamp)) throw new Error('Invalid Date');
            } catch (e) {
                showStatus(statusEl, "Invalid Start Date & Time.", "warning");
                return;
            }
            const tournamentData = {
                gameId: gameId,
                name: name,
                startTime: startTimeTimestamp,
                status: elements.tournamentStatusSelect.value,
                entryFee: parseFloat(elements.tournamentEntryFeeInput.value) || 0,
                prizePool: parseFloat(elements.tournamentPrizePoolInput.value) || 0,
                perKillPrize: parseFloat(elements.tournamentPerKillInput.value) || 0,
                maxPlayers: parseInt(elements.tournamentMaxPlayersInput.value) || 0,
                bannerUrl: elements.tournamentBannerUrlInput.value.trim() || null,
                mode: elements.tournamentModeSelect.value,
                tags: elements.tournamentTagsInput.value.split(',').map(tag => tag.trim()).filter(tag => tag),
                description: elements.tournamentDescriptionInput.value.trim(),
                roomId: elements.tournamentRoomIdInput.value.trim() || null,
                roomPassword: elements.tournamentRoomPasswordInput.value.trim() || null,
                showIdPass: elements.tournamentShowIdPassCheckbox.checked,
                updatedAt: serverTimestamp()
            };
            showLoader(true);
            elements.saveTournamentBtn.disabled = true;
            try {
                if (currentEditingTournamentId) {
                    const tRef = ref(db, `tournaments/${currentEditingTournamentId}`);

                    const existingSnap = await get(tRef);
                    const existingTournament = existingSnap.exists() ? existingSnap.val() : {};

                    if ((existingTournament.status === 'result' || existingTournament.status === 'completed') && tournamentData.status === 'upcoming') {
                        tournamentData.winningsCredited = null;
                        tournamentData.registeredPlayers = null;
                        console.log(`Resetting tournament ${currentEditingTournamentId}. Winnings flag and players cleared.`);
                    } else {
                        if (existingTournament.registeredPlayers) {
                            tournamentData.registeredPlayers = existingTournament.registeredPlayers;
                        }
                    }

                    await update(tRef, tournamentData);
                    console.log("Tournament updated:", currentEditingTournamentId);
                    showStatus(elements.tournamentsStatus, "Tournament updated successfully!", "success", 3000);
                } else {
                    tournamentData.createdAt = serverTimestamp();
                    const newRef = push(ref(db, 'tournaments'));
                    await set(newRef, tournamentData);
                    console.log("Tournament added:", newRef.key);
                    showStatus(elements.tournamentsStatus, "Tournament added successfully!", "success", 3000);
                }
                elements.tournamentForm.reset();
                currentEditingTournamentId = null;
                getModalInstance(elements.addTournamentModalEl)?.hide();
                loadTournaments();
                loadDashboardStats();
            } catch (error) {
                console.error("Error saving tournament:", error);
                showStatus(statusEl, `Error: ${error.message}. Check Rules.`, "danger", false);
            } finally {
                showLoader(false);
                elements.saveTournamentBtn.disabled = false;
            }
        }

        async function deleteGame(gameId) { if (!db || !gameId || !isDesignatedAdmin(currentAdminUser)) return; if (!confirm(`DELETE Game ID: ${gameId}? Removes DB entry. Image on ImgBB NOT deleted. OK?`)) return; showLoader(true); const statusEl = elements.gamesStatus; clearStatus(statusEl); try { await remove(ref(db, `games/${gameId}`)); console.log("Game deleted from DB:", gameId); delete gameDataCache[gameId]; showStatus(statusEl, "Game data deleted.", "success", 3000); loadGames(); loadDashboardStats(); } catch (error) { console.error("Error deleting game:", error); showStatus(statusEl, `Error deleting game: ${error.message}. Check Rules.`, "danger", false); } finally { showLoader(false); } }
        async function deletePromotion(promoId) { if (!db || !promoId || !isDesignatedAdmin(currentAdminUser)) return; if (!confirm(`DELETE Promotion ID: ${promoId}? Removes DB entry. Image on ImgBB NOT deleted. OK?`)) return; showLoader(true); const statusEl = elements.promotionsStatus; clearStatus(statusEl); try { await remove(ref(db, `promotions/${promoId}`)); console.log("Promotion deleted from DB:", promoId); showStatus(statusEl, "Promotion data deleted.", "success", 3000); loadPromotions(); loadDashboardStats(); } catch (error) { console.error("Error deleting promotion:", error); showStatus(statusEl, `Error deleting promotion: ${error.message}. Check Rules.`, "danger", false); } finally { showLoader(false); } }
        async function deleteTournament(tournamentId) { if (!db || !tournamentId || !isDesignatedAdmin(currentAdminUser)) return; if (!confirm(`DELETE Tournament ID: ${tournamentId}? Cannot be undone.`)) return; showLoader(true); const statusEl = elements.tournamentsStatus; clearStatus(statusEl); try { await remove(ref(db, `tournaments/${tournamentId}`)); console.log("Tournament deleted:", tournamentId); showStatus(statusEl, "Tournament deleted.", "success", 3000); loadTournaments(); loadDashboardStats(); } catch (error) { console.error("Error deleting tournament:", error); showStatus(statusEl, `Error: ${error.message}. Check Rules.`, "danger", false); } finally { showLoader(false); } }

        async function saveNewUser() {
            if (!auth || !db || !isDesignatedAdmin(currentAdminUser)) return;
            const statusEl = elements.addUserStatus;
            clearStatus(statusEl);
            const name = elements.newUserNameInput.value.trim();
            const email = elements.newUserEmailInput.value.trim();
            const password = elements.newUserPasswordInput.value;
            const initialBalanceStr = elements.newUserInitialBalanceInput.value;
            if (!name || !email || !password) {
                showStatus(statusEl, "Name, Email, Password required.", "warning");
                return;
            }
            if (password.length < 6) {
                showStatus(statusEl, "Password min 6 chars.", "warning");
                return;
            }
            const initialBalance = parseFloat(initialBalanceStr) || 0;
            if (initialBalance < 0) {
                showStatus(statusEl, "Initial Balance cannot be negative.", "warning");
                return;
            }
            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                showStatus(statusEl, "Invalid Email format.", "warning");
                return;
            }
            showLoader(true);
            elements.saveNewUserBtn.disabled = true;
            try {
                const referralCode = Math.random().toString(36).substring(2, 10).toUpperCase();
                const cred = await createUserWithEmailAndPassword(auth, email, password);
                const uid = cred.user.uid;
                console.log("User created in Auth:", uid, email);
                const userData = {
                    uid: uid,
                    email: email,
                    displayName: name,
                    depositBalance: initialBalance,
                    winningCash: 0,
                    bonusCash: 0,
                    status: 'active',
                    createdAt: serverTimestamp(),
                    referralCode: referralCode,
                    isAdmin: false,
                    referralEarnings: 0,
                    totalEarnings: 0,
                    totalMatches: 0,
                    wonMatches: 0,
                    totalKills: 0
                };
                await set(ref(db, `users/${uid}`), userData);
                console.log("User data created in DB:", uid);
                showStatus(statusEl, `User ${name} created!`, "success", 4000);
                elements.addUserForm.reset();
                getModalInstance(elements.addUserModalEl)?.hide();
                loadDashboardStats();
            } catch (error) {
                console.error("Error creating user:", error);
                let msg = `Error: ${error.message}`;
                if (error.code === 'auth/email-already-in-use') msg = "Email already registered.";
                else if (error.code === 'auth/weak-password') msg = "Password too weak.";
                else if (error.code === 'auth/invalid-email') msg = "Invalid email format.";
                else if (error.code === 'permission-denied') msg = "Permission denied creating user/DB entry. Check Rules.";
                showStatus(statusEl, msg, "danger", false);
            } finally {
                showLoader(false);
                elements.saveNewUserBtn.disabled = false;
            }
        }


        async function updateUserBalance(event) {
            event.preventDefault();
            if (!db || !isDesignatedAdmin(currentAdminUser)) return;
            const statusEl = elements.balanceUpdateStatus;
            clearStatus(statusEl);
            const userId = elements.editUserUid.value;
            const amountStr = elements.balanceUpdateAmountInput.value;
            const type = elements.balanceUpdateTypeSelect.value;
            const reason = elements.balanceUpdateReasonInput.value.trim();
            if (!userId || !amountStr || !type || !reason) {
                showStatus(statusEl, "All fields required.", "warning");
                return;
            }
            const amount = parseFloat(amountStr);
            if (isNaN(amount) || amount === 0) {
                showStatus(statusEl, "Invalid or zero amount.", "warning");
                return;
            }
            showLoader(true);
            const userRefPath = `users/${userId}`;
            const updates = {};
            try {
                const userSnapshot = await get(ref(db, userRefPath));
                if (!userSnapshot.exists()) throw new Error(`User ${userId} not found.`);
                const user = userSnapshot.val();
                const currentDeposit = Number(user.depositBalance || 0);
                const currentWinning = Number(user.winningCash || 0);
                const currentBonus = Number(user.bonusCash || 0);
                let newDeposit = currentDeposit;
                let newWinning = currentWinning;
                let newBonus = currentBonus;
                let logType = '';
                let balanceAfter = 0;
                switch (type) {
                    case 'depositBalance':
                        newDeposit += amount;
                        if (newDeposit < 0 && !confirm(`Warning: Negative deposit balance (${formatCurrency(newDeposit)}). Proceed?`)) {
                            showLoader(false);
                            showStatus(statusEl, "Update cancelled.", "info");
                            return;
                        }
                        updates[`${userRefPath}/depositBalance`] = newDeposit;
                        logType = amount > 0 ? 'admin_deposit' : 'admin_deduction';
                        balanceAfter = newDeposit;
                        break;
                    case 'winningCash':
                        newWinning += amount;
                        if (newWinning < 0) throw new Error("Winning cash cannot be negative.");
                        updates[`${userRefPath}/winningCash`] = newWinning;
                        logType = amount > 0 ? 'admin_winning_add' : 'admin_winning_deduct';
                        balanceAfter = newWinning;
                        break;
                    case 'bonusCash':
                        newBonus += amount;
                        if (newBonus < 0) throw new Error("Bonus cash cannot be negative.");
                        updates[`${userRefPath}/bonusCash`] = newBonus;
                        logType = amount > 0 ? 'admin_bonus_add' : 'admin_bonus_deduct';
                        balanceAfter = newBonus;
                        break;
                    default:
                        throw new Error("Invalid balance type.");
                }
                const txKey = push(ref(db, `transactions/${userId}`)).key;
                const txData = {
                    type: logType,
                    amount: amount,
                    timestamp: serverTimestamp(),
                    description: `Admin Update: ${reason}`,
                    status: 'completed',
                    balanceAfter: balanceAfter,
                    adminUid: currentAdminUser.uid
                };
                updates[`transactions/${userId}/${txKey}`] = txData;
                await update(ref(db), updates);
                console.log(`Balance updated for ${userId}. New Deposit: ${newDeposit}, Win: ${newWinning}, Bonus: ${newBonus}`);
                elements.userDetailDepositBalance.textContent = formatCurrency(newDeposit);
                elements.userDetailWinning.textContent = formatCurrency(newWinning);
                elements.userDetailBonus.textContent = formatCurrency(newBonus);
                if (fullUserDataCache[userId]) {
                    fullUserDataCache[userId].depositBalance = newDeposit;
                    fullUserDataCache[userId].winningCash = newWinning;
                    fullUserDataCache[userId].bonusCash = newBonus;
                }
                if (userDataCache[userId]) {
                    userDataCache[userId].depositBalance = newDeposit;
                    userDataCache[userId].winningCash = newWinning;
                    userDataCache[userId].bonusCash = newBonus;
                }
                showStatus(statusEl, "Balance updated!", "success", 3000);
                elements.updateBalanceForm.reset();
            } catch (error) {
                console.error("Error updating balance:", error);
                showStatus(statusEl, `Error: ${error.message}`, "danger", false);
            } finally {
                showLoader(false);
            }
        }

        async function toggleUserBlock(event) {
            const button = event.target.closest('button');
            if (!button || !db || !isDesignatedAdmin(currentAdminUser)) return;
            const userId = button.dataset.id;
            const currentAction = button.dataset.action;
            if (!userId || !currentAction) return;
            const newStatus = currentAction === 'block' ? 'blocked' : 'active';
            if (!confirm(`Confirm ${currentAction} user ${userId}?`)) return;
            showLoader(true);
            button.disabled = true;
            const modalVisible = getModalInstance(elements.userModalEl)?._isShown;
            const statusEl = modalVisible && elements.editUserUid.value === userId ? elements.balanceUpdateStatus : elements.usersStatus;
            clearStatus(statusEl);
            try {
                await set(ref(db, `users/${userId}/status`), newStatus);
                console.log(`User ${userId} status set to ${newStatus}`);
                if (fullUserDataCache[userId]) fullUserDataCache[userId].status = newStatus;
                if (userDataCache[userId]) userDataCache[userId].status = newStatus;
                showStatus(statusEl, `User ${newStatus} successfully!`, "success", 3000);
                if (modalVisible && elements.editUserUid.value === userId) {
                    elements.userDetailStatus.textContent = newStatus.charAt(0).toUpperCase() + newStatus.slice(1);
                    elements.userDetailStatus.className = `fw-bold text-${newStatus === 'active' ? 'success' : 'danger'}`;
                    button.textContent = newStatus === 'active' ? 'Block User' : 'Unblock User';
                    button.className = `btn btn-sm ${newStatus === 'active' ? 'btn-danger' : 'btn-success'}`;
                    button.dataset.action = newStatus === 'active' ? 'block' : 'unblock';
                }
                filterUsers();
            } catch (error) {
                console.error(`Error ${currentAction}ing user:`, error);
                showStatus(statusEl, `Error ${currentAction}ing user: ${error.message}. Check Rules.`, "danger", false);
            } finally {
                showLoader(false);
                button.disabled = false;
            }
        }

        async function deleteUser(userId) {
            if (!db || !userId || !isDesignatedAdmin(currentAdminUser)) return;
            const userName = fullUserDataCache[userId]?.displayName || fullUserDataCache[userId]?.email || userId;
            if (!confirm(`DELETE USER: ${userName} (UID: ${userId})?\n\nWARNING:\n- Removes user data from Realtime Database ONLY.\n- DOES NOT delete from Firebase Auth.\n- Associated data (transactions, etc.) may be orphaned.\n\nCannot be undone. Proceed?`)) return;
            showLoader(true);
            const statusEl = elements.usersStatus;
            clearStatus(statusEl);
            const modal = getModalInstance(elements.userModalEl);
            if (modal?._isShown) modal.hide();
            try {
                await remove(ref(db, `users/${userId}`));
                console.log("User deleted from DB:", userId);
                delete fullUserDataCache[userId];
                delete userDataCache[userId];
                showStatus(statusEl, `User ${userName} deleted from Database.`, "success", 5000);
                filterUsers();
                loadDashboardStats();
            } catch (error) {
                console.error("Error deleting user from DB:", error);
                showStatus(statusEl, `Error deleting user data: ${error.message}. Check Rules.`, "danger", false);
            } finally {
                showLoader(false);
            }
        }

        async function openWithdrawalActionModal(withdrawalId, type) {
            if (!db || !withdrawalId || !type || !isDesignatedAdmin(currentAdminUser)) return;
            console.log(`Opening withdrawal modal: ${withdrawalId}, Action: ${type}`);
            showLoader(true);
            currentWithdrawalAction = { id: withdrawalId, type: type, userId: null };
            elements.withdrawalRejectReasonInput.value = '';
            elements.withdrawalApproveNoteInput.value = '';
            elements.withdrawalRejectReasonDiv.style.display = 'none';
            elements.withdrawalApproveNoteDiv.style.display = 'none';
            elements.withdrawalRejectReasonInput.required = false;
            elements.withdrawalApproveNoteInput.required = false;
            clearStatus(elements.withdrawalActionStatus);
            elements.approveWithdrawalBtn.style.display = 'inline-block';
            elements.rejectWithdrawalBtn.style.display = 'inline-block';
            elements.approveWithdrawalBtn.disabled = false;
            elements.rejectWithdrawalBtn.disabled = false;
            const withdrawalRef = ref(db, `withdrawals/${withdrawalId}`);
            try {
                const snapshot = await get(withdrawalRef);
                if (!snapshot.exists()) throw new Error(`Withdrawal ${withdrawalId} not found.`);
                const w = snapshot.val();
                currentWithdrawalAction.userId = w.userId;
                if (w.status !== 'pending') {
                    alert(`Request already processed (Status: ${w.status}).`);
                    showLoader(false);
                    return;
                }
                let userDisplay = `UID: ${w.userId}`;
                const userId = w.userId;
                if (userId && userDataCache[userId]) {
                    const u = userDataCache[userId];
                    userDisplay = `${sanitizeHTML(u.displayName)} (<small class="text-muted" title="${userId}">${sanitizeHTML(u.email)}</small>)`;
                } else if (userId) {
                    try {
                        const userSnap = await get(ref(db, `users/${userId}`));
                        if (userSnap.exists()) {
                            const u = userSnap.val();
                            userDataCache[userId] = { displayName: u.displayName || 'N/A', email: u.email || userId, status: u.status || 'unknown' };
                            userDisplay = `${sanitizeHTML(u.displayName)} (<small class="text-muted" title="${userId}">${sanitizeHTML(u.email)}</small>)`;
                        } else {
                            userDataCache[userId] = { displayName: 'Unknown User', email: userId, status: 'deleted' };
                            userDisplay = `Unknown User (<small class="text-muted" title="${userId}">${userId}</small>)`;
                        }
                    } catch (err) {
                        console.warn(`Could not fetch user ${userId}`, err);
                        userDataCache[userId] = { displayName: 'Error Fetching', email: userId, status: 'error' };
                        userDisplay = `Error Fetching (<small class="text-muted" title="${userId}">${userId}</small>)`;
                    }
                }
                let methodDisplay = sanitizeHTML(w.methodDetails?.methodName || w.method || 'N/A');
                if (w.methodDetails?.accountInfo) methodDisplay += ` - ${sanitizeHTML(w.methodDetails.accountInfo)}`;
                elements.withdrawalDetailId.textContent = withdrawalId;
                elements.withdrawalDetailUser.innerHTML = userDisplay;
                elements.withdrawalDetailUserUid.textContent = userId || 'N/A';
                elements.withdrawalDetailAmount.textContent = (w.amount || 0).toFixed(2);
                elements.withdrawalDetailMethod.textContent = methodDisplay;
                if (type === 'reject') {
                    elements.withdrawalRejectReasonDiv.style.display = 'block';
                    elements.withdrawalRejectReasonInput.required = true;
                    elements.approveWithdrawalBtn.style.display = 'none';
                } else {
                    elements.withdrawalApproveNoteDiv.style.display = 'block';
                    elements.rejectWithdrawalBtn.style.display = 'none';
                }
                getModalInstance(elements.withdrawalActionModalEl)?.show();
            } catch (error) {
                console.error("Error opening withdrawal modal:", error);
                alert(`Error fetching details: ${error.message}`);
                showStatus(elements.withdrawalsStatus, `Error fetching details: ${error.message}`, 'danger', false);
            } finally {
                showLoader(false);
            }
        }

        async function processWithdrawalAction() {
            if (!db || !currentWithdrawalAction.id || !currentWithdrawalAction.type || !currentWithdrawalAction.userId || !isDesignatedAdmin(currentAdminUser)) {
                console.error("Withdrawal details missing or unauthorized.");
                showStatus(elements.withdrawalActionStatus, "Internal error/unauthorized.", "danger", false);
                return;
            }
            const statusEl = elements.withdrawalActionStatus;
            clearStatus(statusEl);
            const withdrawalId = currentWithdrawalAction.id;
            const actionType = currentWithdrawalAction.type;
            const userId = currentWithdrawalAction.userId;
            const updates = {};
            const withdrawalRefPath = `withdrawals/${withdrawalId}`;

            showLoader(true);
            elements.approveWithdrawalBtn.disabled = true;
            elements.rejectWithdrawalBtn.disabled = true;

            try {
                const wSnapshot = await get(ref(db, withdrawalRefPath));
                if (!wSnapshot.exists()) throw new Error("Withdrawal request not found.");
                const wData = wSnapshot.val();
                const amount = Number(wData.amount || 0);

                if (wData.status !== 'pending') throw new Error(`Request already processed (Status: ${wData.status}).`);
                if (amount <= 0) throw new Error("Invalid withdrawal amount.");

                const mainTxKey = push(ref(db, `transactions/${userId}`)).key;

                if (actionType === 'reject') {
                    const reason = elements.withdrawalRejectReasonInput.value.trim();
                    if (!reason) {
                        elements.rejectWithdrawalBtn.disabled = false;
                        throw new Error("Rejection reason required.");
                    }
                    updates[`${withdrawalRefPath}/status`] = 'rejected';
                    updates[`${withdrawalRefPath}/rejectReason`] = reason;
                    updates[`${withdrawalRefPath}/processedAt`] = serverTimestamp();
                    updates[`${withdrawalRefPath}/processedBy`] = currentAdminUser.uid;

                    const uSnapshot = await get(ref(db, `users/${userId}`));
                    if (!uSnapshot.exists()) throw new Error(`User ${userId} not found for refund.`);
                    const user = uSnapshot.val();
                    const currentWinning = Number(user.winningCash || 0);
                    const newWinning = currentWinning + amount;
                    updates[`users/${userId}/winningCash`] = newWinning;

                    const refundTxKey = push(ref(db, `transactions/${userId}`)).key;
                    updates[`transactions/${userId}/${refundTxKey}`] = {
                        type: 'withdrawal_refund',
                        amount: amount,
                        timestamp: serverTimestamp(),
                        description: `Refund for rejected withdrawal`,
                        status: 'completed',
                        adminUid: currentAdminUser.uid,
                        details: { reason: reason, withdrawalId: withdrawalId }
                    };

                } else {
                    const adminNote = elements.withdrawalApproveNoteInput.value.trim();
                    updates[`${withdrawalRefPath}/status`] = 'completed';
                    updates[`${withdrawalRefPath}/adminNote`] = adminNote || 'Approved';
                    updates[`${withdrawalRefPath}/processedAt`] = serverTimestamp();
                    updates[`${withdrawalRefPath}/processedBy`] = currentAdminUser.uid;

                    updates[`transactions/${userId}/${mainTxKey}`] = {
                        type: 'withdrawal_approved',
                        amount: -amount,
                        timestamp: serverTimestamp(),
                        description: `Withdrawal Approved`,
                        status: 'completed',
                        withdrawalId: withdrawalId,
                        adminUid: currentAdminUser.uid,
                        details: { adminNote: adminNote }
                    };
                }

                await update(ref(db), updates);

                console.log(`Withdrawal ${withdrawalId} ${actionType} processed.`);
                getModalInstance(elements.withdrawalActionModalEl)?.hide();
                showStatus(elements.withdrawalsStatus, `Withdrawal ${actionType} successfully!`, "success", 4000);

                const activeFilterBtn = getElement('withdrawalFilters')?.querySelector('.filter-btn.active');
                const statusToLoad = activeFilterBtn?.dataset.status || 'pending';
                loadWithdrawals(statusToLoad);

                loadDashboardStats();

            } catch (error) {
                console.error("Error processing withdrawal:", error);
                showStatus(statusEl, `Error: ${error.message}. Check Rules.`, "danger", false);
            } finally {
                showLoader(false);
                if (getModalInstance(elements.withdrawalActionModalEl)?._isShown) {
                    elements.approveWithdrawalBtn.disabled = false;
                    elements.rejectWithdrawalBtn.disabled = false;
                }
            }
        }

        async function saveSettings(event) {
            event.preventDefault();
            if (!db || !isDesignatedAdmin(currentAdminUser)) return;
            const statusEl = elements.settingsStatus;
            clearStatus(statusEl);
            const signupBonus = parseFloat(elements.settingSignupBonusInput.value);
            const minW = parseFloat(elements.settingMinWithdrawInput.value);
            const refB = parseFloat(elements.settingReferralBonusInput.value);
            if (isNaN(signupBonus) || isNaN(minW) || isNaN(refB) || minW < 0 || refB < 0 || signupBonus < 0) {
                showStatus(statusEl, "Numeric bonus/withdraw values must be valid, non-negative numbers.", "warning");
                return;
            }
            const settingsData = {
                logoUrl: elements.settingLogoUrlInput.value.trim(),
                appName: elements.settingAppNameInput.value.trim(),
                signupBonus: signupBonus,
                minWithdraw: minW,
                referralBonus: refB,
                supportContact: elements.settingSupportContactInput.value.trim(),
                upiDetails: elements.settingUpiDetailsInput.value.trim(),
                qrCodeUrl: elements.settingQrCodeUrlInput.value.trim(),
                loginLogoUrl: elements.settingLoginLogoUrlInput.value.trim(),
                liveSupportTitle: elements.settingLiveSupportTitleInput.value.trim(),
                policyPrivacy: elements.settingPolicyPrivacyInput.value.trim(),
                policyTerms: elements.settingPolicyTermsInput.value.trim(),
                policyRefund: elements.settingPolicyRefundInput.value.trim(),
                policyFairPlay: elements.settingPolicyFairPlayInput.value.trim(),
                lastUpdated: serverTimestamp()
            };

            settingsData.liveSupportAdmin = {
                displayName: elements.settingLiveSupportNameInput.value.trim(),
                photoURL: elements.settingLiveSupportLogoUrlInput.value.trim()
            };

            showLoader(true);
            elements.appSettingsForm?.querySelectorAll('input, textarea, button').forEach(el => el.disabled = true);
            try {
                await update(ref(db, 'settings'), settingsData);
                appSettings = {...appSettings, ...settingsData};
                console.log("Settings saved:", appSettings);
                showStatus(statusEl, "Settings saved!", "success", 3000);
                if(elements.adminHeaderLogo) {
                    const logoUrl = appSettings.logoUrl;
                    elements.adminHeaderLogo.src = logoUrl || 'https://via.placeholder.com/35/1E293B/94A3B8?text=L';
                    elements.adminHeaderLogo.style.display = logoUrl ? 'inline-block' : 'none';
                    elements.adminHeaderLogo.alt = appSettings.appName ? `${appSettings.appName} Logo` : 'Logo';
                }

                document.title = `${appSettings.appName || 'Gaming Tournament'} - Admin Panel`;
            } catch (error) {
                console.error("Error saving settings:", error);
                showStatus(statusEl, `Error: ${error.message}. Check Rules.`, "danger", false);
            } finally {
                showLoader(false);
                elements.appSettingsForm?.querySelectorAll('input, textarea, button').forEach(el => el.disabled = false);
            }
        }

        async function handleDepositAction(depositId, userId, amount, action) {
            const friendlyAction = action === 'complete' ? 'Approve' : 'Reject';
            if (!confirm(`Are you sure you want to ${friendlyAction} this deposit?`)) {
                return;
            }
            if (!depositId || !userId || isNaN(amount)) {
                showStatus(elements.depositsStatus, "Error: Missing data on the request.", "danger");
                return;
            }

            showLoader(true);
            const cardElement = document.getElementById(`deposit-card-${depositId}`);
            if(cardElement) cardElement.style.pointerEvents = 'none';

            const updates = {};
            const userRef = ref(db, `users/${userId}`);

            try {
                if (action === 'complete') {
                    const userSnapshot = await get(userRef);
                    if (!userSnapshot.exists()) throw new Error(`User with ID ${userId} not found.`);
                    const currentDepositBalance = userSnapshot.val().depositBalance || 0;
                    const newDepositBalance = currentDepositBalance + amount;
                    updates[`/deposits/${depositId}/status`] = 'completed';
                    updates[`/deposits/${depositId}/processedAt`] = serverTimestamp();
                    updates[`/deposits/${depositId}/processedBy`] = currentAdminUser.uid;
                    updates[`/users/${userId}/depositBalance`] = newDepositBalance;
                    const newTxRef = push(ref(db, `transactions/${userId}`));
                    updates[`/transactions/${userId}/${newTxRef.key}`] = { type: 'deposit_completed', amount: amount, description: `Deposit`, status: 'completed', timestamp: serverTimestamp(), depositBalanceAfter: newDepositBalance, adminUid: currentAdminUser.uid };
                } else if (action === 'reject') {
                    updates[`/deposits/${depositId}/status`] = 'rejected';
                    updates[`/deposits/${depositId}/processedAt`] = serverTimestamp();
                    updates[`/deposits/${depositId}/processedBy`] = currentAdminUser.uid;
                }

                await update(ref(db), updates);
                showStatus(elements.depositsStatus, `Deposit ${depositId} marked as ${action}.`, "success", 4000);

                if(cardElement) {
                    cardElement.style.transition = 'opacity 0.5s, transform 0.5s';
                    cardElement.style.opacity = '0';
                    cardElement.style.transform = 'scale(0.9)';
                    setTimeout(() => {
                        cardElement.remove();
                        if(elements.pendingDepositsCardContainer.children.length === 0) {
                             elements.pendingDepositsCardContainer.innerHTML = `<div class="col-12"><p class="text-center text-muted p-3">No pending deposits found.</p></div>`;
                        }
                    }, 500);
                }

            } catch (error) {
                console.error("Error processing deposit:", error);
                showStatus(elements.depositsStatus, `Error: ${error.message}`, "danger", false);
                 if(cardElement) cardElement.style.pointerEvents = 'auto';
            } finally {
                showLoader(false);
            }
        }

        async function creditReferralBonus(referralId, referrerUid) {
            if (!referralId || !referrerUid) {
                showStatus(elements.referralsStatus, "Error: Missing data for credit action.", "danger");
                return;
            }

            const btn = document.querySelector(`.btn-credit-referral[data-id="${referralId}"]`);
            if (btn) btn.disabled = true;
            showLoader(true);

            const referralBonus = appSettings.referralBonus ?? 5;

            const userRef = ref(db, `users/${referrerUid}`);
            const updates = {};
            let newBonusBalance = 0;

            try {
                const transactionResult = await runTransaction(userRef, (userProfile) => {
                    if (userProfile) {
                        userProfile.bonusCash = (userProfile.bonusCash || 0) + referralBonus;
                        userProfile.referralEarnings = (userProfile.referralEarnings || 0) + referralBonus;
                        newBonusBalance = userProfile.bonusCash;
                    }
                    return userProfile;
                });

                if (!transactionResult.committed) {
                    throw new Error("Failed to update user profile transactionally. Please try again.");
                }

                console.log(`Successfully updated bonus balance for referrer ${referrerUid}`);

                const newTxKey = push(ref(db, `transactions/${referrerUid}`)).key;
                updates[`transactions/${referrerUid}/${newTxKey}`] = {
                    type: 'referral_bonus',
                    amount: referralBonus,
                    description: `Referral Bonus Credited`,
                    timestamp: serverTimestamp(),
                    bonusBalanceAfter: newBonusBalance,
                    adminUid: currentAdminUser.uid,
                    referralId: referralId
                };

                updates[`pendingReferrals/${referralId}/status`] = 'credited';
                updates[`pendingReferrals/${referralId}/creditedAt`] = serverTimestamp();
                updates[`pendingReferrals/${referralId}/bonusAmount`] = referralBonus;

                await update(ref(db), updates);
                showStatus(elements.referralsStatus, `Bonus of ${formatCurrency(referralBonus)} credited to referrer!`, "success", 4000);

                loadReferrals('pending');
                loadReferrals('completed');

            } catch(error) {
                 console.error("Error crediting referral bonus:", error);
                 showStatus(elements.referralsStatus, `Error: ${error.message}`, 'danger', false);
                 if (btn) btn.disabled = false;
            } finally {
                showLoader(false);
            }
        }
        
        async function loadLiveSupportConversations() {
            if (!db || !isDesignatedAdmin(currentAdminUser)) return;

            elements.liveSupportUserListContainer.style.display = 'grid';
            elements.liveSupportChatContainer.style.display = 'none';
            elements.liveSupportUserListContainer.innerHTML = `<p class="text-secondary">Loading conversations...</p>`;

            try {
                const supportChatsRef = ref(db, 'liveSupportChats');
                const snapshot = await get(supportChatsRef);

                if (!snapshot.exists()) {
                    elements.liveSupportUserListContainer.innerHTML = `<p class="text-center text-muted p-3">No user has started a conversation yet.</p>`;
                    return;
                }

                const conversations = snapshot.val();
                const userIds = Object.keys(conversations);
                let cardsHtml = '';

                for (const userId of userIds) {
                    const user = fullUserDataCache[userId] || await get(ref(db, `users/${userId}`)).then(s => s.exists() ? {uid: s.key, ...s.val()} : null);
                    if (!user) {
                        console.warn(`User data not found for chat UID: ${userId}. Skipping.`);
                        continue;
                    }
                    if (!fullUserDataCache[userId]) fullUserDataCache[userId] = user;

                    const userChat = conversations[userId];
                    const messageKeys = Object.keys(userChat).sort((a,b) => userChat[a].timestamp - userChat[b].timestamp);
                    const lastMessageKey = messageKeys[messageKeys.length - 1];
                    const lastMessage = userChat[lastMessageKey];

                    let hasUnread = false;
                    Object.values(userChat).forEach(msg => {
                        if (msg.sender === 'user' && !msg.readByAdmin) {
                            hasUnread = true;
                        }
                    });
                    const unreadClass = hasUnread ? 'selected' : '';

                    let lastMessageText = lastMessage.message || '';
                    if (lastMessageText.length > 40) {
                        lastMessageText = lastMessageText.substring(0, 40) + '...';
                    }

                    const senderBadge = lastMessage.sender === 'user'
                        ? `<span class="badge text-bg-info">User</span>`
                        : `<span class="badge text-bg-warning">You</span>`;

                    cardsHtml += `
                        <div class="support-user-card ${unreadClass}" data-uid="${userId}">
                            <div class="user-info">
                                <p class="name">${sanitizeHTML(user.displayName || 'N/A')}</p>
                                <p class="email">${sanitizeHTML(user.email || 'N/A')}</p>
                            </div>
                            <div class="last-message">
                                ${senderBadge} ${sanitizeHTML(lastMessageText)}
                            </div>
                            <div class="support-card-footer">
                                <button class="btn btn-sm btn-danger btn-close-conversation" data-uid="${userId}" title="Close & Delete Conversation">
                                    <i class="bi bi-trash3"></i> Close Chat
                                </button>
                            </div>
                        </div>
                    `;
                }

                elements.liveSupportUserListContainer.innerHTML = cardsHtml || `<p class="text-center text-muted p-3">No conversations found.</p>`;

            } catch (error) {
                console.error("Error loading live support conversations:", error);
                showStatus(elements.liveSupportStatus, `Error loading chats: ${error.message}`, 'danger', false);
                elements.liveSupportUserListContainer.innerHTML = `<p class="text-center text-danger p-3">Error loading chats.</p>`;
            }
        }

        async function openLiveSupportChat(userId) {
            if (!userId) return;
            const user = fullUserDataCache[userId];
            if (!user) {
                showStatus(elements.liveSupportStatus, "Could not load user data for this chat.", "warning");
                return;
            }

            if(currentChattingUserId && dbListeners['liveChat']) {
                off(ref(db, `liveSupportChats/${currentChattingUserId}`), 'value', dbListeners['liveChat']);
            }

            currentChattingUserId = userId;
            elements.liveSupportChatUserName.textContent = sanitizeHTML(user.displayName || user.email);
            elements.liveSupportChatMessages.innerHTML = '';

            elements.liveSupportUserListContainer.style.display = 'none';
            elements.liveSupportChatContainer.style.display = 'flex';

            const chatRef = ref(db, `liveSupportChats/${userId}`);

            try {
                const chatSnapshot = await get(chatRef);
                if (chatSnapshot.exists()) {
                    const messages = chatSnapshot.val();
                    const updates = {};
                    Object.keys(messages).forEach(messageKey => {
                        const message = messages[messageKey];
                        if (message.sender === 'user' && !message.readByAdmin) {
                            updates[`${messageKey}/readByAdmin`] = true;
                        }
                    });

                    if (Object.keys(updates).length > 0) {
                        console.log(`Marking ${Object.keys(updates).length} messages as read for user ${userId}.`);
                        await update(chatRef, updates);
                    }
                }
            } catch (error) {
                console.error("Error marking messages as read:", error);
            }

            dbListeners['liveChat'] = onValue(chatRef, (snapshot) => {
                if(snapshot.exists()) {
                    const messages = snapshot.val();
                    let messagesHtml = '';
                    Object.values(messages).sort((a,b) => a.timestamp - b.timestamp).forEach(msg => {
                        const senderClass = msg.sender === 'admin' ? 'admin-message' : 'user-message';
                        messagesHtml += `
                            <div class="chat-message ${senderClass}">
                                ${sanitizeHTML(msg.message)}
                                <span class="timestamp">${formatDate(msg.timestamp, true)}</span>
                            </div>
                        `;
                    });
                    elements.liveSupportChatMessages.innerHTML = messagesHtml;
                    elements.liveSupportChatMessages.scrollTop = elements.liveSupportChatMessages.scrollHeight;
                }
            }, (error) => {
                console.error("Error listening to live chat:", error);
                elements.liveSupportChatMessages.innerHTML = `<p class="text-danger p-3">Error loading messages.</p>`;
            });
        }

        async function sendLiveSupportMessage(event) {
            event.preventDefault();
            const messageText = elements.liveSupportChatInput.value.trim();
            if (!messageText || !currentChattingUserId) return;

            const adminDisplayName = appSettings?.liveSupportAdmin?.displayName || "Admin Support";
            const adminEmail = currentAdminUser?.email || "admin@support.com";

            const messageData = {
                message: messageText,
                sender: 'admin',
                timestamp: serverTimestamp(),
                username: adminDisplayName,
                email: adminEmail
            };

            try {
                const chatRef = ref(db, `liveSupportChats/${currentChattingUserId}`);
                await push(chatRef, messageData);
                elements.liveSupportChatInput.value = '';
            } catch (error) {
                console.error("Error sending message:", error);
                showStatus(elements.liveSupportStatus, "Failed to send message. Check console for details.", "danger");
            }
        }

        async function deleteSupportConversation(userId) {
            if (!userId || !db) return;

            const user = fullUserDataCache[userId];
            const userName = user ? user.displayName || user.email : `user ${userId}`;

            const confirmationMessage = `Are you sure you want to permanently delete the entire conversation with ${userName}?\n\nThis action cannot be undone.`;

            if (confirm(confirmationMessage)) {
                showLoader(true);
                const chatRef = ref(db, `liveSupportChats/${userId}`);
                try {
                    await remove(chatRef);
                    console.log(`Successfully deleted conversation for user: ${userId}`);
                    showStatus(elements.liveSupportStatus, `Conversation with ${userName} has been deleted.`, 'success', 4000);
                    loadLiveSupportConversations();
                } catch (error) {
                    console.error("Error deleting conversation:", error);
                    showStatus(elements.liveSupportStatus, `Failed to delete conversation: ${error.message}`, 'danger', false);
                } finally {
                    showLoader(false);
                }
            }
        }

        function setupRealtimeAdminListeners() {
            if (!db || !currentAdminUser || !isDesignatedAdmin(currentAdminUser)) return;
            detachAllAdminListeners();
            const pendingWdQuery = query(ref(db, 'withdrawals'), orderByChild('status'), equalTo('pending'));
            const wdKey = 'pendingWithdrawalsCount';
            dbListeners[wdKey] = onValue(pendingWdQuery, (snapshot) => { const count = snapshot.exists() ? snapshot.size : 0; if (elements.pendingWithdrawalCountBadge) { elements.pendingWithdrawalCountBadge.textContent = count; elements.pendingWithdrawalCountBadge.style.display = count > 0 ? 'inline-block' : 'none'; } if (elements.dashboardSection?.classList.contains('active') && elements.statPendingWithdrawals) elements.statPendingWithdrawals.textContent = count; });
            const pendingDpQuery = query(ref(db, 'deposits'), orderByChild('status'), equalTo('pending'));
            const dpKey = 'pendingDepositsCount';
            dbListeners[dpKey] = onValue(pendingDpQuery, (snapshot) => { const count = snapshot.exists() ? snapshot.size : 0; if (elements.pendingDepositCountBadge) { elements.pendingDepositCountBadge.textContent = count; elements.pendingDepositCountBadge.style.display = count > 0 ? 'inline-block' : 'none';} });
            const pendingRfQuery = query(ref(db, 'pendingReferrals'), orderByChild('status'), equalTo('pending'));
            const rfKey = 'pendingReferralsCount';
            dbListeners[rfKey] = onValue(pendingRfQuery, (snapshot) => { const count = snapshot.exists() ? snapshot.size : 0; if (elements.pendingReferralCountBadge) { elements.pendingReferralCountBadge.textContent = count; elements.pendingReferralCountBadge.style.display = count > 0 ? 'inline-block' : 'none';} });

            const supportChatsRef = ref(db, 'liveSupportChats');
            const scKey = 'liveSupportCount';
            dbListeners[scKey] = onValue(supportChatsRef, (snapshot) => {
                let unreadUserMessages = 0;
                if (snapshot.exists()) {
                    const conversations = snapshot.val();
                    Object.values(conversations).forEach(chat => {
                        Object.values(chat).forEach(message => {
                            if (message.sender === 'user' && !message.readByAdmin) {
                                unreadUserMessages++;
                            }
                        });
                    });
                }

                if (elements.liveSupportMessageCountBadge) {
                    if (unreadUserMessages > 0) {
                        elements.liveSupportMessageCountBadge.textContent = unreadUserMessages;
                        elements.liveSupportMessageCountBadge.style.display = 'inline-block';
                    } else {
                        elements.liveSupportMessageCountBadge.style.display = 'none';
                    }
                }
            });

            const settingsRef = ref(db, 'settings');
            const settingsKey = 'settingsListener';
            dbListeners[settingsKey] = onValue(settingsRef, (snapshot) => {
                if(snapshot.exists()) {
                    const settings = snapshot.val();
                    appSettings = settings || {};
                    applyThemeToAdminPanel(appSettings.theme);
                }
            });
        }
        function detachAllAdminListeners() {
            if (!db || Object.keys(dbListeners).length === 0) return;
            Object.keys(dbListeners).forEach(key => {
                try {
                    let q;
                    switch(key) {
                        case 'pendingWithdrawalsCount': q = query(ref(db, 'withdrawals'), orderByChild('status'), equalTo('pending')); break;
                        case 'pendingDepositsCount': q = query(ref(db, 'deposits'), orderByChild('status'), equalTo('pending')); break;
                        case 'pendingReferralsCount': q = query(ref(db, 'pendingReferrals'), orderByChild('status'), equalTo('pending')); break;
                        case 'users': q = ref(db, 'users'); break;
                        case 'settingsListener': q = ref(db, 'settings'); break;
                        case 'liveChat': if(currentChattingUserId) q = ref(db, `liveSupportChats/${currentChattingUserId}`); break;
                        case 'liveSupportCount': q = ref(db, 'liveSupportChats'); break;
                        case 'promoCodes': q = ref(db, 'promoCodes'); break; // New
                        default: console.warn("Unknown listener key:", key);
                    }
                    if(q && typeof dbListeners[key] === 'function') {
                        off(q, 'value', dbListeners[key]);
                    }
                } catch (e) { console.warn(`Could not detach listener ${key}`, e); }
            });
            dbListeners = {};
        }

        async function openEditGameModal(gameId) { if (!db || !gameId || !isDesignatedAdmin(currentAdminUser)) return; showLoader(true); elements.gameForm.reset(); clearStatus(elements.gameStatus); const imgbbStatusEl = elements.gameForm.querySelector('.imgbb-upload-status'); if (imgbbStatusEl) { imgbbStatusEl.textContent = ''; imgbbStatusEl.style.display = 'none'; } try { const snapshot = await get(ref(db, `games/${gameId}`)); if (!snapshot.exists()) throw new Error(`Game ${gameId} not found.`); const game = snapshot.val(); elements.gameModalTitle.textContent = "Edit Game"; elements.gameEditId.value = gameId; elements.gameNameInput.value = game.name || ''; elements.gameImageUrlInput.value = game.imageUrl || ''; elements.gameImageFileInput.value = ''; getModalInstance(elements.gameModalEl)?.show(); } catch (error) { console.error("Error opening edit game modal:", error); showStatus(elements.gamesStatus, `Error loading game for edit: ${error.message}`, "danger", false); } finally { showLoader(false); } }
        async function openEditPromotionModal(promoId) { if (!db || !promoId || !isDesignatedAdmin(currentAdminUser)) return; showLoader(true); elements.promotionForm.reset(); clearStatus(elements.promotionStatus); const imgbbStatusEl = elements.promotionForm.querySelector('.imgbb-upload-status'); if (imgbbStatusEl) { imgbbStatusEl.textContent = ''; imgbbStatusEl.style.display = 'none'; } try { const snapshot = await get(ref(db, `promotions/${promoId}`)); if (!snapshot.exists()) throw new Error(`Promotion ${promoId} not found.`); const promo = snapshot.val(); elements.promotionModalTitle.textContent = "Edit Promotion"; elements.promotionEditId.value = promoId; elements.promoImageUrlInput.value = promo.imageUrl || ''; elements.promoLinkInput.value = promo.link || ''; elements.promoImageFileInput.value = ''; getModalInstance(elements.promotionModalEl)?.show(); } catch (error) { console.error("Error opening edit promotion modal:", error); showStatus(elements.promotionsStatus, `Error loading promotion for edit: ${error.message}`, "danger", false); } finally { showLoader(false); } }
        async function populateGameSelect(selectedValue = null) { if (!elements.tournamentGameSelect) return; const select = elements.tournamentGameSelect; select.innerHTML = '<option value="">Loading...</option>'; select.disabled = true; try { if (Object.keys(gameDataCache).length === 0) await loadGames(); if (Object.keys(gameDataCache).length > 0) { select.innerHTML = '<option value="">-- Select Game --</option>'; const sorted = Object.entries(gameDataCache).sort(([, a], [, b]) => a.localeCompare(b)); sorted.forEach(([id, name]) => { const opt = document.createElement('option'); opt.value = id; opt.textContent = sanitizeHTML(name); select.appendChild(opt); }); if (selectedValue) select.value = selectedValue; } else { select.innerHTML = '<option value="">No Games Available</option>'; } } catch (error) { console.error("Error populating game select:", error); select.innerHTML = '<option value="">Error Loading</option>'; } finally { select.disabled = false; } }

        async function openEditTournamentModal(tournamentId) {
            if (!db || !tournamentId || !isDesignatedAdmin(currentAdminUser)) return;
            showLoader(true);
            clearStatus(elements.addTournamentStatus);
            elements.tournamentForm.reset();
            currentEditingTournamentId = tournamentId;
            try {
                const snapshot = await get(ref(db, `tournaments/${tournamentId}`));
                if (!snapshot.exists()) throw new Error(`Tournament ${tournamentId} not found.`);
                const t = snapshot.val();
                await populateGameSelect(t.gameId);
                elements.tournamentModalTitle.textContent = "Edit Tournament";
                elements.tournamentEditId.value = tournamentId;
                elements.tournamentNameInput.value = t.name || '';
                if (t.startTime) {
                    try {
                        const d = new Date(t.startTime);
                        if (!isNaN(d)) {
                            const offset = d.getTimezoneOffset() * 60000;
                            elements.tournamentStartTimeInput.value = new Date(d - offset).toISOString().slice(0, 16);
                        }
                    } catch(e){console.warn("Err fmt date",e);}
                }
                elements.tournamentStatusSelect.value = t.status || 'upcoming';
                elements.tournamentModeSelect.value = t.mode || 'Solo';
                elements.tournamentEntryFeeInput.value = t.entryFee ?? 0;
                elements.tournamentPrizePoolInput.value = t.prizePool ?? 0;
                elements.tournamentPerKillInput.value = t.perKillPrize ?? 0;
                elements.tournamentMaxPlayersInput.value = t.maxPlayers ?? 0;
                elements.tournamentTagsInput.value = (t.tags || []).join(', ');
                elements.tournamentBannerUrlInput.value = t.bannerUrl || '';
                elements.tournamentDescriptionInput.value = t.description || '';
                elements.tournamentRoomIdInput.value = t.roomId || '';
                elements.tournamentRoomPasswordInput.value = t.roomPassword || '';
                elements.tournamentShowIdPassCheckbox.checked = t.showIdPass || false;
                getModalInstance(elements.addTournamentModalEl)?.show();
            } catch (error) {
                console.error("Error opening edit tournament modal:", error);
                showStatus(elements.tournamentsStatus, `Error loading tournament: ${error.message}`, "danger", false);
                currentEditingTournamentId = null;
            } finally {
                showLoader(false);
            }
        }

        async function openUserModal(userId) { if (!db || !userId || !isDesignatedAdmin(currentAdminUser)) return; showLoader(true); clearStatus(elements.balanceUpdateStatus); elements.updateBalanceForm.reset(); elements.userDetailReferredBy.textContent = "N/A"; elements.userDetailReferredCount.textContent = "N/A"; try { let user; if (fullUserDataCache[userId] && fullUserDataCache[userId].status !== 'error' && fullUserDataCache[userId].status !== 'deleted') { user = fullUserDataCache[userId]; } else { const snapshot = await get(ref(db, `users/${userId}`)); if (!snapshot.exists()) throw new Error(`User ${userId} not found.`); user = snapshot.val(); user.uid = userId; fullUserDataCache[userId] = user; } elements.userModalTitle.textContent = `User: ${sanitizeHTML(user.displayName || 'N/A')}`; elements.userDetailUid.textContent = userId; elements.userDetailEmail.textContent = sanitizeHTML(user.email || 'N/A'); elements.userDetailName.textContent = sanitizeHTML(user.displayName || 'N/A'); elements.userDetailCreatedAt.textContent = formatDate(user.createdAt); elements.userDetailDepositBalance.textContent = formatCurrency(user.depositBalance); elements.userDetailWinning.textContent = formatCurrency(user.winningCash); elements.userDetailBonus.textContent = formatCurrency(user.bonusCash); elements.editUserUid.value = userId; elements.userDetailReferralCode.textContent = user.referralCode || 'N/A'; const status = user.status || 'active'; elements.userDetailStatus.textContent = status.charAt(0).toUpperCase() + status.slice(1); elements.userDetailStatus.className = `fw-bold text-${status === 'active' ? 'success' : 'danger'}`; elements.userBlockBtn.textContent = status === 'active' ? 'Block User' : 'Unblock User'; elements.userBlockBtn.className = `btn btn-sm ${status === 'active' ? 'btn-danger' : 'btn-success'}`; elements.userBlockBtn.dataset.id = userId; elements.userBlockBtn.dataset.action = status === 'active' ? 'block' : 'unblock'; elements.userDeleteBtn.dataset.id = userId; getModalInstance(elements.userModalEl)?.show(); } catch (error) { console.error("Error opening user modal:", error); showStatus(elements.usersStatus, `Error loading user: ${error.message}`, "danger", false); } finally { showLoader(false); } }

        async function openRegisteredPlayersModal(tournamentId, tournamentName) {
            if (!db || !tournamentId || !isDesignatedAdmin(currentAdminUser)) return;
            elements.registeredPlayersModalEl.dataset.tournamentId = tournamentId;

            elements.registeredPlayersModalTitle.textContent = "Registered Players";
            elements.registeredPlayersTournamentName.textContent = tournamentName || "N/A";
            elements.registeredPlayersTableBody.innerHTML = `<tr><td colspan="6" class="text-center p-3"><div class="spinner-border spinner-border-sm"></div></td></tr>`;
            clearStatus(elements.registeredPlayersStatus);
            currentPlayersListForPdf = [];
            getModalInstance(elements.registeredPlayersModalEl)?.show();
            try {
                const playersRef = ref(db, `tournaments/${tournamentId}/registeredPlayers`);
                const snapshot = await get(playersRef);
                if (!snapshot.exists()) {
                    elements.registeredPlayersTableBody.innerHTML = `<tr><td colspan="6" class="text-center p-3 text-muted">No players registered.</td></tr>`;
                    return;
                }
                const registeredData = snapshot.val();
                const userIds = Object.keys(registeredData);
                let tableHtml = '';

                const promises = userIds.map(async (uid) => {
                    let u = fullUserDataCache[uid];
                    if (!u) {
                        const uSnap = await get(ref(db, `users/${uid}`));
                        u = uSnap.exists() ? { uid, ...uSnap.val() } : { uid, displayName: 'Not Found', email: 'N/A' };
                        if (uSnap.exists()) fullUserDataCache[uid] = u;
                    }
                    return { user: u, ...registeredData[uid] };
                });

                const results = await Promise.all(promises);

                results.forEach(res => {
                    const { user, joinedAt, username, gameUid } = res;
                    const teammates = res.teammates || [];

                    const player1Html = `<div>${sanitizeHTML(username || 'N/A')}</div><small class="text-muted">${sanitizeHTML(gameUid || 'N/A')}</small>`;
                    
                    let teammatesHtml = '';
                    for (let i = 0; i < 3; i++) {
                        const teammate = teammates[i];
                        if (teammate) {
                            teammatesHtml += `<td><div>${sanitizeHTML(teammate.username || 'N/A')}</div><small class="text-muted">${sanitizeHTML(teammate.uid || 'N/A')}</small></td>`;
                        } else {
                            teammatesHtml += '<td><small class="text-muted">N/A</small></td>';
                        }
                    }

                    tableHtml += `
                        <tr>
                            <td>
                                <div>${sanitizeHTML(user.displayName)}</div>
                                <small class="text-muted">${sanitizeHTML(user.email)}</small>
                            </td>
                            <td>${player1Html}</td>
                            ${teammatesHtml}
                            <td>${formatDate(joinedAt)}</td>
                        </tr>`;

                    currentPlayersListForPdf.push({
                        registeredBy: `${user.displayName} (${user.email || 'N/A'})`,
                        p1_username: username || 'N/A',
                        p1_uid: gameUid || 'N/A',
                        p2_username: teammates[0]?.username || 'N/A',
                        p2_uid: teammates[0]?.uid || 'N/A',
                        p3_username: teammates[1]?.username || 'N/A',
                        p3_uid: teammates[1]?.uid || 'N/A',
                        p4_username: teammates[2]?.username || 'N/A',
                        p4_uid: teammates[2]?.uid || 'N/A',
                        joinedAt: formatDate(joinedAt)
                    });
                });

                elements.registeredPlayersTableBody.innerHTML = tableHtml || `<tr><td colspan="6" class="text-center p-3 text-muted">Could not load player details.</td></tr>`;
                elements.registeredPlayersModalTitle.textContent = `Registered Players (${results.length})`;
            } catch (error) {
                console.error("Error loading registered players:", error);
                elements.registeredPlayersTableBody.innerHTML = `<tr><td colspan="6" class="text-center p-3 text-danger">Error: ${error.message}.</td></tr>`;
                showStatus(elements.registeredPlayersStatus, `Error: ${error.message}`, 'danger');
            }
        }


        async function getLogoBase64() {
            const logoUrl = appSettings.logoUrl;
            if (!logoUrl) return null;

            const proxyUrl = 'https://corsproxy.io/?';

            try {
                const response = await fetch(proxyUrl + encodeURIComponent(logoUrl));
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const blob = await response.blob();                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(blob);
                });
            } catch (error) {
                console.error("Error fetching or converting logo to Base64:", error);
                return null;
            }
        }

        async function downloadUsersAsPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            const users = Object.values(fullUserDataCache);
            if(users.length === 0) {
                alert("No user data to download.");
                return;
            }

            showLoader(true);
            const logoBase64 = await getLogoBase64();
            if(logoBase64){
                doc.addImage(logoBase64, 'PNG', 15, 10, 20, 20);
            }

            doc.setFontSize(18);
            doc.text(appSettings.appName || "User List", logoBase64 ? 40 : 15, 22);
            doc.setFontSize(11);
            doc.setTextColor(100);
            doc.text(`Generated on: ${new Date().toLocaleString()}`, logoBase64 ? 40 : 15, 28);

            const tableColumn = ["No.", "Display Name", "Email", "Deposit Balance", "Status"];
            const tableRows = [];

            users.forEach((user, index) => {
                const userData = [
                    index + 1,
                    user.displayName || 'N/A',
                    user.email || 'N/A',
                    formatCurrency(user.depositBalance || 0),
                    user.status || 'active'
                ];
                tableRows.push(userData);
            });

            doc.autoTable({
                head: [tableColumn],
                body: tableRows,
                startY: 35,
                theme: 'grid',
                headStyles: { fillColor: [22, 160, 133] }
            });

            doc.save(`user_list_${new Date().toISOString().split('T')[0]}.pdf`);
            showLoader(false);
        }

        async function downloadPlayersAsPDF() {
            const tournamentId = elements.registeredPlayersModalEl.dataset.tournamentId;
            const tournamentName = elements.registeredPlayersTournamentName.textContent || "Tournament";

            if (currentPlayersListForPdf.length === 0) {
                alert("No players to download in this list.");
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'landscape' });

            showLoader(true);
            const logoBase64 = await getLogoBase64();
            if (logoBase64) {
                doc.addImage(logoBase64, 'PNG', 15, 10, 20, 20);
            }

            doc.setFontSize(16);
            doc.text(`Players: ${tournamentName}`, logoBase64 ? 40 : 15, 18);
            doc.setFontSize(11);
            doc.setTextColor(100);
            doc.text(`Generated on: ${new Date().toLocaleString()}`, logoBase64 ? 40 : 15, 24);

            const tableColumn = ["Registered By", "P1 User", "P1 UID", "P2 User", "P2 UID", "P3 User", "P3 UID", "P4 User", "P4 UID", "Joined At"];
            const tableRows = currentPlayersListForPdf.map(player => [
                player.registeredBy,
                player.p1_username,
                player.p1_uid,
                player.p2_username,
                player.p2_uid,
                player.p3_username,
                player.p3_uid,
                player.p4_username,
                player.p4_uid,
                player.joinedAt
            ]);

            doc.autoTable({
                head: [tableColumn],
                body: tableRows,
                startY: 30,
                theme: 'striped',
                headStyles: { fillColor: [41, 128, 185] },
                styles: { fontSize: 8 },
                columnStyles: { 0: { cellWidth: 40 } }
            });

            doc.save(`players_${tournamentId}_${new Date().toISOString().split('T')[0]}.pdf`);
            showLoader(false);
        }

        async function sendGlobalNotification(event) {
            event.preventDefault();
            if (!db || !isDesignatedAdmin(currentAdminUser)) return;
            const statusEl = elements.globalNotificationStatus;
            clearStatus(statusEl);

            const title = elements.globalNotifTitleInput.value.trim();
            const message = elements.globalNotifMessageInput.value.trim();
            const imageUrl = elements.globalNotifImageUrlInput.value.trim();

            if (!title || !message) {
                showStatus(statusEl, "Title and Message are required.", "warning");
                return;
            }

            const notificationData = {
                title: title,
                message: message,
                imageUrl: imageUrl || null,
                timestamp: serverTimestamp()
            };

            showLoader(true);
            try {
                const newNotifRef = push(ref(db, 'notifications'));
                await set(newNotifRef, notificationData);
                showStatus(statusEl, "Global notification sent successfully!", "success");
                elements.globalNotificationForm.reset();
                loadGlobalNotificationHistory();
            } catch (error) {
                console.error("Error sending global notification:", error);
                showStatus(statusEl, `Error: ${error.message}`, "danger", false);
            } finally {
                showLoader(false);
            }
        }

        async function sendIndividualNotification(event) {
            event.preventDefault();
            const userId = elements.editUserUid.value;
            if (!userId || !db || !isDesignatedAdmin(currentAdminUser)) return;

            const statusEl = elements.individualNotificationStatus;
            clearStatus(statusEl);

            const title = elements.individualNotifTitleInput.value.trim();
            const message = elements.individualNotifMessageInput.value.trim();
            const imageUrl = elements.individualNotifImageUrlInput.value.trim();

            if (!title || !message) {
                showStatus(statusEl, "Title and Message are required.", "warning");
                return;
            }

            const notificationData = {
                title: title,
                message: message,
                imageUrl: imageUrl || null,
                timestamp: serverTimestamp()
            };

            showLoader(true);
            try {
                const userNotifRef = ref(db, `users/${userId}/notifications`);
                await push(userNotifRef, notificationData);
                showStatus(statusEl, `Notification sent to ${fullUserDataCache[userId]?.displayName || 'user'}!`, "success");
                elements.individualNotificationForm.reset();
            } catch (error) {
                console.error("Error sending individual notification:", error);
                showStatus(statusEl, `Error: ${error.message}`, "danger", false);
            } finally {
                showLoader(false);
            }
        }

        async function loadGlobalNotificationHistory() {
            const historyEl = elements.globalNotificationsHistory;
            if (!historyEl) return;
            historyEl.innerHTML = tableLoadingPlaceholderHtml(4);

            try {
                const notificationsRef = ref(db, 'notifications');
                const snapshot = await get(notificationsRef);

                if (!snapshot.exists()) {
                    historyEl.innerHTML = '<p class="text-center text-muted p-3">No global notifications sent yet.</p>';
                    return;
                }

                const notifications = [];
                snapshot.forEach(child => {
                    notifications.push({ id: child.key, ...child.val() });
                });
                notifications.sort((a,b) => (b.timestamp || 0) - (a.timestamp || 0));

                let tableHtml = `
                    <table class="table table-dark table-hover mb-0">
                        <thead><tr><th>Sent At</th><th>Title</th><th>Message</th><th>Image</th></tr></thead>
                        <tbody>`;

                notifications.forEach(notif => {
                    tableHtml += `<tr>
                        <td>${formatDate(notif.timestamp)}</td>
                        <td>${sanitizeHTML(notif.title)}</td>
                        <td style="white-space: pre-wrap; word-break: break-word; min-width: 250px;">${sanitizeHTML(notif.message)}</td>
                        <td>${notif.imageUrl ? `<a href="${sanitizeHTML(notif.imageUrl)}" target="_blank">View</a>` : '<span class="text-muted">None</span>'}</td>
                    </tr>`;
                });

                tableHtml += `</tbody></table>`;
                historyEl.innerHTML = tableHtml;
            } catch(error) {
                console.error("Error loading notification history:", error);
                historyEl.innerHTML = `<p class="text-danger text-center p-3">Error loading history: ${error.message}</p>`;
            }
        }

        async function populateTournamentManagementSelector() {
            const selectEl = elements.tmsTournamentSelect;
            selectEl.innerHTML = '<option value="">Loading tournaments...</option>';
            elements.tmsPlayerListContainer.style.display = 'none';
            elements.reviewResultsBtn.style.display = 'none'; // FEATURE 1: Hide review button initially
            clearStatus(elements.tmsStatus);

            try {
                const tournamentsRef = ref(db, 'tournaments');
                const snapshot = await get(tournamentsRef);
                if (!snapshot.exists()) {
                    selectEl.innerHTML = '<option value="">No tournaments found.</option>';
                    return;
                }
                const tournaments = [];
                snapshot.forEach(child => {
                    const t = child.val();
                    // FEATURE 1: Include tournaments with pending results
                    if (['ongoing', 'completed', 'result'].includes(t.status) || (t.playerResults && t.status !== 'result')) {
                        tournaments.push({ id: child.key, ...t });
                    }
                });

                if (tournaments.length === 0) {
                    selectEl.innerHTML = '<option value="">No finished/ongoing tournaments found.</option>';
                    return;
                }

                tournaments.sort((a, b) => (b.startTime || 0) - (a.startTime || 0));
                selectEl.innerHTML = '<option value="">-- Select a tournament --</option>';
                tournaments.forEach(t => {
                    const option = document.createElement('option');
                    option.value = t.id;
                    let statusText = t.status;
                    // FEATURE 1: Indicate if results are pending
                    if(t.playerResults && t.status !== 'result'){
                        statusText = 'Results Pending Review';
                        option.classList.add('text-warning');
                    }
                    option.textContent = `${t.name} (${new Date(t.startTime).toLocaleDateString()}) - ${statusText}`;
                    option.dataset.perKillPrize = t.perKillPrize || 0;
                    option.dataset.name = t.name || 'Tournament';
                    // FEATURE 1: Add data attribute to check for pending results
                    option.dataset.hasPendingResults = (t.playerResults && t.status !== 'result') ? 'true' : 'false';
                    selectEl.appendChild(option);
                });

            } catch (error) {
                console.error('Error populating tournament selector:', error);
                selectEl.innerHTML = '<option value="">Error loading tournaments.</option>';
                showStatus(elements.tmsStatus, `Error: ${error.message}`, 'danger', false);
            }
        }

        async function loadPlayersForManagement(tournamentId) {
            const tableBody = elements.tmsPlayerListTableBody;
            const container = elements.tmsPlayerListContainer;
            const creditBtn = elements.creditWinningsBtn;
            const reviewBtn = elements.reviewResultsBtn; // FEATURE 1
            clearStatus(elements.tmsStatus);

            // FEATURE 1: Check for pending results from selected option
            const selectedOption = elements.tmsTournamentSelect.options[elements.tmsTournamentSelect.selectedIndex];
            const hasPendingResults = selectedOption.dataset.hasPendingResults === 'true';

            reviewBtn.style.display = hasPendingResults ? 'inline-block' : 'none';

            if (!tournamentId) {
                container.style.display = 'none';
                tableBody.innerHTML = '';
                return;
            }

            tableBody.innerHTML = `<tr><td colspan="7" class="text-center p-3"><div class="spinner-border spinner-border-sm"></div> Loading players...</td></tr>`;
            container.style.display = 'block';
            creditBtn.disabled = true;

            try {
                const tournamentRef = ref(db, `tournaments/${tournamentId}`);
                const tSnapshot = await get(tournamentRef);
                if (!tSnapshot.exists()) throw new Error('Tournament not found.');

                const tournament = tSnapshot.val();

                if (tournament.winningsCredited) {
                    showStatus(elements.tmsStatus, `Winnings for this tournament have already been credited.`, 'info', false);
                    creditBtn.disabled = true;
                    creditBtn.textContent = 'Winnings Credited';
                } else {
                    creditBtn.disabled = false;
                    creditBtn.innerHTML = '<i class="bi bi-check-circle-fill"></i> Credit All Winnings';
                }

                const registeredPlayers = tournament.registeredPlayers || {};
                const playerIds = Object.keys(registeredPlayers);
                const perKillPrize = tournament.perKillPrize || 0;

                if (playerIds.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="7" class="text-center p-3 text-muted">No players joined this tournament.</td></tr>';
                    creditBtn.disabled = true;
                    return;
                }

                const userPromises = playerIds.map(uid => get(ref(db, `users/${uid}`)));
                const userSnapshots = await Promise.all(userPromises);

                let tableHtml = '';
                userSnapshots.forEach((uSnap, index) => {
                    const uid = playerIds[index];
                    const playerRegData = registeredPlayers[uid];
                    if (uSnap.exists()) {
                        const user = uSnap.val();
                        fullUserDataCache[uid] = { uid, ...user };

                        tableHtml += `
                            <tr data-uid="${uid}" data-per-kill-prize="${perKillPrize}">
                                <td>${sanitizeHTML(user.displayName || 'N/A')}</td>
                                <td><small class="text-muted">${sanitizeHTML(playerRegData.gameUid || user.gameUid || 'N/A')}</small></td>
                                <td>${formatCurrency(perKillPrize)}</td>
                                <td><input type="number" class="form-control kills-input" min="0" value="0" ${tournament.winningsCredited ? 'disabled' : ''}></td>
                                <td><input type="number" class="form-control extra-amount-input" min="0" value="0" step="any" ${tournament.winningsCredited ? 'disabled' : ''}></td>
                                <td><input type="number" class="form-control rank-input" min="1" ${tournament.winningsCredited ? 'disabled' : ''}></td>
                                <td class="calculated-prize">${formatCurrency(0)}</td>
                            </tr>`;
                    } else {
                        tableHtml += `<tr><td><span class="text-danger">User Deleted (ID: ${uid})</span></td><td colspan="6"></td></tr>`;
                    }
                });
                tableBody.innerHTML = tableHtml;

            } catch (error) {
                console.error("Error loading players for management:", error);
                tableBody.innerHTML = `<tr><td colspan="7" class="text-center p-3 text-danger">Error: ${error.message}</td></tr>`;
            }
        }

        function calculateRowPrize(row) {
            const perKillPrize = parseFloat(row.dataset.perKillPrize || 0);
            const kills = parseInt(row.querySelector('.kills-input')?.value || 0);
            const extraAmount = parseFloat(row.querySelector('.extra-amount-input')?.value || 0);
            const prizeCell = row.querySelector('.calculated-prize');

            const totalPrize = (kills * perKillPrize) + extraAmount;
            if (prizeCell) {
                prizeCell.textContent = formatCurrency(totalPrize);
            }
        }

        async function creditAllWinnings() {
            const tournamentId = elements.tmsTournamentSelect.value;
            const selectedOption = elements.tmsTournamentSelect.options[elements.tmsTournamentSelect.selectedIndex];
            const tournamentName = selectedOption.dataset.name;

            if (!tournamentId) {
                showStatus(elements.tmsStatus, "Please select a tournament first.", "warning");
                return;
            }
            if (!confirm(`Are you sure you want to credit winnings for "${tournamentName}"? This cannot be undone.`)) {
                return;
            }

            showLoader(true);
            elements.creditWinningsBtn.disabled = true;
            clearStatus(elements.tmsStatus);

            const playerRows = elements.tmsPlayerListTableBody.querySelectorAll('tr[data-uid]');
            const updates = {};
            let totalCredited = 0;
            let playersCredited = 0;

            const userIdsToUpdate = Array.from(playerRows).map(row => row.dataset.uid);

            const userRefPromises = userIdsToUpdate.map(uid => get(ref(db, `users/${uid}`)));
            const userSnapshots = await Promise.all(userRefPromises);
            const freshUserData = {};
            userSnapshots.forEach(snap => {
                if(snap.exists()) {
                    freshUserData[snap.key] = snap.val();
                }
            });

            playerRows.forEach(row => {
                const uid = row.dataset.uid;
                const user = freshUserData[uid];
                if (!user) {
                    console.warn(`Skipping user ${uid}, data not found.`);
                    return;
                }

                const perKillPrize = parseFloat(row.dataset.perKillPrize || 0);
                const kills = parseInt(row.querySelector('.kills-input')?.value || 0);
                const extraAmount = parseFloat(row.querySelector('.extra-amount-input')?.value || 0);
                const rank = parseInt(row.querySelector('.rank-input')?.value) || 0;
                const totalPrize = (kills * perKillPrize) + extraAmount;

                const newMatchHistoryKey = push(ref(db, `users/${uid}/matchHistory`)).key;
                const matchHistory = {
                    tournamentId: tournamentId,
                    tournamentName: tournamentName,
                    rank: rank,
                    kills: kills,
                    earnings: totalPrize,
                    date: serverTimestamp()
                };
                updates[`users/${uid}/matchHistory/${newMatchHistoryKey}`] = matchHistory;

                updates[`users/${uid}/totalMatches`] = (user.totalMatches || 0) + 1;
                updates[`users/${uid}/totalKills`] = (user.totalKills || 0) + kills;

                if(rank === 1) {
                   updates[`users/${uid}/wonMatches`] = (user.wonMatches || 0) + 1;
                }

                if (uid && totalPrize > 0) {
                    const newWinningCash = (user.winningCash || 0) + totalPrize;
                    const newTotalEarnings = (user.totalEarnings || 0) + totalPrize;

                    updates[`users/${uid}/winningCash`] = newWinningCash;
                    updates[`users/${uid}/totalEarnings`] = newTotalEarnings;

                    const newTxKey = push(ref(db, `transactions/${uid}`)).key;
                    updates[`transactions/${uid}/${newTxKey}`] = {
                        type: 'tournament_winnings',
                        amount: totalPrize,
                        description: `Winnings: ${kills} Kills + ${formatCurrency(extraAmount)} in ${tournamentName}`,
                        details: { kills, perKillPrize, extraAmount, rank },
                        timestamp: serverTimestamp(),
                        tournamentId: tournamentId,
                        adminUid: currentAdminUser.uid
                    };
                    totalCredited += totalPrize;
                    playersCredited++;
                }

                updates[`users/${uid}/joinedTournaments/${tournamentId}`] = null;
            });

            if (Object.keys(updates).length > 0) {
                updates[`tournaments/${tournamentId}/winningsCredited`] = true;
                updates[`tournaments/${tournamentId}/status`] = 'result';
                updates[`tournaments/${tournamentId}/registeredPlayers`] = null;

                try {
                    await update(ref(db), updates);
                    showStatus(elements.tmsStatus, `Successfully credited ${formatCurrency(totalCredited)} to ${playersCredited} players and updated stats.`, "success");
                    loadPlayersForManagement(tournamentId);
                } catch (error) {
                    console.error("Error crediting winnings:", error);
                    showStatus(elements.tmsStatus, `Critical Error: Failed to credit winnings. ${error.message}`, "danger", false);
                    elements.creditWinningsBtn.disabled = false;
                }
            } else {
                 showStatus(elements.tmsStatus, "No winnings or stats to update. All values are zero or blank.", "info");
                 elements.creditWinningsBtn.disabled = false;
            }

            showLoader(false);
        }

        async function loadLeaderboardManagementData() {
            if (!db || !isDesignatedAdmin(currentAdminUser)) return;
            const tableBody = elements.leaderboardMgtTableBody;
            const statusEl = elements.leaderboardMgtStatus;
            clearStatus(statusEl);
            tableBody.innerHTML = tableLoadingPlaceholderHtml(3);
            elements.leaderboardUserSearchInput.value = '';

            try {
                if (Object.keys(fullUserDataCache).length === 0) {
                    await new Promise(resolve => {
                         const usersRef = ref(db, 'users');
                         onValue(usersRef, (snapshot) => {
                             if(snapshot.exists()) {
                                snapshot.forEach(child => {
                                    fullUserDataCache[child.key] = { uid: child.key, ...child.val() };
                                });
                             }
                             resolve();
                         }, { onlyOnce: true });
                    });
                }

                const users = Object.values(fullUserDataCache);
                if(users.length === 0){
                    tableBody.innerHTML = '<tr><td colspan="3" class="text-center p-3 text-muted">No users found.</td></tr>';
                    return;
                }

                users.sort((a,b) => (a.displayName || 'z').localeCompare(b.displayName || 'z'));
                renderLeaderboardMgtTable(users);

            } catch (error) {
                console.error("Error loading data for Leaderboard Mgt:", error);
                tableBody.innerHTML = `<tr><td colspan="3" class="text-center p-3 text-danger">Error: ${error.message}</td></tr>`;
                showStatus(statusEl, `Error loading user data: ${error.message}`, 'danger');
            }
        }

        function autoRankLeaderboardByWinnings() {
            const statusEl = elements.leaderboardMgtStatus;
            clearStatus(statusEl);

            if (Object.keys(fullUserDataCache).length === 0) {
                showStatus(statusEl, "User data not loaded yet. Please wait and try again.", "warning");
                return;
            }

            // Get all users, filter out those with no winnings, and sort them
            const sortedUsers = Object.values(fullUserDataCache)
                .filter(user => user.winningCash > 0)
                .sort((a, b) => (b.winningCash || 0) - (a.winningCash || 0));

            const topUsers = sortedUsers.slice(0, 50); // Get top 50 users

            // Clear all current ranks and earnings in the table
            const allRows = elements.leaderboardMgtTableBody.querySelectorAll('tr[data-uid]');
            allRows.forEach(row => {
                row.querySelector('.rank-input').value = '';
                row.querySelector('.earnings-input').value = '';
            });

            // Set the new ranks and earnings for the top users
            topUsers.forEach((user, index) => {
                const rank = index + 1;
                const userRow = elements.leaderboardMgtTableBody.querySelector(`tr[data-uid="${user.uid}"]`);
                if (userRow) {
                    userRow.querySelector('.rank-input').value = rank;
                    userRow.querySelector('.earnings-input').value = Math.floor(user.winningCash);
                }
            });

            showStatus(statusEl, "Top 50 users have been auto-ranked based on winnings. Review the changes and click 'Save Manual Changes' to apply.", "info", 10000);
        }

        function renderLeaderboardMgtTable(usersArray){
            const tableBody = elements.leaderboardMgtTableBody;
            let tableHtml = '';
            if (usersArray && usersArray.length > 0) {
                usersArray.forEach(user => {
                    const displayName = user.displayName || 'N/A';
                    const userEmail = user.email || 'N/A';
                    const currentRank = user.leaderboardRank || '';
                    const currentEarnings = user.leaderboardDisplayEarnings ?? '';

                    tableHtml += `
                        <tr data-uid="${user.uid}" data-name="${displayName.toLowerCase()}" data-email="${userEmail.toLowerCase()}">
                            <td>
                                <div>${displayName}</div>
                                <small class="text-muted">${userEmail}</small>
                            </td>
                            <td><input type="number" class="form-control form-control-sm rank-input" style="width: 100px;" value="${currentRank}" placeholder="N/A" min="1"></td>
                            <td><input type="number" class="form-control form-control-sm earnings-input" style="width: 150px;" value="${currentEarnings}" placeholder="e.g., 5000" min="0" step="any"></td>
                        </tr>
                    `;
                });
            }
            tableBody.innerHTML = tableHtml || `<tr><td colspan="3" class="text-center p-3 text-muted">No users found for this search.</td></tr>`;
        }

        async function saveLeaderboardData() {
            if (!db || !isDesignatedAdmin(currentAdminUser)) return;

            const statusEl = elements.leaderboardMgtStatus;
            clearStatus(statusEl);
            if(!confirm("Are you sure you want to save all leaderboard changes?")) return;

            showLoader(true);
            elements.saveLeaderboardBtn.disabled = true;

            const updates = {};
            const playerRows = elements.leaderboardMgtTableBody.querySelectorAll('tr[data-uid]');

            playerRows.forEach(row => {
                const uid = row.dataset.uid;
                const rankInput = row.querySelector('.rank-input');
                const earningsInput = row.querySelector('.earnings-input');

                const rank = parseInt(rankInput.value, 10);
                const earnings = parseFloat(earningsInput.value);

                updates[`users/${uid}/leaderboardRank`] = (!isNaN(rank) && rank > 0) ? rank : null;
                updates[`users/${uid}/leaderboardDisplayEarnings`] = (!isNaN(earnings) && earnings >= 0) ? earnings : null;
            });

            try {
                await update(ref(db), updates);
                showStatus(statusEl, "Leaderboard data saved successfully!", "success", 3000);
            } catch(error) {
                console.error("Error saving leaderboard data:", error);
                showStatus(statusEl, `Error saving data: ${error.message}`, 'danger', false);
            } finally {
                showLoader(false);
                elements.saveLeaderboardBtn.disabled = false;
            }
        }

        function filterLeaderboardMgtUsers(){
            const searchTerm = elements.leaderboardUserSearchInput.value.toLowerCase().trim();
            const allRows = elements.leaderboardMgtTableBody.querySelectorAll('tr[data-uid]');

            allRows.forEach(row => {
                const name = row.dataset.name;
                const email = row.dataset.email;

                if (name.includes(searchTerm) || email.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        function renderNewUserChart() {
            const users = Object.values(fullUserDataCache);
            if (!users || users.length === 0) return;

            const days = Array(7).fill(0).map((_, i) => {
                const d = new Date();
                d.setDate(d.getDate() - i);
                return d;
            }).reverse();

            const labels = days.map(d => d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
            const data = Array(7).fill(0);

            users.forEach(user => {
                if (user.createdAt) {
                    const signupDate = new Date(user.createdAt);
                    for (let i = 0; i < 7; i++) {
                        const dayStart = new Date(days[i]).setHours(0, 0, 0, 0);
                        const dayEnd = new Date(days[i]).setHours(23, 59, 59, 999);
                        if (signupDate >= dayStart && signupDate <= dayEnd) {
                            data[i]++;
                            break;
                        }
                    }
                }
            });

            if (newUserChart) { newUserChart.destroy(); }
            newUserChart = new Chart(elements.newUserChartCanvas, {
                type: 'bar',
                data: { labels, datasets: [{ label: 'New Users', data, backgroundColor: 'rgba(250, 204, 21, 0.7)', borderColor: 'rgb(250, 204, 21)', borderWidth: 1 }] },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                         y: { beginAtZero: true, grid: { color: 'rgba(148, 163, 184, 0.2)' }, ticks: { color: 'var(--text-secondary)', stepSize: 1 } },
                         x: { grid: { color: 'rgba(148, 163, 184, 0.2)' }, ticks: { color: 'var(--text-secondary)' } }
                    }
                }
            });
        }

        async function loadUserAnalyticsData() {
            elements.topSpendersContainer.innerHTML = '<p class="text-secondary">Loading spenders...</p>';
            elements.mostActiveContainer.innerHTML = '<p class="text-secondary">Loading active players...</p>';
            elements.inactiveUsersContainer.innerHTML = '<p class="text-secondary">Loading inactive users...</p>';

            if (Object.keys(fullUserDataCache).length === 0) { await loadUsers(); }

            try {
                const depositsQuery = query(ref(db, 'deposits'), orderByChild('status'), equalTo('completed'));
                const depositSnap = await get(depositsQuery);
                if (depositSnap.exists()) {
                    const spenders = {};
                    depositSnap.forEach(snap => {
                        const d = snap.val();
                        spenders[d.userId] = (spenders[d.userId] || 0) + d.amount;
                    });
                    const sortedSpenders = Object.entries(spenders).sort((a,b) => b[1] - a[1]).slice(0, 10);
                    let table = '<table class="table table-dark table-sm table-hover">';
                    sortedSpenders.forEach(([uid, amount]) => {
                         table += `<tr><td>${sanitizeHTML(fullUserDataCache[uid]?.displayName || uid)}</td><td class="text-end text-success">${formatCurrency(amount)}</td></tr>`;
                    });
                    table += '</table>';
                    elements.topSpendersContainer.innerHTML = sortedSpenders.length > 0 ? table : '<p class="text-secondary">No deposit data found.</p>';
                } else {
                    elements.topSpendersContainer.innerHTML = '<p class="text-secondary">No deposit data found.</p>';
                }
            } catch(e) { elements.topSpendersContainer.innerHTML = `<p class="text-danger">Error: ${e.message}</p>`; }

            try {
                 const tSnap = await get(ref(db, 'tournaments'));
                 if (tSnap.exists()) {
                     const activePlayers = {};
                     tSnap.forEach(t => {
                         const players = t.val().registeredPlayers;
                         if (players) Object.keys(players).forEach(uid => { activePlayers[uid] = (activePlayers[uid] || 0) + 1; });
                     });
                     const sortedActive = Object.entries(activePlayers).sort((a,b) => b[1] - a[1]).slice(0, 10);
                     let table = '<table class="table table-dark table-sm table-hover">';
                     sortedActive.forEach(([uid, count]) => {
                         table += `<tr><td>${sanitizeHTML(fullUserDataCache[uid]?.displayName || uid)}</td><td class="text-end">${count} matches</td></tr>`;
                     });
                     table += '</table>';
                     elements.mostActiveContainer.innerHTML = sortedActive.length > 0 ? table : '<p class="text-secondary">No activity data found.</p>';
                } else {
                     elements.mostActiveContainer.innerHTML = '<p class="text-secondary">No tournament data found.</p>';
                }
            } catch(e) { elements.mostActiveContainer.innerHTML = `<p class="text-danger">Error: ${e.message}</p>`; }

            try {
                 const users = Object.values(fullUserDataCache);
                 const fifteenDaysAgo = Date.now() - (15 * 24 * 60 * 60 * 1000);
                 const inactiveUsers = users.filter(u => !u.lastLogin || u.lastLogin < fifteenDaysAgo);
                 if(inactiveUsers.length > 0) {
                     let table = '<table class="table table-dark table-sm table-hover">';
                     inactiveUsers.forEach(u => {
                         table += `<tr>
                                    <td>
                                      <div>${sanitizeHTML(u.displayName || u.uid)}</div>
                                      <small class="text-muted">Last login: ${u.lastLogin ? formatDate(u.lastLogin) : 'Never'}</small>
                                    </td>
                                    <td class="text-end">
                                      <button class="btn btn-sm btn-info btn-view-user" data-id="${u.uid}" title="View/Notify"><i class="bi bi-eye"></i></button>
                                    </td>
                                  </tr>`;
                     });
                     table += '</table>';
                     elements.inactiveUsersContainer.innerHTML = table;
                 } else {
                    elements.inactiveUsersContainer.innerHTML = '<p class="text-secondary">No inactive users found.</p>';
                 }
            } catch(e) { elements.inactiveUsersContainer.innerHTML = `<p class="text-danger">Error: ${e.message}</p>`; }

        }

        const defaultTheme = {
            'primary-bg': '#0F172A', 'secondary-bg': '#1E293B', 'card-bg': '#1E293B',
            'text-primary': '#E2E8F0', 'text-secondary': '#94A3B8', 'accent-color': '#FACC15',
            'primary-button-bg': '#3B82F6', 'border-color': '#334155', 'success-color': '#10B981',
            'danger-color': '#EF4444', 'warning-color': '#F59E0B', 'info-color': '#60A5FA'
        };

        const themePresets = {
            light: {
                'primary-bg': '#F1F5F9', 'secondary-bg': '#FFFFFF', 'card-bg': '#FFFFFF',
                'text-primary': '#0F172A', 'text-secondary': '#475569', 'accent-color': '#F59E0B',
                'primary-button-bg': '#2563EB', 'border-color': '#E2E8F0', 'success-color': '#16A34A',
                'danger-color': '#DC2626', 'warning-color': '#D97706', 'info-color': '#3B82F6'
            },
            gamingRed: {
                'primary-bg': '#111827', 'secondary-bg': '#1F2937', 'card-bg': '#1F2937',
                'text-primary': '#F9FAFB', 'text-secondary': '#9CA3AF', 'accent-color': '#EF4444',
                'primary-button-bg': '#D97706', 'border-color': '#374151', 'success-color': '#10B981',
                'danger-color': '#EF4444', 'warning-color': '#F59E0B', 'info-color': '#3B82F6'
            }
        };

        function applyThemeToAdminPanel(theme) {
            const root = document.documentElement;
            const themeToApply = theme || defaultTheme;
            for (const [key, value] of Object.entries(themeToApply)) {
                if (value) {
                    root.style.setProperty(`--${key}`, value);
                }
            }
        }

        function loadThemeSettings() {
            clearStatus(elements.themeStatus);
            const currentTheme = appSettings.theme || defaultTheme;
            elements.themeColorInputs.forEach(input => {
                const varName = input.dataset.themeVar;
                if (currentTheme[varName]) {
                    input.value = currentTheme[varName];
                }
            });
        }

        function applyPreset(presetName) {
            let preset = defaultTheme;
            if (presetName === 'light') preset = themePresets.light;
            if (presetName === 'gamingRed') preset = themePresets.gamingRed;

            elements.themeColorInputs.forEach(input => {
                const varName = input.dataset.themeVar;
                if (preset[varName]) {
                    input.value = preset[varName];
                }
            });
            applyThemeToAdminPanel(preset);
        }

        async function saveThemeSettings() {
            if (!db || !isDesignatedAdmin(currentAdminUser)) return;

            const newTheme = {};
            elements.themeColorInputs.forEach(input => {
                const varName = input.dataset.themeVar;
                newTheme[varName] = input.value;
            });
            try {
                await update(ref(db, 'settings'), { theme: newTheme });
                appSettings.theme = newTheme;
                showStatus(elements.themeStatus, "Theme saved successfully for all users!", "success");
            } catch(error) {
                console.error("Error saving theme:", error);
                showStatus(elements.themeStatus, `Error: ${error.message}`, 'danger', false);
            } finally {
                showLoader(false);
                elements.saveThemeBtn.disabled = false;
            }
        }

        async function resetThemeSettings() {
            if (!db || !isDesignatedAdmin(currentAdminUser)) return;
            if (!confirm("Are you sure you want to reset the theme to default for all users?")) return;

            showLoader(true);
            elements.resetThemeBtn.disabled = true;

            try {
                await set(ref(db, 'settings/theme'), null);
                appSettings.theme = null;
                applyPreset('default');
                showStatus(elements.themeStatus, "Theme has been reset to default.", "success");
            } catch(error) {
                 console.error("Error resetting theme:", error);
                showStatus(elements.themeStatus, `Error: ${error.message}`, 'danger', false);
            } finally {
                showLoader(false);
                elements.resetThemeBtn.disabled = false;
            }
        }
        
        // FEATURE 1: New function to open the review results modal
        async function openReviewResultsModal(tournamentId) {
            if (!tournamentId) return;
            
            const selectedOption = elements.tmsTournamentSelect.options[elements.tmsTournamentSelect.selectedIndex];
            const tournamentName = selectedOption.dataset.name;

            elements.reviewResultsTournamentName.textContent = tournamentName;
            elements.reviewResultsTableBody.innerHTML = `<tr><td colspan="5" class="text-center p-3"><div class="spinner-border spinner-border-sm"></div> Loading results...</td></tr>`;
            getModalInstance(elements.reviewResultsModalEl)?.show();
            clearStatus(elements.reviewResultsStatus);
            elements.confirmCreditWinningsBtn.disabled = true;

            try {
                const resultsRef = ref(db, `tournaments/${tournamentId}/playerResults`);
                const resultsSnap = await get(resultsRef);

                if (!resultsSnap.exists()) {
                    elements.reviewResultsTableBody.innerHTML = `<tr><td colspan="5" class="text-center p-3 text-warning">No results found for this tournament.</td></tr>`;
                    return;
                }

                const resultsData = resultsSnap.val();
                const userIds = Object.keys(resultsData);
                
                const userPromises = userIds.map(uid => get(ref(db, `users/${uid}`)).then(snap => snap.exists() ? {uid: uid, ...snap.val()} : {uid: uid, displayName: `Deleted User (${uid})`}));
                const users = await Promise.all(userPromises);

                let tableHtml = '';
                users.forEach(user => {
                    const result = resultsData[user.uid];
                    const screenshots = result.screenshotUrls || [];
                    let screenshotHtml = '';
                    if (screenshots.length > 0) {
                        screenshots.forEach(url => {
                            if(url) screenshotHtml += `<a href="${sanitizeHTML(url)}" target="_blank"><img src="${sanitizeHTML(url)}" class="screenshot-thumb"></a>`;
                        });
                    } else {
                        screenshotHtml = '<small class="text-muted">None</small>';
                    }

                    tableHtml += `
                        <tr>
                            <td>${sanitizeHTML(user.displayName)}</td>
                            <td>${result.kills}</td>
                            <td>${result.rank}</td>
                            <td class="text-warning fw-bold">${formatCurrency(result.prize)}</td>
                            <td><div class="screenshot-container">${screenshotHtml}</div></td>
                        </tr>
                    `;
                });

                elements.reviewResultsTableBody.innerHTML = tableHtml;
                elements.confirmCreditWinningsBtn.disabled = false;
                elements.confirmCreditWinningsBtn.dataset.tournamentId = tournamentId;

            } catch (error) {
                console.error("Error loading review results:", error);
                elements.reviewResultsTableBody.innerHTML = `<tr><td colspan="5" class="text-center p-3 text-danger">Error: ${error.message}</td></tr>`;
                showStatus(elements.reviewResultsStatus, `Error loading results: ${error.message}`, 'danger');
            }
        }

        // FEATURE 1: New function to credit winnings after review
        async function creditReviewedWinnings(tournamentId) {
            const selectedOption = elements.tmsTournamentSelect.options[elements.tmsTournamentSelect.selectedIndex];
            const tournamentName = selectedOption.dataset.name;

            if (!confirm(`Are you sure you want to credit these reviewed winnings for "${tournamentName}"? This cannot be undone.`)) {
                return;
            }

            showLoader(true);
            elements.confirmCreditWinningsBtn.disabled = true;
            clearStatus(elements.reviewResultsStatus);

            try {
                const resultsRef = ref(db, `tournaments/${tournamentId}/playerResults`);
                const resultsSnap = await get(resultsRef);

                if (!resultsSnap.exists()) {
                    throw new Error("Could not find submitted results to process.");
                }
                const resultsData = resultsSnap.val();
                
                const updates = {};
                let totalCredited = 0;
                let playersCredited = 0;
                
                const userIds = Object.keys(resultsData);
                const userPromises = userIds.map(uid => get(ref(db, `users/${uid}`)));
                const userSnapshots = await Promise.all(userPromises);
                
                const userDataMap = new Map();
                userSnapshots.forEach(snap => {
                    if (snap.exists()) {
                        userDataMap.set(snap.key, snap.val());
                    }
                });
                
                for (const uid of userIds) {
                    const result = resultsData[uid];
                    const user = userDataMap.get(uid);

                    if (!user) {
                        console.warn(`Skipping winnings for deleted user: ${uid}`);
                        continue;
                    }
                    
                    const newMatchHistoryKey = push(ref(db, `users/${uid}/matchHistory`)).key;
                    updates[`users/${uid}/matchHistory/${newMatchHistoryKey}`] = {
                        tournamentId: tournamentId,
                        tournamentName: tournamentName,
                        rank: result.rank,
                        kills: result.kills,
                        earnings: result.prize,
                        date: serverTimestamp()
                    };

                    updates[`users/${uid}/totalMatches`] = (user.totalMatches || 0) + 1;
                    updates[`users/${uid}/totalKills`] = (user.totalKills || 0) + result.kills;

                    if (result.rank === 1) {
                        updates[`users/${uid}/wonMatches`] = (user.wonMatches || 0) + 1;
                    }
                    
                    if (result.prize > 0) {
                        updates[`users/${uid}/winningCash`] = (user.winningCash || 0) + result.prize;
                        updates[`users/${uid}/totalEarnings`] = (user.totalEarnings || 0) + result.prize;
                        
                        const newTxKey = push(ref(db, `transactions/${uid}`)).key;
                        updates[`transactions/${uid}/${newTxKey}`] = {
                            type: 'tournament_winnings',
                            amount: result.prize,
                            description: `Winnings from ${tournamentName}`,
                            details: { kills: result.kills, rank: result.rank, prize: result.prize },
                            timestamp: serverTimestamp(),
                            tournamentId: tournamentId,
                            adminUid: currentAdminUser.uid
                        };
                        totalCredited += result.prize;
                        playersCredited++;
                    }
                }

                updates[`tournaments/${tournamentId}/winningsCredited`] = true;
                updates[`tournaments/${tournamentId}/status`] = 'result';
                updates[`tournaments/${tournamentId}/playerResults`] = null; // Clear submitted results
                updates[`tournaments/${tournamentId}/registeredPlayers`] = null; // Clear registered players

                await update(ref(db), updates);

                showStatus(elements.tmsStatus, `Successfully credited ${formatCurrency(totalCredited)} to ${playersCredited} players.`, "success");
                getModalInstance(elements.reviewResultsModalEl)?.hide();
                populateTournamentManagementSelector(); // Refresh the dropdown
                elements.tmsPlayerListContainer.style.display = 'none'; // Hide manual entry table
                elements.reviewResultsBtn.style.display = 'none';

            } catch (error) {
                console.error("Error crediting reviewed winnings:", error);
                showStatus(elements.reviewResultsStatus, `Error: ${error.message}`, 'danger', false);
            } finally {
                showLoader(false);
                elements.confirmCreditWinningsBtn.disabled = false;
            }
        }


        async function initializeAdminEventListeners() {
            console.log("Initializing Admin Event Listeners...");
            if (!auth || !db) { console.error("Cannot init listeners: Firebase not ready."); return; }

            const setupPasswordToggle = document.getElementById('toggleSetupPassword');
            const loginPasswordToggle = document.getElementById('toggleLoginPassword');

            setupPasswordToggle?.addEventListener('click', () => {
                const passwordInput = elements.setupPasswordInput;
                const icon = setupPasswordToggle.querySelector('i');
                if (passwordInput.type === "password") {
                    passwordInput.type = "text";
                    icon.classList.remove("bi-eye-slash");
                    icon.classList.add("bi-eye");
                } else {
                    passwordInput.type = "password";
                    icon.classList.remove("bi-eye");
                    icon.classList.add("bi-eye-slash");
                }
            });

            loginPasswordToggle?.addEventListener('click', () => {
                const passwordInput = elements.adminPasswordInput;
                const icon = loginPasswordToggle.querySelector('i');
                if (passwordInput.type === "password") {
                    passwordInput.type = "text";
                    icon.classList.remove("bi-eye-slash");
                    icon.classList.add("bi-eye");
                } else {
                    passwordInput.type = "password";
                    icon.classList.remove("bi-eye");
                    icon.classList.add("bi-eye-slash");
                }
            });

            elements.adminSetupForm?.addEventListener('submit', setupAdmin);
            elements.adminLoginForm?.addEventListener('submit', loginAdmin);
            elements.adminLogoutBtn?.addEventListener('click', logoutAdminUser);
            
            // --- New Sidebar Logic ---
            document.querySelector('.menu-toggle-btn').addEventListener('click', () => {
                elements.sidebar.classList.toggle('is-open');
            });
            document.getElementById('sidebarCloseBtn').addEventListener('click', () => {
                elements.sidebar.classList.remove('is-open');
            });
            
            elements.sidebarLinks?.forEach(link => { link.addEventListener('click', (e) => { e.preventDefault(); const sectionId = link.dataset.section; if (sectionId && !link.classList.contains('active')) { showAdminSection(sectionId); } else { elements.sidebar.classList.remove('is-open'); } }); });

            window.addEventListener('popstate', (event) => {
                if (event.state && event.state.sectionId) {
                    showAdminSection(event.state.sectionId, true);
                } else {
                    const hashSection = window.location.hash.substring(1);
                    if (getElement(hashSection)) {
                        showAdminSection(hashSection, true);
                    }
                }
            });

            elements.saveGameBtn?.addEventListener('click', saveGame);
            elements.savePromotionBtn?.addEventListener('click', savePromotion);
            elements.saveTournamentBtn?.addEventListener('click', saveTournament);
            elements.saveNewUserBtn?.addEventListener('click', saveNewUser);
            elements.appSettingsForm?.addEventListener('submit', saveSettings);
            elements.updateBalanceForm?.addEventListener('submit', updateUserBalance);
            elements.addNewGameBtn?.addEventListener('click', () => { elements.gameForm?.reset(); elements.gameEditId.value = ''; elements.gameModalTitle.textContent = "Add New Game"; clearStatus(elements.gameStatus); const imgbbEl = elements.gameForm?.querySelector('.imgbb-upload-status'); if(imgbbEl){ imgbbEl.textContent=''; imgbbEl.style.display='none';} });
            elements.addNewPromotionBtn?.addEventListener('click', () => { elements.promotionForm?.reset(); elements.promotionEditId.value = ''; elements.promotionModalTitle.textContent = "Add New Promotion"; clearStatus(elements.promotionStatus); const imgbbEl = elements.promotionForm?.querySelector('.imgbb-upload-status'); if(imgbbEl){ imgbbEl.textContent=''; imgbbEl.style.display='none';} });
            elements.addNewTournamentBtn?.addEventListener('click', () => { currentEditingTournamentId = null; elements.tournamentForm?.reset(); if(elements.tournamentModalTitle) elements.tournamentModalTitle.textContent = "Add New Tournament"; clearStatus(elements.addTournamentStatus); populateGameSelect(); });
            elements.userBlockBtn?.addEventListener('click', toggleUserBlock);
            elements.userDeleteBtn?.addEventListener('click', (e) => { const userId = e.target.closest('button')?.dataset.id; if (userId) deleteUser(userId); });

            getElement('withdrawalFilters')?.addEventListener('click', (e) => {
                const btn = e.target.closest('.filter-btn');
                if (btn && !btn.classList.contains('active')) {
                    getElement('withdrawalFilters').querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    loadWithdrawals(btn.dataset.status);
                }
            });
            elements.withdrawalCardContainer?.addEventListener('click', (e) => {
                const card = e.target.closest('.withdrawal-card');
                if (card) {
                    const allCards = elements.withdrawalCardContainer.querySelectorAll('.withdrawal-card');
                    allCards.forEach(c => c.classList.remove('selected'));
                    card.classList.add('selected');

                    const approveBtn = e.target.closest('.btn-approve-withdrawal');
                    const rejectBtn = e.target.closest('.btn-reject-withdrawal');
                    if(approveBtn) openWithdrawalActionModal(approveBtn.dataset.id, 'approve');
                    if(rejectBtn) openWithdrawalActionModal(rejectBtn.dataset.id, 'reject');
                }
            });

            elements.approveWithdrawalBtn?.addEventListener('click', processWithdrawalAction);
            elements.rejectWithdrawalBtn?.addEventListener('click', processWithdrawalAction);
            elements.userSearchInput?.addEventListener('input', filterUsers);

            elements.usersSectionContainer?.addEventListener('click', (event) => {
                const card = event.target.closest('.user-card');
                if (!card) return;
                if (event.target.closest('.user-card-footer')) {
                    return;
                }
                const allCards = elements.usersSectionContainer.querySelectorAll('.user-card');
                allCards.forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');
            });

            elements.promotionsGridContainer?.addEventListener('click', (event) => {
                const card = event.target.closest('.promotion-card');
                if (!card) return;

                if (event.target.closest('.promotion-card-footer')) {
                    return;
                }
                document.querySelectorAll('.promotion-card.selected').forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');
            });

            elements.globalNotificationForm?.addEventListener('submit', sendGlobalNotification);
            elements.individualNotificationForm?.addEventListener('submit', sendIndividualNotification);

            elements.pendingDepositsCardContainer?.addEventListener('click', (event) => {
                const card = event.target.closest('.deposit-card');
                if (!card) return;

                document.querySelectorAll('.deposit-card.selected').forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');

                const ds = card.dataset;
                if (event.target.closest('.btn-approve-deposit')) {
                    handleDepositAction(ds.id, ds.userid, parseFloat(ds.amount), 'complete');
                } else if (event.target.closest('.btn-reject-deposit')) {
                    handleDepositAction(ds.id, ds.userid, parseFloat(ds.amount), 'reject');
                } else if (event.target.closest('.btn-view-screenshot')) {
                    if (ds.screenshotUrl) {
                        elements.screenshotImage.src = ds.screenshotUrl;
                        getModalInstance(elements.viewScreenshotModalEl)?.show();
                    }
                }
            });

            elements.liveSupportUserListContainer?.addEventListener('click', (event) => {
                const target = event.target;
                const card = target.closest('.support-user-card');
                const closeButton = target.closest('.btn-close-conversation');

                if (closeButton) {
                    event.stopPropagation();
                    const userId = closeButton.dataset.uid;
                    if (userId) {
                        deleteSupportConversation(userId);
                    }
                } else if (card && card.dataset.uid) {
                    openLiveSupportChat(card.dataset.uid);
                }
            });

            elements.liveSupportChatBackButton?.addEventListener('click', () => {
                if(currentChattingUserId && dbListeners['liveChat']) {
                    off(ref(db, `liveSupportChats/${currentChattingUserId}`), 'value', dbListeners['liveChat']);
                    delete dbListeners['liveChat'];
                }
                currentChattingUserId = null;
                loadLiveSupportConversations();
            });
            elements.liveSupportChatForm?.addEventListener('submit', sendLiveSupportMessage);

            elements.tmsTournamentSelect?.addEventListener('change', (e) => loadPlayersForManagement(e.target.value));
            elements.tmsPlayerListTableBody?.addEventListener('input', (e) => { if (e.target.matches('.kills-input, .extra-amount-input, .rank-input')) { const row = e.target.closest('tr'); if(row) calculateRowPrize(row); } });
            elements.creditWinningsBtn?.addEventListener('click', creditAllWinnings);
            
            // FEATURE 1: Add event listeners for new result management flow
            elements.reviewResultsBtn?.addEventListener('click', () => {
                const tournamentId = elements.tmsTournamentSelect.value;
                if (tournamentId) openReviewResultsModal(tournamentId);
            });
            elements.confirmCreditWinningsBtn?.addEventListener('click', (e) => {
                const tournamentId = e.target.dataset.tournamentId;
                if (tournamentId) creditReviewedWinnings(tournamentId);
            });


            elements.pendingReferralsTableBody?.addEventListener('click', (e) => {
                if(e.target.matches('.btn-credit-referral') || e.target.closest('.btn-credit-referral')) {
                    const btn = e.target.closest('.btn-credit-referral');
                    const referralId = btn.dataset.id;
                    const referrerUid = btn.dataset.referrerUid;
                    creditReferralBonus(referralId, referrerUid);
                }
            });

            elements.saveLeaderboardBtn?.addEventListener('click', saveLeaderboardData);
            elements.autoRankLeaderboardBtn?.addEventListener('click', autoRankLeaderboardByWinnings);
            elements.leaderboardUserSearchInput?.addEventListener('input', filterLeaderboardMgtUsers);

            elements.saveThemeBtn?.addEventListener('click', saveThemeSettings);
            elements.resetThemeBtn?.addEventListener('click', resetThemeSettings);
            elements.presetBtnDefault?.addEventListener('click', () => applyPreset('default'));
            elements.presetBtnLight?.addEventListener('click', () => applyPreset('light'));
            elements.presetBtnGamingRed?.addEventListener('click', () => applyPreset('gamingRed'));
            elements.themeColorInputs.forEach(input => {
                input.addEventListener('input', () => {
                    const varName = input.dataset.themeVar;
                    document.documentElement.style.setProperty(`--${varName}`, input.value);
                });
            });
            
            // New Staff Event Listeners
            elements.saveNewStaffBtn?.addEventListener('click', saveNewStaff);
            elements.staffCardContainer?.addEventListener('click', (event) => {
                const deleteBtn = event.target.closest('.btn-delete-staff');
                if(deleteBtn) {
                    deleteStaff(deleteBtn.dataset.id);
                }
            });
            elements.staffCardContainer?.addEventListener('change', (event) => {
                const switchInput = event.target.closest('.staff-status-switch');
                if(switchInput) {
                    const staffId = switchInput.dataset.id;
                    const newStatus = switchInput.checked ? 'active' : 'deactivated';
                    toggleStaffStatus(staffId, newStatus);
                }
            });


            // New Promo Code Event Listeners
            elements.promoCodeForm?.addEventListener('submit', publishPromoCode);
            elements.generateRandomCodeBtn?.addEventListener('click', () => {
                elements.promoCodeInput.value = generateRandomCode();
            });
            elements.promoCodeInput?.addEventListener('input', (e) => {
                e.target.value = e.target.value.toUpperCase();
            });
            document.body.addEventListener('click', async (event) => {
                // Toggle active status
                const toggleBtn = event.target.closest('.btn-toggle-active');
                if (toggleBtn) {
                    const codeId = toggleBtn.dataset.id;
                    const currentStatus = toggleBtn.dataset.currentStatus === 'true';
                    const newStatus = !currentStatus;
                    try {
                        toggleBtn.disabled = true;
                        await update(ref(db, `promoCodes/${codeId}`), { active: newStatus });
                        showStatus(elements.promoCodeStatus, `Code status updated to ${newStatus ? 'Active' : 'Inactive'}.`, 'success', 2000);
                    } catch (error) {
                        showStatus(elements.promoCodeStatus, `Error updating status: ${error.message}`, 'danger');
                        toggleBtn.disabled = false;
                    }
                }

                // Delete code
                const deleteBtn = event.target.closest('.btn-delete-code');
                if (deleteBtn) {
                    const codeId = deleteBtn.dataset.id;
                    const code = deleteBtn.dataset.code;
                    showConfirmationModal(
                        'Delete Promo Code',
                        `Are you sure you want to permanently delete the promo code "${code}"? This action cannot be undone.`,
                        async () => {
                            try {
                                showLoader(true);
                                await remove(ref(db, `promoCodes/${codeId}`));
                                showStatus(elements.promoCodeStatus, `Promo code "${code}" has been deleted.`, 'success');
                            } catch (error) {
                                console.error("Error deleting promo code:", error);
                                showStatus(elements.promoCodeStatus, `Error: ${error.message}`, 'danger', false);
                            } finally {
                                showLoader(false);
                            }
                        }
                    );
                }
            });


            document.body.addEventListener('click', (event) => {
                 const target = event.target; const actionButton = target.closest('button[data-id]'); const copyIcon = target.closest('.copy-btn[data-target]');
                 if (actionButton) {
                     const targetId = actionButton.dataset.id; if (!targetId) return;
                     if (actionButton.classList.contains('btn-delete-game')) deleteGame(targetId);
                     else if (actionButton.classList.contains('btn-edit-game')) openEditGameModal(targetId);
                     else if (actionButton.classList.contains('btn-delete-promo')) deletePromotion(targetId);
                     else if (actionButton.classList.contains('btn-edit-promo')) openEditPromotionModal(targetId);
                     else if (actionButton.classList.contains('btn-delete-tournament')) deleteTournament(targetId);
                     else if (actionButton.classList.contains('btn-edit-tournament')) openEditTournamentModal(targetId);
                     else if (actionButton.classList.contains('btn-view-user')) openUserModal(targetId);
                     else if (actionButton.classList.contains('btn-delete-user')) deleteUser(targetId);
                     else if (actionButton.classList.contains('btn-view-registered')) openRegisteredPlayersModal(targetId, actionButton.dataset.name);
                     return;
                 }
                 if (copyIcon) { copyToClipboard(copyIcon.dataset.target); return; }
            });

            elements.confirmActionBtn.addEventListener('click', () => {
                if (typeof confirmActionCallback === 'function') {
                    confirmActionCallback();
                }
                getModalInstance(elements.confirmationModalEl)?.hide();
            });
            
            elements.downloadPlayersPdfBtn?.addEventListener('click', downloadPlayersAsPDF);


            const resetModal = (modalEl, formEl, statusEl, idField = null, titleEl = null, defaultTitle = 'Add New Item', imgbbSel = '.imgbb-upload-status') => { modalEl?.addEventListener('hidden.bs.modal', () => { formEl?.reset(); if(statusEl) clearStatus(statusEl); const imgbbStat = formEl?.querySelector(imgbbSel); if(imgbbStat) { imgbbStat.textContent=''; imgbbStat.style.display='none'; } if (idField) idField.value = ''; if (titleEl) titleEl.textContent = defaultTitle; if (modalEl === elements.addTournamentModalEl) currentEditingTournamentId = null; if (modalEl === elements.userModalEl) { elements.editUserUid.value = ''; elements.individualNotificationForm.reset(); clearStatus(elements.individualNotificationStatus); } if (modalEl === elements.withdrawalActionModalEl) currentWithdrawalAction = { id: null, type: null, userId: null }; currentEditingItemId = null; if (modalEl === elements.confirmationModalEl) confirmActionCallback = null; }); };
             resetModal(elements.gameModalEl, elements.gameForm, elements.gameStatus, elements.gameEditId, elements.gameModalTitle, 'Add New Game');
             resetModal(elements.promotionModalEl, elements.promotionForm, elements.promotionStatus, elements.promotionEditId, elements.promotionModalTitle, 'Add New Promotion');
             resetModal(elements.addTournamentModalEl, elements.tournamentForm, elements.addTournamentStatus, elements.tournamentEditId, elements.tournamentModalTitle, 'Add New Tournament', null);
             resetModal(elements.addUserModalEl, elements.addUserForm, elements.addUserStatus, null, null, '', null);
             resetModal(elements.addStaffModalEl, elements.addStaffForm, elements.addStaffStatus, null, null, '', null);
             resetModal(elements.userModalEl, elements.updateBalanceForm, elements.balanceUpdateStatus, elements.editUserUid, null, '', null);
             resetModal(elements.withdrawalActionModalEl, null, elements.withdrawalActionStatus, null, null, '', null);
             resetModal(elements.registeredPlayersModalEl, null, elements.registeredPlayersStatus, null, null, '', null);
             resetModal(elements.confirmationModalEl, null, null);
             // FEATURE 1: Reset review results modal
             resetModal(elements.reviewResultsModalEl, null, elements.reviewResultsStatus, null, null, '', null);
             console.log("Admin Event Listeners Initialized.");
        }

        function filterUsers() {
            const searchTerm = elements.userSearchInput.value.toLowerCase().trim();
            const allUserCards = elements.usersSectionContainer.querySelectorAll('.user-card');

            allUserCards.forEach(card => {
                const name = card.dataset.name || '';
                const email = card.dataset.email || '';

                if (name.includes(searchTerm) || email.includes(searchTerm)) {
                    card.style.display = '';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            console.log("Admin Panel DOM Loaded.");
            if (!app || !auth || !db) { console.error("DOM loaded, but Firebase services not initialized. Check config object."); return; }
            initializeAdminEventListeners();
            onAuthStateChanged(auth, handleAdminAuthStateChange);
        });
    </script>

</body>
</html>